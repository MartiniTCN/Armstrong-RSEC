<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è§£å†³æ–¹æ¡ˆæ¢ç´¢ä¸è€ƒè¯•ç³»ç»Ÿ</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
          },
          borderRadius: {
            DEFAULT: '1rem',
          },
        }
      }
    }
  </script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- å¼•å…¥ Twemoji åº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/twemoji.min.js"></script>
  <style>
    #cnFlag, #ukFlag {
        font-size: 30px;
        vertical-align: middle;
    }
    .shake {
      animation: shake 0.4s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }
    .animate-fade-in {
      opacity: 0;
      animation: fadeIn 1s ease-out forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    .watermark-tile {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0; pointer-events: none;
      overflow: hidden;
    }
    .watermark-instance {
      position: absolute;
      width: 180px; height: 180px;
      background-image: url('https://i.stardots.io/armstrong/%E6%B0%B4%E5%8D%B0%E5%9B%BE%E7%89%87%20-%20%E9%87%91%E8%89%B2_%E5%89%AF%E6%9C%AC.png?width=500');
      background-repeat: no-repeat;
      background-size: contain;
      opacity: 0.3; transform: rotate(-30deg);
    }
  </style>


<style>
  #registerMessage {
    transition: opacity 0.6s ease, transform 0.3s ease;
    transform: translateY(0);
  }

  #registerMessage.hidden {
    opacity: 0;
    transform: translateY(-10px);
  }
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);  /* æ·»åŠ é˜´å½±è®©æç¤ºæ›´æœ‰ç«‹ä½“æ„Ÿ */
</style>

</head>
<body class="relative text-gray-900 dark:text-gray-100 transition-colors duration-300"
      style="background-image: url('https://i.stardots.io/armstrong/webpage.jpg'); background-size: cover; background-position: center;">
  <div class="absolute inset-0 bg-white/20 dark:bg-black/30 backdrop-blur-[2px] z-0"></div>
<!-- é¡µé¢åŠ è½½é®ç½© -->
<div id="loadingOverlay" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex flex-col items-center justify-center">
  <img src="https://i.stardots.io/armstrong/Armstrong%20Logo%20-%20Martin.png?width=200" alt="Loading..." class="animate-spin-slow w-12 h-12 mb-4">
  <p class="text-gray-700 dark:text-gray-200 text-sm">æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...</p>
</div>
<!-- æ°´å°å®¹å™¨ 
<div class="watermark-tile" id="watermarkContainer"></div>
-->
<!-- ç™»å½• / æ³¨å†Œ è¡¨å•å¡ç‰‡ -->
<main class="min-h-screen flex items-center justify-center p-4 relative z-10">
  <section
  id="loginCard"
  class="w-full max-w-md bg-white/30 dark:bg-white/10 backdrop-blur-xl border border-white/30 dark:border-white/10 
         rounded-2xl shadow-xl hover:shadow-2xl hover:ring-2 hover:ring-blue-400/40 
         transition-all duration-300 ease-in-out transform hover:scale-[1.02] hover:-translate-y-1 
         pt-5 pb-3 px-6 sm:pt-5 sm:pb-3 sm:px-7"
>
  <!-- Logo ä¸æ ‡é¢˜ -->
  <div class="text-center mb-4 animate-fade-in">
    <img alt="Armstrong Logo" class="h-12 mx-auto mb-3" src="https://i.stardots.io/armstrong/Armstrong%20Logo%20-%20Martin.png?width=500"/>
    <h1 class="text-xl font-bold" id="titleText">äº§å“å­¦ä¹ ä¸è¯„æµ‹ç³»ç»Ÿ</h1>
    <p class="text-sm text-gray-500 dark:text-gray-200" id="subtitleText">æœ‰ç›®æ ‡åœ°å­¦ä¹  æœ‰æ´å¯Ÿåœ°è¯„ä¼°</p>
  </div>



  <!-- âœ… ç™»å½•è¡¨å• -->
<form method="post" action="/login" id="loginForm" class="space-y-5">
  <input type="text" name="username" placeholder="ç”¨æˆ·å" required
    class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
  
  <div class="relative">
    <input type="password" id="password" name="password" placeholder="å¯†ç " required
      class="w-full px-4 py-2 pr-10 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />

    <!-- ğŸ‘ï¸ åˆ‡æ¢æŒ‰é’® -->
    <button type="button" onclick="togglePassword()"
      class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-300 hover:text-blue-600 focus:outline-none">
      <i id="passwordIcon" class="fas fa-eye-slash"></i>
    </button>
  </div>

  <!-- âœ… ç™»å½•å¤±è´¥é”™è¯¯æç¤º -->
  {% if error %}
    <div class="text-sm text-red-500 text-center font-semibold -mt-2">
      {{ error }}
    </div>
  {% endif %}

  <!-- âœ… ç™»å½•+æ³¨å†ŒæŒ‰é’®ç»„ -->
  <div class="flex flex-col items-center mt-4 mb-4">
    <div class="flex justify-center gap-4">
      <!-- ç™»å½•æŒ‰é’® -->
      <button type="submit" id="loginBtn"
        class="px-4 py-1 text-xs text-white rounded-full bg-primary hover:bg-blue-700 transition">
        <span id="loginBtnText">ç™»å½•</span>
      </button>

      <!-- æ³¨å†ŒæŒ‰é’® -->
      <button type="button" onclick="toggleForm('register')"
        class="px-4 py-1 text-xs rounded-full bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-400 dark:hover:bg-gray-600 transition">
        <span id="registerBtnText">æ³¨å†Œ</span>
      </button>
    </div>
  </div>
</form>
  <!-- âœ… ğŸ‡¨ğŸ‡³è¯­è¨€æŒ‰é’® åœ†å½¢è¯­è¨€æŒ‰é’®è´´è¿‘å³ä¸‹è§’ -->
  <button type="button" onclick="toggleLang()"
  class="absolute bottom-3 right-4 w-4 h-4 rounded-full overflow-hidden shadow hover:scale-110 transition-transform z-20">
  <img id="languageFlag" src="https://flagcdn.com/cn.svg" alt="Language"
    class="w-full h-full object-cover rounded-full">
  </button>

  <!-- âœ… æ³¨å†Œè¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
  <form method="post" action="/register" id="registerForm" class="space-y-3 hidden">
    <!-- è¿”å›æŒ‰é’®ï¼Œå·¦ä¸Šè§’ -->
    <div class="absolute top-3 left-4">
      <button type="Back2Login" onclick="toggleForm('login')" class="text-sm text-gray-600 dark:text-gray-300 hover:underline">
        <span id="backToLoginText">â† è¿”å›ç™»å½•</span>
      </button>
    </div>
  
      <input name="username" placeholder="ç”¨æˆ·åï¼ˆå­—æ¯+æ•°å­—ï¼‰" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
        <div class="relative">
          <input type="password" id="regPassword" name="password" placeholder="å¯†ç " required
            class="w-full px-4 py-2 pr-10 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
          <button type="button" onclick="togglePassword('regPassword', 'regPwdIcon')"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-300 hover:text-blue-600 focus:outline-none">
            <i id="regPwdIcon" class="fas fa-eye-slash"></i>
          </button>
        </div>
      <input name="company" placeholder="å•ä½åç§°" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
      <input name="city" placeholder="åŸå¸‚" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
      <input name="email" placeholder="é‚®ç®±" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
      <input name="phone" placeholder="ç”µè¯" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
      <input name="sales_name" placeholder="Armstrong é”€å”®å§“å" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
      <input name="invite_code" placeholder="é‚€è¯·ç ï¼ˆè¯·è”ç³» RSEC éƒ¨é—¨ï¼‰" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
  
    <!-- æ³¨å†ŒæŒ‰é’®ï¼Œå±…ä¸­ -->
    <div class="flex justify-center mt-4 mb-6">
        <button type="submit"
          class="px-5 py-1.5 text-xs text-white rounded-full bg-primary hover:bg-blue-700 transition">
        <span id="finalRegisterBtnText">æ³¨å†Œ</span>
      </button>
    </div>
  </form>

</section>
</main>

<!-- âœ… è‡ªåŠ¨ç”Ÿæˆæ°´å° -->
<script>
  const watermarkContainer = document.getElementById('watermarkContainer');
  for (let i = 0; i < 50; i++) {
    const wm = document.createElement('div');
    wm.className = 'watermark-instance';
    wm.style.top = Math.random() * window.innerHeight + 'px';
    wm.style.left = Math.random() * window.innerWidth + 'px';
    watermarkContainer.appendChild(wm);
  }
</script>

<!-- âœ… ç™»å½• / æ³¨å†Œ åˆ‡æ¢é€»è¾‘ -->
<script>
  function toggleForm(type) {
    document.getElementById('loginForm').classList.toggle('hidden', type !== 'login');
    document.getElementById('registerForm').classList.toggle('hidden', type !== 'register');
    document.getElementById('loginTab').classList.toggle('text-blue-500', type === 'login');
    document.getElementById('loginTab').classList.toggle('text-gray-400', type !== 'login');
    document.getElementById('registerTab').classList.toggle('text-blue-500', type === 'register');
    document.getElementById('registerTab').classList.toggle('text-gray-400', type !== 'register');
  }
</script>

<!-- âœ… ä¸­è‹±æ–‡åˆ‡æ¢è„šæœ¬ -->
<script>
  let isChinese = true;

  function toggleLang() {
    isChinese = !isChinese;

    // æ›´æ–°æ ‡é¢˜ä¸å‰¯æ ‡é¢˜
    document.getElementById('titleText').textContent = isChinese ? 'äº§å“å­¦ä¹ ä¸è¯„æµ‹ç³»ç»Ÿ' : 'Learning & Evaluation System';
    document.getElementById('subtitleText').textContent = isChinese ? 'æœ‰ç›®æ ‡åœ°å­¦ä¹  æœ‰æ´å¯Ÿåœ°è¯„ä¼°' : 'Learn with purpose. Evaluate with insight.';

    // ç™»å½•è¡¨å•å ä½ç¬¦
    document.querySelector('#loginForm input[name="username"]').placeholder = isChinese ? 'ç”¨æˆ·å' : 'Username';
    document.querySelector('#loginForm input[name="password"]').placeholder = isChinese ? 'å¯†ç ' : 'Password';

    // æ³¨å†Œè¡¨å•å ä½ç¬¦
    document.querySelector('#registerForm input[name="username"]').placeholder = isChinese ? 'ç”¨æˆ·åï¼ˆå­—æ¯+æ•°å­—ï¼‰' : 'Username (letters + digits)';
    document.querySelector('#registerForm input[name="password"]').placeholder = isChinese ? 'å¯†ç ' : 'Password';
    document.querySelector('#registerForm input[name="company"]').placeholder = isChinese ? 'å•ä½åç§°' : 'Company';
    document.querySelector('#registerForm input[name="city"]').placeholder = isChinese ? 'åŸå¸‚' : 'City';
    document.querySelector('#registerForm input[name="email"]').placeholder = isChinese ? 'é‚®ç®±' : 'Email';
    document.querySelector('#registerForm input[name="phone"]').placeholder = isChinese ? 'ç”µè¯' : 'Phone';
    document.querySelector('#registerForm input[name="sales_name"]').placeholder = isChinese ? 'Armstrong é”€å”®å§“å' : 'Armstrong Sales Name';
    document.querySelector('#registerForm input[name="invite_code"]').placeholder = isChinese ? 'é‚€è¯·ç ï¼ˆè¯·è”ç³» RSEC éƒ¨é—¨ï¼‰' : 'Invite code (Contact China RSEC)';
    document.querySelector('#registerForm button[type="submit"]').textContent = isChinese ? 'æ³¨å†Œ' : 'Register';
    document.querySelector('#registerForm button[type="Back2Login"]').textContent = isChinese ? "â† è¿”å›ç™»å½•" : "â† Back";
    
    document.getElementById("loginBtnText").textContent = isChinese ? "ç™»å½•" : "Sign In";
    document.getElementById("registerBtnText").textContent = isChinese ? "æ³¨å†Œ" : "Sign Up";

    // æ›´æ–°è¯­è¨€å›¾æ ‡ï¼šåˆ‡æ¢è¯­è¨€æ—¶æ›´æ–°å›¾æ ‡
    const langFlag = document.getElementById("languageFlag");
    langFlag.src = isChinese ? 'https://flagcdn.com/cn.svg' : 'https://flagcdn.com/us.svg';

    // æ›´æ–°è¯­è¨€æŒ‰é’®æ–‡å­—ï¼ˆå¤‡ç”¨ï¼‰
    langFlag.onerror = function () {
        langFlag.textContent = isChinese ? 'ğŸ‡¨ğŸ‡³' : 'ğŸ‡¬ğŸ‡§';
    };

    // æ›´æ–°è¿”å›ç™»å½•æŒ‰é’®æ–‡æœ¬
    document.getElementById("backToLoginText").textContent = isChinese ? "â† è¿”å›ç™»å½•" : "â† Back";

    // ä¿å­˜è¯­è¨€è®¾ç½®åˆ° localStorage
    localStorage.setItem("isChinese", isChinese ? "1" : "0");
}

// âœ… é¡µé¢åŠ è½½æ—¶åŒæ­¥è¯­è¨€çŠ¶æ€
window.addEventListener('DOMContentLoaded', () => {
    const storedLang = localStorage.getItem("isChinese");
    isChinese = storedLang === null ? true : storedLang === "1";
    toggleLang(); // è°ƒç”¨åˆ‡æ¢å‡½æ•°
});
</script>

<!-- âœ… ç™»å½•å¤±è´¥è§¦å‘æŠ–åŠ¨ + æ¸…ç©ºå¯†ç  -->
<script>
  window.addEventListener('DOMContentLoaded', () => {
    {% if shake %}
      const card = document.getElementById('loginCard');
      const passwordInput = document.querySelector('#loginForm input[name="password"]');
      if (card) {
        card.classList.remove('shake'); // ç§»é™¤æ—§åŠ¨ç”»
        void card.offsetWidth;         // å¼ºåˆ¶åˆ·æ–°å›æµ
        card.classList.add('shake');   // æ·»åŠ æŠ–åŠ¨åŠ¨ç”»
      }
      if (passwordInput) passwordInput.value = ''; // æ¸…ç©ºå¯†ç 
    {% endif %}
  });
</script>

<!-- âœ… é¡µé¢åŠ è½½å®Œæˆåéšè—é®ç½© -->
<script>
  window.addEventListener('load', function () {
    document.getElementById('loadingOverlay').style.display = 'none';
  });
</script>

<script>
  function togglePassword(inputId = "password", iconId = "passwordIcon") {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(iconId);
    
    if (!input || !icon) return;

    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    } else {
      input.type = "password";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    }
  }
</script>

<!-- âœ… æ‹¦æˆªæ³¨å†Œè¡¨å•æäº¤å¹¶ä½¿ç”¨ AJAX å¼‚æ­¥æäº¤ -->
<script>
  document.getElementById('registerForm').addEventListener('submit', async function (e) {
  e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤è¡Œä¸º

  const formData = new FormData(this);
  const data = {};
  formData.forEach((value, key) => data[key] = value);

  const res = await fetch('/register', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  });

  const result = await res.json();
  const messageDiv = document.getElementById('registerMessage');

  if (result.success) {
    messageDiv.textContent = "âœ… æ³¨å†ŒæˆåŠŸï¼Œè¯·è¿”å›ç™»å½•";
    messageDiv.className = "text-green-500 text-sm text-center font-semibold mt-2 bg-white/30 dark:bg-gray-700 border border-green-500 rounded-xl px-4 py-2 backdrop-blur";
    
    messageDiv.classList.remove("hidden");
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

    setTimeout(() => {
      messageDiv.classList.add("hidden");
      toggleForm('login'); // è·³å›ç™»å½•
    }, 2500);

  } else {
    messageDiv.textContent = "âŒ " + result.message;
    messageDiv.className = "text-red-500 text-sm text-center font-semibold mt-2 bg-white/30 dark:bg-gray-700 border border-red-500 rounded-xl px-4 py-2 backdrop-blur";
    
    messageDiv.classList.remove("hidden");
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

    setTimeout(() => {
      messageDiv.classList.add("hidden");
    }, 3000);
  }
});
  </script>

<script>
  // âœ… æ‹¦æˆªè¡¨å•æäº¤å¹¶é€šè¿‡ JS å‘èµ·å¼‚æ­¥è¯·æ±‚
  document.getElementById('loginForm').addEventListener('submit', async function (event) {
    event.preventDefault();  // é˜»æ­¢é»˜è®¤æäº¤è¡Œä¸º

    const formData = new FormData(this);  // æ”¶é›†è¡¨å•æ•°æ®

    try {
      const response = await fetch('/login', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (response.ok && data.success) {
        // âœ… ç™»å½•æˆåŠŸï¼šè·³è½¬åˆ°è¯¾ç¨‹é¡µ
        window.location.href = "/course";
      } else {
        // âŒ ç™»å½•å¤±è´¥ï¼šå¼¹å‡ºæç¤ºæ¡†
        alert((data.message || "ç”¨æˆ·åæˆ–å¯†ç æ— æ•ˆï¼Œè¯·ç¡®è®¤ï¼").replace(/\\n/g, "\n"));
      }
    } catch (error) {
      console.error("ç™»å½•å¼‚å¸¸ï¼š", error);
      alert("ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•");
    }
  });
</script>

</body>
</html>
