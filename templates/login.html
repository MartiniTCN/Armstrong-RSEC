<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth dark">
<head>
  <link rel="icon" href="https://i.stardots.io/armstrong/Armstrong%20Logo%20-%20Martin.png?width=64" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>解决方案探索与考试系统</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
          },
          borderRadius: {
            DEFAULT: '1rem',
          },
        }
      }
    }
  </script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- 引入 Twemoji 库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/twemoji.min.js"></script>

  <style>
    .input-box {
      @apply w-full px-4 py-2 rounded-md bg-white/30 dark:bg-white/10 
             backdrop-blur-md border border-white/10 
             text-white placeholder-white/60 focus:outline-none 
             focus:ring-0 transition;
    }
    
    .input-box:focus {
      @apply bg-white/40 dark:bg-white/20; /* 聚焦时背景颜色稍微加深 */
    }
  </style>
  
  <style>
    #cnFlag, #ukFlag {
        font-size: 30px;
        vertical-align: middle;
    }
    .shake {
      animation: shake 0.4s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }
    .animate-fade-in {
      opacity: 0;
      animation: fadeIn 1s ease-out forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
  </style>


<style>
  #registerMessage {
    transition: opacity 0.6s ease, transform 0.3s ease;
    transform: translateY(0);
  }

  #registerMessage.hidden {
    opacity: 0;
    transform: translateY(-10px);
  }
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);  /* 添加阴影让提示更有立体感 */
</style>

<!-- ✅ 模态框样式 -->
<style>
  #modal {
    display: flex;
    justify-content: center;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
  }

  #modal .bg-white {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    width: 100%;
    max-width: 400px;
    text-align: center;
  }
</style>

</head>
<body class="relative text-gray-900 dark:text-gray-100 transition-colors duration-300"
      style="background-image: url('https://i.stardots.io/armstrong/webpage.jpg'); background-size: cover; background-position: center;">
  <div class="absolute inset-0 bg-white/20 dark:bg-black/30 backdrop-blur-[2px] z-0"></div>
<!-- 页面加载遮罩 -->
<div id="loadingOverlay" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex flex-col items-center justify-center">
  <img src="https://i.stardots.io/armstrong/Armstrong%20Logo%20-%20Martin.png?width=200" alt="Loading..." class="animate-spin-slow w-12 h-12 mb-4">
  <p class="text-gray-700 dark:text-gray-200 text-sm">正在加载，请稍候...</p>
</div>
<!-- 水印容器 
<div class="watermark-tile" id="watermarkContainer"></div>
-->
<!-- 登录 / 注册 表单卡片 -->
<main class="min-h-screen flex items-center justify-center p-4 relative z-10">
  <section
  id="loginCard"
  class="w-full max-w-md bg-white/30 dark:bg-white/10 backdrop-blur-xl border border-white/30 dark:border-white/10 
        rounded-2xl shadow-xl transition-all duration-300 ease-in-out transform
        pt-5 pb-3 px-6 sm:pt-5 sm:pb-3 sm:px-7"
>
  <!-- Logo 与标题 -->
  <div class="text-center mb-4 animate-fade-in">
    <img alt="Armstrong Logo" class="h-12 mx-auto mb-3" src="https://i.stardots.io/armstrong/Armstrong%20Logo%20-%20Martin.png?width=500"/>
    <h1 class="text-xl font-bold" id="titleText">产品学习与评测系统</h1>
    <p class="text-sm text-gray-500 dark:text-gray-200" id="subtitleText">有目标地学习 有洞察地评估</p>
  </div>



  <!-- ✅ 登录表单 -->
<form method="post" action="/login" id="loginForm" class="space-y-5">
  <!-- 登录进度提示 -->
  <div id="loginProgress" class="hidden text-center text-gray-500 dark:text-gray-300">
    正在验证，请稍候...
  </div>

  <input type="text" name="username" placeholder="用户名" required
  class="w-full px-4 py-2 rounded-md bg-white/10 dark:bg-gray-800/30 backdrop-blur-md
         border border-white/10 text-white placeholder-white/60 focus:outline-none transition
         focus:outline-none focus:ring-0" 
         />
  
  <div class="relative">
    <input type="password" id="password" name="password" placeholder="密码" required
        class="w-full px-4 py-2 pr-10 rounded-md bg-white/10 dark:bg-gray-800/30 backdrop-blur-md
              border border-white/10 text-white placeholder-white/60 focus:outline-none transition
              focus:outline-none focus:ring-0" 
              />
        <button type="button" onclick="togglePassword()"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-white/80 hover:text-white focus:outline-none">
            <i id="passwordIcon" class="fas fa-eye-slash"></i>
          </button>
    </div>      

  <!-- ✅ 登录失败错误提示 -->
  {% if error %}
    <div class="text-sm text-red-500 text-center font-semibold -mt-2">
      {{ error }}
    </div>
  {% endif %}

  <!-- ✅ 登录+注册按钮组 -->
  <div class="flex flex-col items-center mt-4 mb-4">
    <div class="flex justify-center gap-4">
      <!-- 登录按钮 -->
      <button type="submit" id="loginBtn"
        class="px-4 py-1 text-xs text-white rounded-full bg-primary hover:bg-blue-700 transition">
        <span id="loginBtnText">登录</span>
      </button>

      <!-- 注册按钮 -->
      <button type="button" onclick="toggleForm('register')"
        class="px-4 py-1 text-xs rounded-full bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-400 dark:hover:bg-gray-600 transition">
        <span id="registerBtnText">注册</span>
      </button>
    </div>
  </div>
</form>
  <!-- ✅ 🇨🇳语言按钮 圆形语言按钮贴近右下角 -->
  <button type="button" onclick="toggleLang()"
  class="absolute bottom-3 right-4 w-4 h-4 rounded-full overflow-hidden shadow hover:scale-110 transition-transform z-20">
  <img id="languageFlag" src="https://flagcdn.com/cn.svg" alt="Language"
    class="w-full h-full object-cover rounded-full">
  </button>

  <!-- ✅ 注册表单（默认隐藏） -->
  <form method="post" action="/register" id="registerForm" class="space-y-3 hidden">
    <!-- 返回按钮，左上角 -->
    <div class="absolute top-3 left-4">
      <button type="Back2Login" onclick="toggleForm('login')" class="text-sm text-gray-600 dark:text-gray-300 hover:underline">
        <span id="backToLoginText">← 返回登录</span>
      </button>
    </div>
  
      <input name="username" placeholder="用户名（字母+数字）" required
        class="w-full px-4 py-2 rounded-md bg-white/10 dark:bg-gray-800/30 backdrop-blur-md
              border border-white/10 text-white placeholder-white/60 focus:outline-none transition
              focus:outline-none focus:ring-0" 
              />
        <div class="relative">
      <input type="password" id="regPassword" name="password" placeholder="密码" required
        class="w-full px-4 py-2 rounded-md bg-white/10 dark:bg-gray-800/30 backdrop-blur-md
              border border-white/10 text-white placeholder-white/60 focus:outline-none transition
              focus:outline-none focus:ring-0" 
              />
          <button type="button" onclick="togglePassword('regPassword', 'regPwdIcon')"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-300 hover:text-blue-600 focus:outline-none">
            <i id="regPwdIcon" class="fas fa-eye-slash"></i>
          </button>
        </div>
      <input name="company" placeholder="单位名称" required
        class="w-full px-4 py-2 rounded-md bg-white/10 dark:bg-gray-800/30 backdrop-blur-md
              border border-white/10 text-white placeholder-white/60 focus:outline-none transition
              focus:outline-none focus:ring-0" 
              />
      <input name="city" placeholder="城市" required
        class="w-full px-4 py-2 rounded-md bg-white/10 dark:bg-gray-800/30 backdrop-blur-md
              border border-white/10 text-white placeholder-white/60 focus:outline-none transition
              focus:outline-none focus:ring-0" 
              />
      <input name="email" placeholder="邮箱" required
        class="w-full px-4 py-2 rounded-md bg-white/10 dark:bg-gray-800/30 backdrop-blur-md
              border border-white/10 text-white placeholder-white/60 focus:outline-none transition
              focus:outline-none focus:ring-0" 
              />
      <input name="phone" placeholder="电话" required
        class="w-full px-4 py-2 rounded-md bg-white/10 dark:bg-gray-800/30 backdrop-blur-md
              border border-white/10 text-white placeholder-white/60 focus:outline-none transition
              focus:outline-none focus:ring-0" 
              />
      <input name="sales_name" placeholder="Armstrong 销售姓名" required
        class="w-full px-4 py-2 rounded-md bg-white/10 dark:bg-gray-800/30 backdrop-blur-md
              border border-white/10 text-white placeholder-white/60 focus:outline-none transition
              focus:outline-none focus:ring-0" 
              />
      <input name="invite_code" placeholder="邀请码（请联系 RSEC 部门）" required
        class="w-full px-4 py-2 rounded-md bg-white/10 dark:bg-gray-800/30 backdrop-blur-md
              border border-white/10 text-white placeholder-white/60 focus:outline-none transition
              focus:outline-none focus:ring-0" 
              />  
  
    <!-- 注册按钮，居中 -->
    <div class="flex justify-center mt-4 mb-6">
        <button type="submit" onclick="userTriggeredRegister = true"
          class="px-5 py-1.5 text-xs text-white rounded-full bg-primary hover:bg-blue-700 transition">
        <span id="finalRegisterBtnText">注册</span>
      </button>
    </div>

    <!-- 在注册表单下方添加用于显示成功或失败消息的 div -->
    <div id="registerMessage" class="hidden text-center font-semibold"></div>

  </form>

</section>
</main>


<!-- ✅ 登录 / 注册 切换逻辑 -->
<script>
  // ✅ 切换表单（登录与注册）
  function toggleForm(type) {
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');

  if (!loginForm || !registerForm) {
    console.error("Missing loginForm or registerForm in toggleForm.");
    return;
  }

  // 显示或隐藏表单
  loginForm.classList.toggle('hidden', type !== 'login');
  registerForm.classList.toggle('hidden', type !== 'register');

  console.log('Toggle Form:', type);
}

  // ✅ 页面加载时根据 URL 参数决定初始表单
  window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const formType = urlParams.get('form') || 'login'; // 默认显示登录表单

    if (formType === 'register') {
      toggleForm('register');
    } else {
      toggleForm('login');
    }
  });
</script>

<!-- ✅ 中英文切换脚本 -->
<script>
  let isChinese = true; // 默认语言为中文

  // ✅ 设置语言（而不是切换语言）
  function setLang(lang) {
    isChinese = lang;

    // 更新标题与副标题
    const titleText = document.getElementById('titleText');
    const subtitleText = document.getElementById('subtitleText');
    if (titleText && subtitleText) {
      titleText.textContent = isChinese ? '产品学习与评测系统' : 'Learning & Evaluation System';
      subtitleText.textContent = isChinese ? '有目标地学习 有洞察地评估' : 'Learn with purpose. Evaluate with insight.';
    }

    // 更新表单占位符
    const loginUsername = document.querySelector('#loginForm input[name="username"]');
    const loginPassword = document.querySelector('#loginForm input[name="password"]');
    const registerUsername = document.querySelector('#registerForm input[name="username"]');
    const registerPassword = document.querySelector('#registerForm input[name="password"]');
    const registerCompany = document.querySelector('#registerForm input[name="company"]');
    const registerCity = document.querySelector('#registerForm input[name="city"]');
    const registerEmail = document.querySelector('#registerForm input[name="email"]');
    const registerPhone = document.querySelector('#registerForm input[name="phone"]');
    const registerSalesName = document.querySelector('#registerForm input[name="sales_name"]');
    const registerInviteCode = document.querySelector('#registerForm input[name="invite_code"]');
    const registerSubmitBtn = document.querySelector('#registerForm button[type="submit"]');
    const backToLoginText = document.getElementById("backToLoginText");

    if (loginUsername && loginPassword) {
      loginUsername.placeholder = isChinese ? '用户名' : 'Username';
      loginPassword.placeholder = isChinese ? '密码' : 'Password';
    }

    if (
      registerUsername && registerPassword && registerCompany && registerCity &&
      registerEmail && registerPhone && registerSalesName && registerInviteCode &&
      registerSubmitBtn && backToLoginText
    ) {
      registerUsername.placeholder = isChinese ? '用户名（字母+数字）' : 'Username (letters + digits)';
      registerPassword.placeholder = isChinese ? '密码' : 'Password';
      registerCompany.placeholder = isChinese ? '单位名称' : 'Company';
      registerCity.placeholder = isChinese ? '城市' : 'City';
      registerEmail.placeholder = isChinese ? '邮箱' : 'Email';
      registerPhone.placeholder = isChinese ? '电话' : 'Phone';
      registerSalesName.placeholder = isChinese ? 'Armstrong 销售姓名' : 'Armstrong Sales Name';
      registerInviteCode.placeholder = isChinese ? '邀请码（请联系 RSEC 部门）' : 'Invite code (Contact China RSEC)';
      registerSubmitBtn.textContent = isChinese ? '注册' : 'Register';
      backToLoginText.textContent = isChinese ? "← 返回登录" : "← Back";
    }

    // 更新语言图标
    const langFlag = document.getElementById("languageFlag");
    if (langFlag) {
      langFlag.src = isChinese ? 'https://flagcdn.com/cn.svg' : 'https://flagcdn.com/us.svg';
      langFlag.alt = isChinese ? '中文' : 'English';
      langFlag.onerror = function () {
        langFlag.textContent = isChinese ? '🇨🇳' : '🇬🇧';
      };
    }

    // 登录/注册按钮
    const loginBtnText = document.getElementById("loginBtnText");
    const registerBtnText = document.getElementById("registerBtnText");
    if (loginBtnText) loginBtnText.textContent = isChinese ? "登录" : "Sign In";
    if (registerBtnText) registerBtnText.textContent = isChinese ? "注册" : "Sign Up";

    // 保存语言设置
    localStorage.setItem("isChinese", isChinese ? "1" : "0");
  }

  // ✅ 切换语言
  function toggleLang() {
    setLang(!isChinese);
  }

  // ✅ 页面加载时，从本地恢复语言状态
  window.addEventListener('DOMContentLoaded', () => {
    const storedLang = localStorage.getItem("isChinese");
    const initialLang = storedLang === null ? true : storedLang === "1";
    setLang(initialLang); // 不再是 toggleLang()
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // ✅ 1. 注册按钮点击事件（切换到注册表单）
    const registerBtn = document.getElementById('registerBtn');
    if (registerBtn) {
      registerBtn.addEventListener('click', function () {
        toggleForm('register');
      });
    }
  
    // ✅ 2. 登录失败时触发抖动动画并清空密码（来自后端模板变量）
    {% if shake %}
      const card = document.getElementById('loginCard');
      const passwordInput = document.querySelector('#loginForm input[name="password"]');
      if (card) {
        card.classList.remove('shake');
        void card.offsetWidth; // 强制刷新
        card.classList.add('shake');
      }
      if (passwordInput) passwordInput.value = '';
    {% endif %}
  
    // ✅ 3. 页面加载后隐藏遮罩
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.style.transition = 'opacity 0.5s';
      overlay.style.opacity = 0;
      setTimeout(() => overlay.style.display = 'none', 500);
    }
  
    // ✅ 4. 调试：确认按钮存在性
    const loginBtnText = document.getElementById("loginBtnText");
    const registerBtnText = document.getElementById("registerBtnText");
    if (loginBtnText) console.log("Login button text is available");
    if (registerBtnText) console.log("Register button text is available");
  });
  </script>

<script>
  function togglePassword(inputId = "password", iconId = "passwordIcon") {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(iconId);
    
    if (!input || !icon) return;

    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    } else {
      input.type = "password";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    }
  }
</script>

<!-- ✅ 拦截注册表单提交并使用 AJAX 异步提交 -->
<script>
  let userTriggeredRegister = false; // 仅用户点击注册按钮时为 true
  
  // ✅ 注册提交逻辑（防止非主动提交）
  document.getElementById('registerForm').addEventListener('submit', async function (e) {
    e.preventDefault();
  
    if (!userTriggeredRegister) return; // 🛑 阻止非点击触发
    userTriggeredRegister = false;      // ✅ 立刻重置标志
  
    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => data[key] = value);
  
    try {
      const res = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
  
      const result = await res.json();
  
      const toast = document.getElementById("toast");
      const toastMsg = document.getElementById("toastMessage");
      const confirmBtn = document.getElementById("toastConfirmBtn");
  
      if (result.success) {
        // ✅ 注册成功 - 显示 toast
        toastMsg.textContent = "✅ 注册成功，请确认";
        toast.classList.remove("hidden");
  
        // ✅ 用户点击确认后跳转回登录表单
        confirmBtn.onclick = () => {
          toast.classList.add("hidden");
          toggleForm('login');
  
          // 可选：重置提示内容（保险）
          toastMsg.textContent = "";
        };
      } else {
        // ❌ 注册失败 - 显示 toast 错误提示
        toastMsg.textContent = "❌ " + result.message;
        toast.classList.remove("hidden");
  
        // ✅ 用户点击确认后仅关闭提示
        confirmBtn.onclick = () => {
          toast.classList.add("hidden");
          toastMsg.textContent = "";
        };
      }
    } catch (err) {
      alert("⚠️ 系统异常，请稍后重试");
      console.error(err);
    }
  });
  </script>

<script>
  // ✅ 拦截表单提交并通过 JS 发起异步请求
  document.getElementById('loginForm').addEventListener('submit', async function(event) {
  event.preventDefault();  // 阻止默认提交行为

  // 显示验证提示框
  const validationAlert = document.getElementById('validationAlert');
  validationAlert.classList.remove('hidden'); // 显示弹窗

  const formData = new FormData(this);  // 收集表单数据

  try {
    const response = await fetch('/login', {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    if (response.ok && data.success) {
      // 登录成功，跳转到课程页
      window.location.href = "/course";
    } else {
      // 登录失败，保持提示框显示，并弹出错误信息
      alert(data.message || "用户名或密码无效，请确认！");
    }
  } catch (error) {
    console.error("登录异常：", error);
    alert("系统错误，请稍后重试");
  } finally {
    // 验证完成后隐藏提示框
    setTimeout(() => {
      validationAlert.classList.add('hidden'); // 隐藏验证弹框
    }, 3000);  // 3秒后自动隐藏
  }
});

  // ✅ 页面加载时隐藏验证提示框
  window.addEventListener('DOMContentLoaded', () => {
    const validationAlert = document.getElementById('validationAlert');
    if (validationAlert) {
      validationAlert.classList.add('hidden'); // 隐藏提示框
    }
  });
</script>


<!-- ✅ 顶部确认 Toast -->
<div id="toast" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50
            bg-white/80 dark:bg-gray-800/90 text-black dark:text-white text-sm px-5 py-3 
            rounded-xl shadow-xl backdrop-blur-md border border-gray-300 dark:border-white/10 
            flex items-center gap-4 max-w-[90%]">
  
  <!-- 提示文字 -->
  <span id="toastMessage" class="font-semibold">✅ 注册成功，请确认</span>
  
  <!-- 确认按钮 -->
  <button id="toastConfirmBtn" 
          class="ml-auto px-4 py-1 text-xs rounded-full bg-primary text-white hover:bg-blue-700 transition">
    确认
  </button>
</div>

<script>
  // ✅ 判断是否为本地开发环境
  const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";
  
  // ✅ 非本地环境则启用调试防护
  if (!isLocalhost) {
    // 禁用右键菜单
    document.addEventListener('contextmenu', event => event.preventDefault());
  
    // 禁用 F12、Ctrl+Shift+I / J / C、Ctrl+U 等组合键
    document.addEventListener('keydown', event => {
      if (
        event.key === 'F12' ||
        (event.ctrlKey && event.shiftKey && ['I', 'J', 'C'].includes(event.key.toUpperCase())) ||
        (event.ctrlKey && event.key.toUpperCase() === 'U')
      ) {
        event.preventDefault();
      }
    });
  }
  </script>

  <!-- 验证提示框 -->
<div id="validationAlert" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 text-white bg-blue-500 rounded-lg shadow-lg">
  正在验证，请稍候...
</div>

</body>

<script>
  // 页面加载后确保 modal 被隐藏（保险）
  window.addEventListener('DOMContentLoaded', () => {
    userTriggeredRegister = false; // ✅ 页面一加载就清空注册触发标志
    const modal = document.getElementById('modal');
    if (modal) modal.classList.add('hidden');
  });
  const msg = document.getElementById('registerMessage');
    if (msg) {
      msg.classList.add('hidden');
      msg.textContent = ''; // ✅ 彻底清空之前的“注册成功”文字
    }
</script>

</html>
