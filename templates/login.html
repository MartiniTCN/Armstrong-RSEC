<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>解决方案探索与考试系统</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
          },
          borderRadius: {
            DEFAULT: '1rem',
          },
        }
      }
    }
  </script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- 引入 Twemoji 库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/twemoji.min.js"></script>
  <style>
    #cnFlag, #ukFlag {
        font-size: 30px;
        vertical-align: middle;
    }
    .shake {
      animation: shake 0.4s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }
    .animate-fade-in {
      opacity: 0;
      animation: fadeIn 1s ease-out forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
  </style>


<style>
  #registerMessage {
    transition: opacity 0.6s ease, transform 0.3s ease;
    transform: translateY(0);
  }

  #registerMessage.hidden {
    opacity: 0;
    transform: translateY(-10px);
  }
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);  /* 添加阴影让提示更有立体感 */
</style>

</head>
<body class="relative text-gray-900 dark:text-gray-100 transition-colors duration-300"
      style="background-image: url('https://i.stardots.io/armstrong/webpage.jpg'); background-size: cover; background-position: center;">
  <div class="absolute inset-0 bg-white/20 dark:bg-black/30 backdrop-blur-[2px] z-0"></div>
<!-- 页面加载遮罩 -->
<div id="loadingOverlay" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex flex-col items-center justify-center">
  <img src="https://i.stardots.io/armstrong/Armstrong%20Logo%20-%20Martin.png?width=200" alt="Loading..." class="animate-spin-slow w-12 h-12 mb-4">
  <p class="text-gray-700 dark:text-gray-200 text-sm">正在加载，请稍候...</p>
</div>
<!-- 水印容器 
<div class="watermark-tile" id="watermarkContainer"></div>
-->
<!-- 登录 / 注册 表单卡片 -->
<main class="min-h-screen flex items-center justify-center p-4 relative z-10">
  <section
  id="loginCard"
  class="w-full max-w-md bg-white/30 dark:bg-white/10 backdrop-blur-xl border border-white/30 dark:border-white/10 
         rounded-2xl shadow-xl hover:shadow-2xl hover:ring-2 hover:ring-blue-400/40 
         transition-all duration-300 ease-in-out transform hover:scale-[1.02] hover:-translate-y-1 
         pt-5 pb-3 px-6 sm:pt-5 sm:pb-3 sm:px-7"
>
  <!-- Logo 与标题 -->
  <div class="text-center mb-4 animate-fade-in">
    <img alt="Armstrong Logo" class="h-12 mx-auto mb-3" src="https://i.stardots.io/armstrong/Armstrong%20Logo%20-%20Martin.png?width=500"/>
    <h1 class="text-xl font-bold" id="titleText">产品学习与评测系统</h1>
    <p class="text-sm text-gray-500 dark:text-gray-200" id="subtitleText">有目标地学习 有洞察地评估</p>
  </div>



  <!-- ✅ 登录表单 -->
<form method="post" action="/login" id="loginForm" class="space-y-5">
  <input type="text" name="username" placeholder="用户名" required
    class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
  
  <div class="relative">
    <input type="password" id="password" name="password" placeholder="密码" required
      class="w-full px-4 py-2 pr-10 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />

    <!-- 👁️ 切换按钮 -->
    <button type="button" onclick="togglePassword()"
      class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-300 hover:text-blue-600 focus:outline-none">
      <i id="passwordIcon" class="fas fa-eye-slash"></i>
    </button>
  </div>

  <!-- ✅ 登录失败错误提示 -->
  {% if error %}
    <div class="text-sm text-red-500 text-center font-semibold -mt-2">
      {{ error }}
    </div>
  {% endif %}

  <!-- ✅ 登录+注册按钮组 -->
  <div class="flex flex-col items-center mt-4 mb-4">
    <div class="flex justify-center gap-4">
      <!-- 登录按钮 -->
      <button type="submit" id="loginBtn"
        class="px-4 py-1 text-xs text-white rounded-full bg-primary hover:bg-blue-700 transition">
        <span id="loginBtnText">登录</span>
      </button>

      <!-- 注册按钮 -->
      <button type="button" onclick="toggleForm('register')"
        class="px-4 py-1 text-xs rounded-full bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-400 dark:hover:bg-gray-600 transition">
        <span id="registerBtnText">注册</span>
      </button>
    </div>
  </div>
</form>
  <!-- ✅ 🇨🇳语言按钮 圆形语言按钮贴近右下角 -->
  <button type="button" onclick="toggleLang()"
  class="absolute bottom-3 right-4 w-4 h-4 rounded-full overflow-hidden shadow hover:scale-110 transition-transform z-20">
  <img id="languageFlag" src="https://flagcdn.com/cn.svg" alt="Language"
    class="w-full h-full object-cover rounded-full">
  </button>

  <!-- ✅ 注册表单（默认隐藏） -->
  <form method="post" action="/register" id="registerForm" class="space-y-3 hidden">
    <!-- 返回按钮，左上角 -->
    <div class="absolute top-3 left-4">
      <button type="Back2Login" onclick="toggleForm('login')" class="text-sm text-gray-600 dark:text-gray-300 hover:underline">
        <span id="backToLoginText">← 返回登录</span>
      </button>
    </div>
  
      <input name="username" placeholder="用户名（字母+数字）" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
        <div class="relative">
          <input type="password" id="regPassword" name="password" placeholder="密码" required
            class="w-full px-4 py-2 pr-10 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
          <button type="button" onclick="togglePassword('regPassword', 'regPwdIcon')"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-300 hover:text-blue-600 focus:outline-none">
            <i id="regPwdIcon" class="fas fa-eye-slash"></i>
          </button>
        </div>
      <input name="company" placeholder="单位名称" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
      <input name="city" placeholder="城市" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
      <input name="email" placeholder="邮箱" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
      <input name="phone" placeholder="电话" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
      <input name="sales_name" placeholder="Armstrong 销售姓名" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
      <input name="invite_code" placeholder="邀请码（请联系 RSEC 部门）" required
        class="w-full px-4 py-2 rounded-md bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" />
  
    <!-- 注册按钮，居中 -->
    <div class="flex justify-center mt-4 mb-6">
        <button type="submit"
          class="px-5 py-1.5 text-xs text-white rounded-full bg-primary hover:bg-blue-700 transition">
        <span id="finalRegisterBtnText">注册</span>
      </button>
    </div>
  </form>

</section>
</main>


<!-- ✅ 登录 / 注册 切换逻辑 -->
<script>
  // ✅ 切换表单（登录与注册）
  function toggleForm(type) {
  // 获取元素并检查它们是否存在
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const loginTab = document.getElementById('loginTab');
  const registerTab = document.getElementById('registerTab');

  // 确保元素存在
  if (loginForm && registerForm && loginTab && registerTab) {
    // 切换表单显示和隐藏
    loginForm.classList.toggle('hidden', type !== 'login');
    registerForm.classList.toggle('hidden', type !== 'register');

    // 切换 Tab 样式
    loginTab.classList.toggle('text-blue-500', type === 'login');
    loginTab.classList.toggle('text-gray-400', type !== 'login');
    registerTab.classList.toggle('text-blue-500', type === 'register');
    registerTab.classList.toggle('text-gray-400', type !== 'register');
  } else {
    console.error("Missing elements for toggleForm.");
  }

  // 调试：打印表单切换类型
  console.log('Toggle Form:', type);
}
</script>

<!-- ✅ 中英文切换脚本 -->
<script>
  let isChinese = true;

  // ✅ 切换语言
  function toggleLang() {
  // 切换语言
  isChinese = !isChinese;

  // 更新标题与副标题
  const titleText = document.getElementById('titleText');
  const subtitleText = document.getElementById('subtitleText');
  
  if (titleText && subtitleText) {
    titleText.textContent = isChinese ? '产品学习与评测系统' : 'Learning & Evaluation System';
    subtitleText.textContent = isChinese ? '有目标地学习 有洞察地评估' : 'Learn with purpose. Evaluate with insight.';
  }

  // 更新表单占位符
  const loginUsername = document.querySelector('#loginForm input[name="username"]');
  const loginPassword = document.querySelector('#loginForm input[name="password"]');
  const registerUsername = document.querySelector('#registerForm input[name="username"]');
  const registerPassword = document.querySelector('#registerForm input[name="password"]');
  const registerCompany = document.querySelector('#registerForm input[name="company"]');
  const registerCity = document.querySelector('#registerForm input[name="city"]');
  const registerEmail = document.querySelector('#registerForm input[name="email"]');
  const registerPhone = document.querySelector('#registerForm input[name="phone"]');
  const registerSalesName = document.querySelector('#registerForm input[name="sales_name"]');
  const registerInviteCode = document.querySelector('#registerForm input[name="invite_code"]');
  const registerSubmitBtn = document.querySelector('#registerForm button[type="submit"]');
  const backToLoginText = document.getElementById("backToLoginText");

  if (loginUsername && loginPassword) {
    loginUsername.placeholder = isChinese ? '用户名' : 'Username';
    loginPassword.placeholder = isChinese ? '密码' : 'Password';
  }

  if (registerUsername && registerPassword && registerCompany && registerCity && registerEmail && registerPhone && registerSalesName && registerInviteCode && registerSubmitBtn && backToLoginText) {
    registerUsername.placeholder = isChinese ? '用户名（字母+数字）' : 'Username (letters + digits)';
    registerPassword.placeholder = isChinese ? '密码' : 'Password';
    registerCompany.placeholder = isChinese ? '单位名称' : 'Company';
    registerCity.placeholder = isChinese ? '城市' : 'City';
    registerEmail.placeholder = isChinese ? '邮箱' : 'Email';
    registerPhone.placeholder = isChinese ? '电话' : 'Phone';
    registerSalesName.placeholder = isChinese ? 'Armstrong 销售姓名' : 'Armstrong Sales Name';
    registerInviteCode.placeholder = isChinese ? '邀请码（请联系 RSEC 部门）' : 'Invite code (Contact China RSEC)';
    registerSubmitBtn.textContent = isChinese ? '注册' : 'Register';
    backToLoginText.textContent = isChinese ? "← 返回登录" : "← Back";
  }

  // 更新语言图标：切换语言时更新图标
  const langFlag = document.getElementById("languageFlag");
  if (langFlag) {
    langFlag.src = isChinese ? 'https://flagcdn.com/cn.svg' : 'https://flagcdn.com/us.svg';
    langFlag.alt = isChinese ? '中文' : 'English';
  }

  // 更新语言按钮文字（备用）
  if (langFlag && langFlag.onerror) {
    langFlag.onerror = function () {
      langFlag.textContent = isChinese ? '🇨🇳' : '🇬🇧';
    };
  }

  // 更新返回登录按钮文本
  const loginBtnText = document.getElementById("loginBtnText");
  const registerBtnText = document.getElementById("registerBtnText");
  if (loginBtnText && registerBtnText) {
    loginBtnText.textContent = isChinese ? "登录" : "Sign In";
    registerBtnText.textContent = isChinese ? "注册" : "Sign Up";
  }

  // 保存语言设置到 localStorage
  localStorage.setItem("isChinese", isChinese ? "1" : "0");
}

  // ✅ 页面加载时同步语言状态
  window.addEventListener('DOMContentLoaded', () => {
  const storedLang = localStorage.getItem("isChinese");
  isChinese = storedLang === null ? true : storedLang === "1";
  toggleLang(); // 初始化语言

  // 调试：确保元素加载后再访问
  const loginBtnText = document.getElementById("loginBtnText");
  const registerBtnText = document.getElementById("registerBtnText");

  if (loginBtnText) {
    console.log('Login button text is available');
  } else {
      console.error('Login button text element is missing');
    }

  if (registerBtnText) {
    console.log('Register button text is available');
  } else {
      console.error('Register button text element is missing');
    }
});
</script>

<!-- ✅ 登录失败触发抖动 + 清空密码 -->
<script>
  window.addEventListener('DOMContentLoaded', () => {
    {% if shake %}
      const card = document.getElementById('loginCard');
      const passwordInput = document.querySelector('#loginForm input[name="password"]');
      if (card) {
        card.classList.remove('shake'); // 移除旧动画
        void card.offsetWidth;         // 强制刷新回流
        card.classList.add('shake');   // 添加抖动动画
      }
      if (passwordInput) passwordInput.value = ''; // 清空密码
    {% endif %}
  });
</script>

<!-- ✅ 页面加载完成后隐藏遮罩 -->
<script>
  window.addEventListener('DOMContentLoaded', function () {
    const registerBtn = document.getElementById('registerBtn');
    if (registerBtn) {
      registerBtn.addEventListener('click', function() {
        toggleForm('register');  // 绑定点击事件，切换到注册表单
      });
    }
  });
</script>

<script>
  function togglePassword(inputId = "password", iconId = "passwordIcon") {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(iconId);
    
    if (!input || !icon) return;

    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    } else {
      input.type = "password";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    }
  }
</script>

<!-- ✅ 拦截注册表单提交并使用 AJAX 异步提交 -->
<script>
  document.getElementById('registerForm').addEventListener('submit', async function (e) {
  e.preventDefault(); // 阻止默认提交行为

  const formData = new FormData(this);
  const data = {};
  formData.forEach((value, key) => data[key] = value);

  const res = await fetch('/register', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  });

  const result = await res.json();
  const messageDiv = document.getElementById('registerMessage');

  if (result.success) {
    messageDiv.textContent = "✅ 注册成功，请返回登录";
    messageDiv.className = "text-green-500 text-sm text-center font-semibold mt-2 bg-white/30 dark:bg-gray-700 border border-green-500 rounded-xl px-4 py-2 backdrop-blur";
    
    messageDiv.classList.remove("hidden");
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

    setTimeout(() => {
      messageDiv.classList.add("hidden");
      toggleForm('login'); // 跳回登录
    }, 2500);

  } else {
    messageDiv.textContent = "❌ " + result.message;
    messageDiv.className = "text-red-500 text-sm text-center font-semibold mt-2 bg-white/30 dark:bg-gray-700 border border-red-500 rounded-xl px-4 py-2 backdrop-blur";
    
    messageDiv.classList.remove("hidden");
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

    setTimeout(() => {
      messageDiv.classList.add("hidden");
    }, 3000);
  }
});
  </script>

<script>
  // ✅ 拦截表单提交并通过 JS 发起异步请求
  document.getElementById('loginForm').addEventListener('submit', async function (event) {
    event.preventDefault();  // 阻止默认提交行为

    const formData = new FormData(this);  // 收集表单数据

    try {
      const response = await fetch('/login', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (response.ok && data.success) {
        // ✅ 登录成功：跳转到课程页
        window.location.href = "/course";
      } else {
        // ❌ 登录失败：弹出提示框
        alert((data.message || "用户名或密码无效，请确认！").replace(/\\n/g, "\n"));
      }
    } catch (error) {
      console.error("登录异常：", error);
      alert("系统错误，请稍后重试");
    }
  });
</script>

</body>
</html>
