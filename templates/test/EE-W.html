<!DOCTYPE html>
<html lang="zh-CN" class="">
  <!-- âœ… html2pdf.js CDNï¼šç”¨äºå°†é¡µé¢å¯¼å‡ºä¸º PDF -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EE-W äº§å“åŸ¹è®­æµ‹è¯•ç³»ç»Ÿ</title>
    

    <script>
      tailwind.config = {
        darkMode: 'class', // âœ… åœ¨è¿™é‡Œè®¾ç½®
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="/static/common/style.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- âœ… csv è§£æåº“ -->


	<!-- âœ… ğŸ†• ç«‹å³åŠ ä¸Šè¿™æ®µï¼Œå¼€å¯ dark æ¨¡å¼æ”¯æŒ -->



<style>
  /* âœ… é¿å…åˆ†é¡µæ—¶æ‹†è¡Œ */
  tr {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
  }

  /* âœ… å®Œæ•´å†…å®¹å±…ä¸­ï¼Œé˜²æ­¢è¾¹ç¼˜æº¢å‡º */
  #completePage {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
  }

  /* âœ… å°å±é€‚é…ï¼šç­”é¢˜é¡µå’Œè¡¨æ ¼å­—ä½“é€‚é… */
  @media screen and (max-width: 768px) {
    #completePage {
      font-size: 13px;
    }

    table {
      font-size: 12px;
    }

    td, th {
      padding: 6px 4px;
      word-break: break-word;
    }
  }

  /* âœ… å±…ä¸­æ˜¾ç¤ºå€’è®¡æ—¶æç¤º + æŒ‰é’® */
#countdownCenterOverlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(6px);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  color: #1f2937; /* text-gray-800 */
  font-size: 18px;
}

#countdownCenterOverlay button {
  margin-top: 1rem;
  padding: 0.5rem 1.5rem;
  border-radius: 9999px;
  background: #16a34a; /* bg-green-600 */
  color: white;
  font-weight: bold;
  border: none;
  cursor: pointer;
}

</style>

<!-- âœ… æ­£ç¡®å¼•å…¥ EmailJS çš„æµè§ˆå™¨ç‰ˆæœ¬ SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  // âœ… åˆå§‹åŒ– EmailJSï¼Œå¿…é¡»æ”¾åœ¨å¼•å…¥ä¹‹å
  (function() {
    emailjs.init("LoQCI3C98dk3FgEvj");
  })();
</script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='common/style.css') }}">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
	
        /* ä¿æŒåŸæœ‰æ‰€æœ‰æ ·å¼ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        .option-selected { background-color: rgba(59, 130, 246, 0.1); }
        .page { display: none; }
        .active-page { display: block; }
        .input-field-highlight {
            @apply w-full p-2 rounded-md border-2 border-blue-300 shadow-sm 
                   dark:border-blue-500 transition-colors focus:ring-2 
                   focus:ring-blue-500 focus:border-blue-500;
        }
        .question-card {
            @apply p-6 rounded-lg bg-gray-50 dark:bg-gray-700 
                   transition-colors hover:bg-gray-100 dark:hover:bg-gray-600
                   mb-6 border-2 border-transparent;
        }
        .options-grid {
            @apply grid grid-cols-1 md:grid-cols-2 gap-4;
        }
        .option {
            @apply flex items-center p-3 rounded-lg border-2 border-gray-200
                   dark:border-gray-600 cursor-pointer transition-all
                   hover:border-blue-500;
        }
        .option input {
            @apply mr-3;
        }
		.option span {
  color: #1f2937; /* light mode é»˜è®¤é¢œè‰² */
}

.dark .option span {
  color: #e5e7eb; /* dark mode å­—ä½“é¢œè‰² */
}
        .judge-card {
            @apply p-4 rounded-lg bg-gray-50 dark:bg-gray-700
                   border-2 border-transparent;
        }
        .judge-btn {
            @apply w-12 h-12 flex items-center justify-center rounded-full 
                   border-2 border-gray-300 dark:border-gray-600 
                   hover:border-blue-500 cursor-pointer transition-all;
        }
        .judge-btn i {
            @apply text-xl opacity-0 transition-opacity;
        }
        .judge-btn input:checked ~ i {
            @apply opacity-100;
        }
        .border-red-500 {
            border-color: rgb(239 68 68) !important;
        }
		
 /* âœ… åŠ å…¥å¼¹å‡ºæç¤ºåŠ¨ç”» */
    .fade-in-bounce {
      animation: fadeInBounce 0.5s ease-out;
    }
    @keyframes fadeInBounce {
      0% { opacity: 0; transform: translateY(-20px); }
      60% { transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
		
/* âœ… ç”¨äºåŠ¨æ€ç”Ÿæˆçš„æ‰“ä¹±æ°´å°å…ƒç´ æ ·å¼ */
.watermark-random {
  position: fixed;
  width: 220px;
  height: 220px;
  background-image: url('https://i.stardots.io/armstrong/æ°´å°å›¾ç‰‡ - é‡‘è‰²_å‰¯æœ¬.png?width=500&rotate=0&blur=0&quality=50');
  background-repeat: no-repeat;
  background-size: contain;
  background-position: center;
  opacity: 0.2;
  z-index: 0;
  pointer-events: none;
}

/* âœ… é¡µé¢æ¨¡ç³Šæ—¶ä½¿ç”¨çš„æ ·å¼ */
.blur-overlay {
  filter: blur(5px);
  pointer-events: none;
  user-select: none;
  transition: all 0.3s ease;
}

/* âœ… å€’è®¡æ—¶å’Œæš‚åœæŒ‰é’®å®¹å™¨æ ·å¼ */
#examStatusBar {
  position: fixed;
  top: 18px; /* ç¨å¾®ç¦»é¡¶éƒ¨è¿œä¸€ç‚¹ */
  left: 50%;
  transform: translateX(-50%);
  background-color: #dc2626; /* çº¢è‰²èƒŒæ™¯ */
  color: white;
  padding: 0.3rem 1rem; /* âœ… ä¸Šä¸‹æ›´çª„ï¼Œå·¦å³ä¿ç•™ */
  border-radius: 9999px; /* èƒ¶å›Šå½¢çŠ¶ */
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  font-size: 0.875rem; /* ç¨å°å­—ä½“ */
  font-weight: 600;
  z-index: 9999;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  height: auto;
  line-height: 1;
}

#examStatusBar button {
  background-color: white;
  color: #dc2626;
  font-weight: 600;
  padding: 0.2rem 0.75rem; /* âœ… æ›´å°æŒ‰é’®å°ºå¯¸ */
  border-radius: 9999px;
  font-size: 0.75rem;
  line-height: 1;
  transition: all 0.2s ease;
}

#examStatusBar button:hover {
  background-color: #fef2f2;
}

@media (max-width: 640px) {
  #examStatusBar {
    top: 50% !important;              /* å±…ä¸­å¯¹é½ */
    left: auto !important;
    right: 0.5rem !important;         /* é å³ */
    transform: translateY(-50%);      /* å‚ç›´å±…ä¸­ */
    flex-direction: column;           /* å‚ç›´æ’åˆ—ï¼šæ—¶é—´åœ¨ä¸Šï¼ŒæŒ‰é’®åœ¨ä¸‹ */
    padding: 0.5rem 0.8rem;
    font-size: 0.75rem;
    gap: 0.5rem;
    border-radius: 1rem;
    background-color: #dc2626;        /* çº¢è‰²èƒŒæ™¯ä¿ç•™ */
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 9999;
  }

  #examStatusBar button {
    padding: 0.3rem 0.75rem;
    font-size: 0.75rem;
  }

  #examStatusBar button span {
    display: inline;
  }
}
    </style>

</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
  
  <div class="page-container">
  <!-- âœ… åŠ¨æ€é¢˜ç›®å®¹å™¨ï¼ˆå¿…é¡»æœ‰è¿™ä¸ª IDï¼‰ -->
  <!-- <div id="testContainer" class="mt-6 space-y-6"></div> -->

    <!-- åŠ è½½é®ç½© -->
    <div id="loading" class="fixed inset-0 bg-black/50 z-50 hidden">
        <div class="flex items-center justify-center h-full">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg flex items-center">
                <i class="fas fa-spinner animate-spin text-2xl text-blue-500 mr-3"></i>
                <span class="text-gray-700 dark:text-gray-200">æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</span>
            </div>
        </div>
    </div>

  <!-- âœ… å¯¼èˆªæ   -->
  <nav id="mainNavbar"
  class="sticky top-2 mx-auto max-w-7xl bg-white/80 !dark:bg-[#2a2a2a] backdrop-blur border border-gray-200 dark:border-gray-700 z-40 rounded-2xl shadow-md">
  <div class="flex flex-col px-4 py-2 gap-1">

    <!-- âœ… é¡¶éƒ¨ä¸­é—´ï¼šLogo + æ ‡é¢˜ -->
    <div class="flex justify-center items-center gap-2">
      <!-- Logo ç¼©å° 50% -->
      <img
        src="https://i.stardots.io/armstrong/Armstrong%20Logo%20-%20Martin.png?width=500"
        alt="Logo"
        class="h-8 w-auto"
      />
      <!-- ç«–çº¿åˆ†éš” -->
      <span class="text-gray-400 text-base">ï½œ</span>
      <!-- æµ‹è¯•æ ‡é¢˜ -->
      <h1
        id="pageTitle"
        class="text-base font-semibold text-gray-800 dark:text-gray-200 tracking-wide"
      >
        EE-W äº§å“åŸ¹è®­æµ‹è¯•ç³»ç»Ÿ
      </h1>
    </div>

    <!-- âœ… åº•éƒ¨ï¼šå·¦ä¾§ç”¨æˆ·åï¼Œå³ä¾§åˆ‡æ¢æŒ‰é’® -->
    <div class="flex justify-between items-center mt-2 text-sm text-gray-700 dark:text-gray-300">
      
      <!-- å·¦ä¾§ï¼šç”¨æˆ·åæ˜¾ç¤ºï¼ˆJS æ¸²æŸ“ï¼‰ -->
      <span id="loggedInUser" class="font-semibold">æ¬¢è¿ï¼šArmstrong</span>

      <!-- å³ä¾§ï¼šæ˜æš—æ¨¡å¼ + è¯­è¨€åˆ‡æ¢ -->
      <div class="flex items-center gap-3">
        <!-- æ˜æš—æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
        <!-- âœ… æ˜æš—æ¨¡å¼åˆ‡æ¢æŒ‰é’®ï¼ˆç»Ÿä¸€é«˜åº¦ + å›¾æ ‡å±…ä¸­ï¼‰ -->
        <button
        id="themeToggle"
        class="h-8 w-8 rounded-md bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 
              flex items-center justify-center text-gray-800 dark:text-white 
              hover:bg-gray-100 dark:hover:bg-gray-700 transition-all"
        aria-label="åˆ‡æ¢æ˜æš—æ¨¡å¼"
        >
        <i class="fas fa-moon text-sm dark:hidden"></i>
        <i class="fas fa-sun text-sm hidden dark:block"></i>
        </button>

        <!-- âœ… è¯­è¨€åˆ‡æ¢æŒ‰é’®ï¼ˆç»Ÿä¸€å°ºå¯¸ + å›¾æ ‡å±…ä¸­ï¼‰ -->
        <button
        id="langToggle"
        onclick="toggleLanguage()"
        class="h-8 w-8 rounded-md bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 
              flex items-center justify-center 
              hover:bg-gray-100 dark:hover:bg-gray-700 transition-all"
        aria-label="åˆ‡æ¢è¯­è¨€"
        >
        <img
          id="languageFlag"
          src="https://flagcdn.com/cn.svg"
          alt="Language"
          class="w-5 h-4"
        />
        </button>
      </div>
    </div>
  </div>
</nav>
    <!-- å€’è®¡æ—¶å¡ç‰‡ï¼šå›ºå®šåœ¨å¯¼èˆªæ ä¸‹è¾¹ç¼˜ -->
    <!-- âœ… å€’è®¡æ—¶å¡ç‰‡ç»“æ„ï¼šfixed + æ­£ç¡®é—­åˆæ ‡ç­¾ -->
    <div
    id="examStatusBar"
    class="fixed left-1/2 -translate-x-1/2 z-30 sm:flex hidden px-4 py-2 bg-red-600 text-white text-sm rounded-xl shadow-md"
    style="top: 0px;"
    >
    <i class="fas fa-clock mr-2"></i>
    <span id="countdown">60:00</span>
    <button
      onclick="togglePause()"
      id="pauseBtn"
      class="ml-3 bg-white text-red-600 px-3 py-1 rounded-full hover:bg-red-100 text-xs sm:text-sm"
    >
      <i class="fas fa-pause mr-1"></i><span>æš‚åœ</span>
    </button>
    </div>
    <!-- åˆ é™¤é¦–é¡µ -->

    <!-- ç›´æ¥è¿›å…¥æµ‹è¯•é¡µ -->
    <section id="testPage" class="page active-page container mx-auto px-4 py-6">
	

        <div class="flex justify-between mb-6">
          <a href="/course" class="text-blue-600 dark:text-blue-400 hover:underline">
            <i class="fas fa-arrow-left mr-2"></i>è¿”å›è¯¾ç¨‹é€‰æ‹©é¡µ
          </a>
			<!-- âœ… é”™è¯¯æç¤ºæ¡†ï¼šåµŒå…¥é¡¶éƒ¨ -->
    <div id="errorMessage"
         class="hidden mb-6 px-6 py-4 rounded-lg text-lg font-semibold text-red-700 bg-red-100 border border-red-400 shadow fade-in-bounce flex items-center gap-3">
      <i class="fas fa-exclamation-triangle"></i>
      <span id="errorText">è¯·å®Œå–„ä¿¡æ¯</span>
    </div>
            <div class="text-gray-600 dark:text-gray-300">
                <i class="fas fa-clock mr-2"></i>è€ƒè¯•æ—¶é—´ï¼š60:00
            </div>
        </div>

        <!-- âœ… å­¦å‘˜ä¿¡æ¯å¡ç‰‡ï¼ˆä¼˜åŒ–æ˜æš—æ¨¡å¼ + ä¸é€æ˜ï¼‰ -->
        <div class="card-darkmode rounded-xl p-6 shadow-md mb-8 transition-colors duration-300">
          <h2 class="text-xl font-semibold mb-6 text-gray-800 !dark:text-gray-100">
            <i class="fas fa-id-card mr-2 text-blue-500"></i>å­¦å‘˜ä¿¡æ¯
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            
            <!-- å…¬å¸åç§° -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300">
                <span class="text-red-500">*</span> å…¬å¸åç§°
              </label>
              <input type="text" id="company"
                class="bg-white !dark:bg-[#2a2a2a] text-gray-900 !dark:text-gray-100 border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 w-full"
                placeholder="è¯·è¾“å…¥å…¬å¸å…¨ç§°" required>
            </div>

            <!-- å­¦å‘˜å§“å -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300">
                <span class="text-red-500">*</span> å­¦å‘˜å§“å
              </label>
              <input type="text" id="name"
                class="bg-white !dark:bg-[#2a2a2a] text-gray-900 !dark:text-gray-100 border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 w-full"
                placeholder="è¯·è¾“å…¥çœŸå®å§“å" required>
            </div>

            <!-- æ‰‹æœºå·ç  -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300">
                <span class="text-red-500">*</span> æ‰‹æœºå·ç 
              </label>
              <input type="tel" id="phone"
                class="bg-white !dark:bg-[#2a2a2a] text-gray-900 !dark:text-gray-100 border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 w-full"
                placeholder="11ä½æ‰‹æœºå·ç " pattern="[0-9]{11}" required>
            </div>

            <!-- é‚®ç®±åœ°å€ -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300">
                <span class="text-red-500">*</span> é‚®ç®±åœ°å€
              </label>
              <input type="email" id="email"
                class="bg-white !dark:bg-[#2a2a2a] text-gray-900 !dark:text-gray-100 border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 w-full"
                placeholder="name@company.com"
                pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                required>
            </div>
          </div>
        </div>


        <!-- å•é€‰é¢˜ -->
        <div class="bg-white !dark:bg-[#1f1f1f] text-gray-800 !dark:text-gray-100 rounded-xl p-6 shadow-md mb-8 transition-colors duration-300">
          <h2 class="text-xl font-semibold mb-6">
            <i class="fas fa-list-ol mr-2 text-blue-500"></i>å•é€‰é¢˜ï¼ˆæ¯é¢˜2åˆ†ï¼Œå…±40åˆ†ï¼‰
          </h2>
          <!-- âœ… å•é€‰é¢˜æŒ‚è½½åŒºåŸŸï¼šPapaParse æ¸²æŸ“çš„å¤šé€‰é¢˜å°†æ’å…¥åˆ°è¿™é‡Œ -->
          <div class="space-y-6" data-section="single"></div>
        </div>

        <!-- âœ… å¤šé€‰é¢˜å¡ç‰‡ -->
        <div class="bg-white !dark:bg-[#1f1f1f] text-gray-800 !dark:text-gray-100 rounded-xl p-6 shadow-md mb-8 transition-colors duration-300">
          <h2 class="text-xl font-semibold mb-6">
            <i class="fas fa-check-square mr-2 text-purple-500"></i>å¤šé€‰é¢˜ï¼ˆæ¯é¢˜2åˆ†ï¼Œå…±40åˆ†ï¼‰
          </h2>
          <!-- âœ… PapaParse æ¸²æŸ“çš„å¤šé€‰é¢˜å°†æ’å…¥åˆ°è¿™é‡Œ -->
          <div class="space-y-6" data-section="multi"></div>
        </div>

        <!-- âœ… åˆ¤æ–­é¢˜å¡ç‰‡ -->
        <div class="bg-white !dark:bg-[#1f1f1f] text-gray-800 !dark:text-gray-100 rounded-xl p-6 shadow-md mb-8 transition-colors duration-300">
          <h2 class="text-xl font-semibold mb-6">
            <i class="fas fa-balance-scale mr-2 text-yellow-500"></i>åˆ¤æ–­é¢˜ï¼ˆæ¯é¢˜1åˆ†ï¼Œå…±20åˆ†ï¼‰
          </h2>
          <!-- âœ… PapaParse æ¸²æŸ“çš„åˆ¤æ–­é¢˜å°†æ’å…¥åˆ°è¿™é‡Œ -->
          <div class="space-y-6" data-section="judge"></div>
        </div>    
        <!-- âœ… ç®€ç­”é¢˜å¡ç‰‡ -->
        <div class="bg-white !dark:bg-[#1f1f1f] text-gray-800 !dark:text-gray-100 rounded-xl p-6 shadow-md mb-8 transition-colors duration-300">
          <h2 class="text-xl font-semibold mb-6">
            <i class="fas fa-keyboard mr-2 text-pink-500"></i>ç®€ç­”é¢˜ï¼ˆå…±1é¢˜ï¼Œ10åˆ†ï¼‰
          </h2>
          <!-- âœ… PapaParse æ¸²æŸ“çš„ç®€ç­”é¢˜å°†æ’å…¥åˆ°è¿™é‡Œ -->
          <div class="space-y-6" data-section="essay"></div>
        </div>

        <!-- æäº¤æŒ‰é’® -->
 <div class="flex justify-center mt-8">
  <button onclick="confirmSubmitTest()"
    class="relative inline-flex items-center justify-center px-4 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600
           text-white text-sm font-medium rounded-full shadow-md hover:from-emerald-500 hover:to-green-600
           transform hover:scale-105 transition-all duration-300 ease-in-out group overflow-hidden">
    <span class="relative z-10 flex items-center">
      <i class="fas fa-file-export mr-2 text-white text-base"></i>
      æäº¤ç­”å·
    </span>
    <!-- ğŸ’« å…‰æ™•åŠ¨ç”» -->
    <div class="absolute inset-0 bg-white opacity-10 blur-xl group-hover:opacity-20 transition-all duration-500"></div>
  </button>
</div>

<!-- âœ… è¿™æ˜¯ä½ çš„ testPage é¡µé¢æœ«å°¾çš„æäº¤æŒ‰é’® -->


    </section>

  <!-- âœ… å®Œæˆé¡µï¼šå±•ç¤ºç­”é¢˜è¯¦æƒ…ã€å­¦å‘˜ä¿¡æ¯ã€æ€»åˆ†è¯„å®š -->
<section id="completePage" class="page container mx-auto px-4 py-8 text-center">
  <div id="resultCard" class="bg-white dark:bg-gray-800 rounded-xl p-8 shadow-sm max-w-4xl mx-auto text-left">
    <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200 flex items-center">
      <i class="fas fa-clipboard-check text-green-500 mr-2"></i>ç­”é¢˜è¯„ä¼°ç»“æœ
    </h2>

    <!-- å­¦å‘˜ä¿¡æ¯ä¸åˆ†æ•°å±•ç¤º -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6 text-sm sm:text-base text-gray-700 dark:text-gray-300 break-words">
      <div class="space-y-2">
        <p><strong>å…¬å¸åç§°ï¼š</strong><span id="resultCompany">-</span></p>
        <p><strong>å§“åï¼š</strong><span id="resultName">-</span></p>
        <p><strong>é‚®ç®±ï¼š</strong><span id="resultEmail">-</span></p>
        <p><strong>ç”µè¯ï¼š</strong><span id="resultPhone">-</span></p>
      </div>
      <div class="sm:text-right space-y-2">
        <p><strong>æäº¤æ—¶é—´ï¼š</strong><span id="resultTime">-</span></p>
        <p><strong>æ€»å¾—åˆ†ï¼š</strong><span id="resultScore" class="text-green-600 dark:text-green-400 text-xl font-bold">-</span> / 100</p>
        <p><strong>è¯„å®šç­‰çº§ï¼š</strong><span id="resultLevel" class="font-semibold">-</span></p>
      </div>
    </div>

    <!-- è¯¦ç»†ç­”é¢˜åˆ—è¡¨ -->
    <div class="overflow-x-auto">
      <table class="min-w-[680px] table-auto border border-gray-300 dark:border-gray-600 text-xs sm:text-sm">
        <thead class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
          <tr>
            <th class="p-2 border w-20">é¢˜å‹</th>
            <th class="p-2 border w-16">é¢˜å·</th>
            <th class="p-2 border w-1/4">ä½ çš„ç­”æ¡ˆ</th>
            <th class="p-2 border w-1/4">æ­£ç¡®ç­”æ¡ˆ</th>
            <th class="p-2 border w-20">å¾—åˆ†</th>
          </tr>
        </thead>
        <tbody id="resultTableBody" class="text-gray-700 dark:text-gray-300">
          <!-- JavaScript æ¸²æŸ“å†…å®¹ -->
        </tbody>
      </table>
    </div>


    <!-- æ“ä½œæŒ‰é’® -->
    <div class="mt-6 text-center">
      <!-- âœ… è¿”å›ç­”é¢˜é¡µæŒ‰é’® -->
      <button onclick="onReturnToTestPage()"
      class="mr-4 px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full shadow-md transition-all">
      <i class="fas fa-arrow-left mr-2"></i>è¿”å›ç­”é¢˜é¡µ
      </button>

      <button onclick="onStartEvaluationClick()"
        class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-full shadow-md transition-all">
        <i class="fas fa-paper-plane mr-2"></i>å¼€å§‹æ‰“åˆ†
      </button>
    </div>
  </div>

</section>



 <!--  By Martin æ­¤å¤„æ˜¯æ ¸å¿ƒå‡½æ•°åŠåŠŸèƒ½çš„ä»£ç  å¼€å§‹ -->
 <script>
 // âœ… EE-W äº§å“åŸ¹è®­è€ƒè¯•ç³»ç»Ÿè„šæœ¬ï¼ˆæ•´åˆç‰ˆï¼‰
 // åŒ…å«å€’è®¡æ—¶ã€ç­”é¢˜æ”¶é›†ã€è¯„ä¼°è¯„åˆ†ã€å¯¼å‡º PDFã€å‘é€é‚®ä»¶ã€åŠ¨æ€å£ä»¤ç­‰æ¨¡å—
 
 let remainingTime = 60 * 60; // è€ƒè¯•æ€»æ—¶é•¿ï¼š60åˆ†é’Ÿ
 let timerInterval = null;
 let isPaused = false;
 let evaluationStarted = false; // âœ… æ§åˆ¶æ˜¯å¦å·²å¼€å§‹è¯„æµ‹

 let emailjsReady = false;  // âœ… çŠ¶æ€å˜é‡ï¼šæ ‡è®°æ˜¯å¦å·²åŠ è½½æˆåŠŸ

 let emailSent = false; // âœ… å…¨å±€å˜é‡ï¼šæ ‡è®°é‚®ä»¶æ˜¯å¦å·²å‘é€æˆåŠŸ

 const EMAIL_ENABLED = false; // âœ… æ§åˆ¶æ˜¯å¦å¯ç”¨é‚®ä»¶å‘é€åŠŸèƒ½ï¼ˆè°ƒè¯•æ—¶è®¾ä¸º falseï¼‰
  
 // âœ… åŠ¨æ€åŠ è½½ SDKï¼ˆæ›´çµæ´»ç¨³å®šï¼‰
function loadEmailJS() {
  return new Promise((resolve, reject) => {
    if (window.emailjs) {
      emailjsReady = true;
      resolve(); // å·²åŠ è½½ï¼Œæ— éœ€é‡å¤
      return;
    }

    const script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
    script.async = true;

    script.onload = () => {
      try {
        emailjs.init("LoQCI3C98dk3FgEvj"); // âœ… æ›¿æ¢ä¸ºä½ çš„ Public Key
        emailjsReady = true;
        resolve();
      } catch (e) {
        console.error("[EmailJS] åˆå§‹åŒ–å¤±è´¥", e);
        reject(e);
      }
    };

    script.onerror = () => {
      console.error("[EmailJS] åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜");
      reject(new Error("SDK åŠ è½½å¤±è´¥"));
    };

    document.head.appendChild(script);
  });
}


 
 // â³ å€’è®¡æ—¶æ›´æ–°å‡½æ•°
 function updateCountdown() {
   const min = String(Math.floor(remainingTime / 60)).padStart(2, '0');
   const sec = String(remainingTime % 60).padStart(2, '0');
   document.getElementById('countdown').innerText = `${min}:${sec}`;
 }
 
 // â±ï¸ å¯åŠ¨å€’è®¡æ—¶
 function startTimer() {
   if (timerInterval) clearInterval(timerInterval);
   timerInterval = setInterval(() => {
     if (!isPaused) {
       remainingTime--;
       updateCountdown();
       if (remainingTime <= 0) {
         clearInterval(timerInterval);
         isPaused = true;
         document.getElementById('testPage').classList.add('blur-overlay');
         alert('æ—¶é—´å·²åˆ°ï¼Œè€ƒè¯•ç»“æŸï¼');
       }
     }
   }, 1000);
 }
 
 // â¸ï¸ æš‚åœ / æ¢å¤
 function togglePause() {
   isPaused = !isPaused;
   const testPage = document.getElementById('testPage');
   const pauseBtn = document.getElementById('pauseBtn');
   if (isPaused) {
     testPage.classList.add('blur-overlay');
     pauseBtn.innerHTML = '<i class="fas fa-play mr-1"></i><span>ç»§ç»­</span>';
   } else {
     testPage.classList.remove('blur-overlay');
     pauseBtn.innerHTML = '<i class="fas fa-pause mr-1"></i><span>æš‚åœ</span>';
   }
 }

 let hasEnteredBefore = false; // âœ… æ˜¯å¦é¦–æ¬¡è¿›å…¥æ ‡è®°
function showTestPage() { // âœ… åˆ‡æ¢åˆ°è€ƒè¯•é¡µé¢ï¼Œå¹¶å¯åŠ¨è®¡æ—¶å™¨/æ¸…é™¤æ¯›ç»ç’ƒé®ç½©/æ˜¾ç¤ºâ€œæš‚åœâ€æŒ‰é’®/å¯åŠ¨å€’è®¡æ—¶ï¼ˆä»…é¦–æ¬¡è¿›å…¥ï¼‰
  // åˆ‡æ¢è‡³è€ƒè¯•é¡µé¢
  showPage('testPage');

  // å¯åŠ¨å€’è®¡æ—¶ï¼ˆä»…åœ¨é¦–æ¬¡è¿›å…¥æ—¶ï¼‰
  if (!timerInterval) {
    startTimer(); // â±ï¸ å¯åŠ¨ 60 åˆ†é’Ÿå€’è®¡æ—¶
  }

  // æ¸…é™¤æš‚åœçŠ¶æ€
  if (remainingTime > 0) {
    isPaused = false;
    document.getElementById('testPage').classList.remove('blur-overlay');
    document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause mr-1"></i>æš‚åœ';

    if (hasEnteredBefore) {
      // âœ… éé¦–æ¬¡è¿›å…¥ï¼Œæ˜¾ç¤ºé®ç½©æç¤º
      document.getElementById('countdownCenterOverlay').style.display = 'flex';
    }

    hasEnteredBefore = true; // âœ… è®¾ç½®ä¸ºå·²è¿›å…¥
  }
}

 // ğŸ“„ é¡µé¢åˆ‡æ¢æ§åˆ¶
 function showPage(pageId) {
   document.querySelectorAll('.page').forEach(page => {
     page.classList.remove('active-page');
   });
   document.getElementById(pageId).classList.add('active-page');
   window.scrollTo(0, 0);
   if (pageId === 'homePage' || pageId === 'completePage') {
     isPaused = true;
     document.getElementById('testPage').classList.add('blur-overlay');
   }
 }
 
 // document.addEventListener('DOMContentLoaded', updateCountdown);
 
 
 // âœ… ç­”æ¡ˆæ”¶é›†
function collectAnswers() {
  return {
    // ğŸ§  åŸºç¡€ä¿¡æ¯é‡‡é›†
    userInfo: {
      company: document.getElementById('company')?.value || "",
      name: document.getElementById('name')?.value || "",
      phone: document.getElementById('phone')?.value || "",
      email: document.getElementById('email')?.value || ""
    },

    // âœ… å•é€‰é¢˜æ”¶é›†ï¼ˆæŒ‰ name åˆ†ç»„ï¼‰
    singleChoice: Array.from(document.querySelectorAll('input[type="radio"]:checked'))
      .filter(el => el.name.startsWith('q'))
      .reduce((acc, el) => {
        acc[el.name] = el.value;
        return acc;
      }, {}),

    // âœ… å¤šé€‰é¢˜æ”¶é›†ï¼ˆæŒ‰ name åˆ†ç»„ï¼‰
    multipleChoice: Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
      .reduce((acc, el) => {
        const group = el.name.replace('mq', '');
        if (!acc[group]) acc[group] = [];
        acc[group].push(el.value);
        return acc;
      }, {}),

    // âœ… åˆ¤æ–­é¢˜æ”¶é›†ï¼ˆåªé€‰ä¸­é¡¹ï¼‰
    judgment: Array.from(document.querySelectorAll('.judge-card input[type="radio"]:checked'))
      .reduce((acc, el) => {
        acc[el.name] = el.value;
        return acc;
      }, {}),

    // âœ… ç®€ç­”é¢˜æ”¶é›†ï¼šæ”¯æŒå¤šä¸ª textarea[data-essay-id]
    essay: (() => {
      const result = {};
      document.querySelectorAll("textarea[data-essay-id]").forEach(textarea => {
        const id = textarea.dataset.essayId;
        result[id] = textarea.value.trim();
      });
      return result;
    })()
  };
}

 
 // âœ… è¯„ä¼°è¯„åˆ†å¹¶æ¸²æŸ“å®Œæˆé¡µ
 function renderAssessmentResult(answers) {
   const now = new Date().toLocaleString('zh-CN', { hour12: false });
   document.getElementById('resultCompany').textContent = answers.userInfo.company;
   document.getElementById('resultName').textContent = answers.userInfo.name;
   document.getElementById('resultEmail').textContent = answers.userInfo.email;
   document.getElementById('resultPhone').textContent = answers.userInfo.phone;
   document.getElementById('resultTime').textContent = now;
 
   let totalScore = 0;
   let tbody = document.getElementById('resultTableBody');
   tbody.innerHTML = '';
 
   const createRow = (type, num, your, correct, score) => {
     const row = document.createElement('tr');
     row.innerHTML = `
       <td class="border p-2">${type}</td>
       <td class="border p-2">${num}</td>
       <td class="border p-2">${your}</td>
       <td class="border p-2">${correct}</td>
       <td class="border p-2">${score === 0 ? 'âœ˜' : 'âœ”'} ${score}</td>
     `;
     tbody.appendChild(row);
   };
 
   // âœ… æ­£ç¡®ç­”æ¡ˆåº“
   
 
   // âœ… å•é€‰é¢˜ï¼ˆ25é¢˜ * 2åˆ†ï¼‰
   
 
   // âœ… å¤šé€‰é¢˜ï¼ˆ20é¢˜ * 1åˆ†ï¼‰
   
 
   // âœ… åˆ¤æ–­é¢˜ï¼ˆ20é¢˜ * 1åˆ†ï¼‰
   
 
   // âœ… ç®€ç­”é¢˜è¯„åˆ†é€»è¾‘ï¼ˆå…³é”®è¯å‘½ä¸­ï¼‰


// âœ… ç®€ç­”é¢˜ä»…æ˜¾ç¤ºç”¨æˆ·ç­”æ¡ˆä¸å¾—åˆ†ï¼Œä¸æ˜¾ç¤ºâ€œæ­£ç¡®ç­”æ¡ˆâ€
const essayRow = document.createElement('tr');
essayRow.innerHTML = `
  <td class="border p-2">ç®€ç­”é¢˜</td>
  <td class="border p-2">1</td>
  <td class="border p-2">${answers.essay.slice(0, 30)}...</td>
  <td class="border p-2 text-center text-gray-400 italic">-</td>
  <td class="border p-2">${essayScore === 0 ? 'âœ˜' : 'âœ”'} ${essayScore}</td>
`;
tbody.appendChild(essayRow);
totalScore += essayScore;
 
   // âœ… è¯„å®šç»“æœæ˜¾ç¤º
   document.getElementById('resultScore').textContent = totalScore;
   document.getElementById('resultLevel').textContent = totalScore >= 80 ? 'âœ… åˆæ ¼' : 'âŒ ä¸åˆæ ¼';
 }

 // âœ… å¯¼å‡ºå®Œæˆé¡µä¸º PDF æ–‡ä»¶
async function exportResultToPDF(userName = 'åŒ¿åç”¨æˆ·') {
  const completePage = document.getElementById("completePage");

  // âœ… ä½¿ç”¨ html2canvas æ¸²æŸ“å½“å‰å®Œæˆé¡µä¸ºå›¾ç‰‡ï¼Œå¹¶æ’å…¥ PDF ä¸­
  const canvas = await html2canvas(completePage, { scale: 2, useCORS: true });
  const imgData = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(imgData);
  const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;

  pdf.addImage(imgData, "PNG", 0, 0, pageWidth, pdfHeight);
  pdf.save(`EE-Wè¯„æµ‹ç»“æœ_${userName}.pdf`);
}


// âœ… å°†ç­”é¢˜ç»“æœç”Ÿæˆ HTML è¡¨æ ¼ç”¨äºæ’å…¥é‚®ä»¶
function buildEmailHTMLTable(answers) {
  const getRow = (type, index, your, correct, score) => `
    <tr>
      <td>${type}</td>
      <td>${index}</td>
      <td>${your}</td>
      <td>${correct}</td>
      <td>${score}</td>
    </tr>`;

  const rows = [];

  const correctAnswers = {
    single: ["B", "C", "A", "B", "D", "C", "C", "B", "B", "B", "D", "C", "C", "B", "C", "B", "C", "B", "B", "B", "C", "D", "D", "B", "B"],
    multiple: [
      ["A", "B", "D"], ["C", "D"], ["A", "B", "C"], ["A", "B", "D"], ["A", "B", "C", "D"],
      ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"], ["A", "B", "C", "D"], ["A", "B", "C", "D"],
      ["A", "B", "D"], ["A", "B", "D"], ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"],
      ["A", "B", "C"], ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"], ["A", "B", "C", "D"]
    ],
    judge: ["true", "false", "false", "true", "true", "false", "true", "true", "false", "true", "false", "true", "false", "true", "false", "true", "true", "false", "true", "false"]
  };

  // å•é€‰é¢˜
  for (let i = 1; i <= 25; i++) {
    const key = `q${i}`;
    const your = answers.singleChoice[key] || "-";
    const correct = correctAnswers.single[i - 1];
    const score = (your === correct) ? 2 : 0;
    rows.push(getRow("å•é€‰é¢˜", i, your, correct, score));
  }

  // å¤šé€‰é¢˜
  for (let i = 1; i <= 20; i++) {
    const key = i.toString();
    const your = (answers.multipleChoice[key] || []).join(", ");
    const correct = correctAnswers.multiple[i - 1].join(", ");
    const score = (your.split(', ').sort().join(',') === correct.split(', ').sort().join(',')) ? 1 : 0;
    rows.push(getRow("å¤šé€‰é¢˜", i, your, correct, score));
  }

  // åˆ¤æ–­é¢˜
  for (let i = 1; i <= 20; i++) {
    const key = `jq${i}`;
    const your = answers.judgment[key] === "true" ? "âœ” æ­£ç¡®" : answers.judgment[key] === "false" ? "âœ˜ é”™è¯¯" : "-";
    const correct = correctAnswers.judge[i - 1] === "true" ? "âœ” æ­£ç¡®" : "âœ˜ é”™è¯¯";
    const score = answers.judgment[key] === correctAnswers.judge[i - 1] ? 1 : 0;
    rows.push(getRow("åˆ¤æ–­é¢˜", i, your, correct, score));
  }

  // ç®€ç­”é¢˜æ‰“åˆ†
  const keywords = ["ä¼ æ„Ÿå™¨", "æ¸©åº¦", "å·®å‹", "æ•°é‡", "å®‰è£…ä½ç½®", "é€šä¿¡"];
  const match = keywords.filter(k => answers.essay.includes(k)).length;
  let essayScore = 0;
  if (match >= 5) essayScore = 35;
  else if (match >= 3) essayScore = 25;
  else if (match >= 1) essayScore = 10;
  rows.push(getRow("ç®€ç­”é¢˜", 1, answers.essay.slice(0, 20) + "...", "(å…³é”®è¯åŒ¹é…)", essayScore));

  // è¿”å›å®Œæ•´ HTML è¡¨æ ¼
  return `
    <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
      <thead style="background-color: #f3f4f6; color: #111">
        <tr><th>é¢˜å‹</th><th>é¢˜å·</th><th>ä½ çš„ç­”æ¡ˆ</th><th>æ­£ç¡®ç­”æ¡ˆ</th><th>å¾—åˆ†</th></tr>
      </thead>
      <tbody>${rows.join('')}</tbody>
    </table>`;
}


// âœ… EmailJS é‚®ä»¶å‘é€
function sendResultEmail(answers) {
  if (!EMAIL_ENABLED) {
    console.log("[è°ƒè¯•] é‚®ä»¶åŠŸèƒ½å·²ç¦ç”¨ï¼Œæœªæ‰§è¡Œå‘é€ã€‚");
    return;
  }

  if (emailSent) {
    console.log("[è°ƒè¯•] é‚®ä»¶å·²å‘é€ï¼Œæ— éœ€é‡å¤å‘é€ã€‚");
    return;
  }

  const templateParams = {
    company: answers.userInfo.company,
    user_name: answers.userInfo.name,
    phone: answers.userInfo.phone,
    user_email: answers.userInfo.email,
    timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
    message: 'æ¥è‡ª EE-W åŸ¹è®­ç³»ç»Ÿçš„è¯„æµ‹ç»“æœ',
    table_html: buildEmailHTMLTable(answers)
  };

  if (!window.emailjs) {
    const script = document.createElement("script");
    script.src = "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
    script.onload = () => {
      emailjs.init("LoQCI3C98dk3FgEvj");
      emailjs.send("service_csl8frv", "template_0v2mqw9", templateParams)
        .then(() => {
          console.log("âœ… é‚®ä»¶å‘é€æˆåŠŸ");
          alert('âœ… é‚®ä»¶å·²æˆåŠŸå‘é€åˆ° RSEC é‚®ç®±ï¼');
          emailSent = true; // âœ… è®¾ç½®çŠ¶æ€ï¼Œè¡¨ç¤ºå·²æˆåŠŸå‘é€
        })
        .catch(err => {
          console.error('[EmailJS] é‚®ä»¶å¤±è´¥', err);
          //alert('âš ï¸ é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·å°†å¯¼å‡ºçš„ PDF æ‰‹åŠ¨å‘é€åˆ° RSEC é‚®ç®±ï¼šrsec@armstrong.com');
          showEmailResultPopup("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡æ–°å‘é€ï¼Ÿ");
        });
    };
    document.head.appendChild(script);
  } else {
    emailjs.init("LoQCI3C98dk3FgEvj");
    emailjs.send("service_csl8frv", "template_0v2mqw9", templateParams)
      .then(() => {
        console.log("âœ… é‚®ä»¶å‘é€æˆåŠŸ");
        alert('âœ… é‚®ä»¶å·²æˆåŠŸå‘é€åˆ° RSEC é‚®ç®±ï¼');
        emailSent = true; // âœ… è®¾ç½®çŠ¶æ€ï¼Œè¡¨ç¤ºå·²æˆåŠŸå‘é€
      })
      .catch(err => {
        console.error('[EmailJS] é‚®ä»¶å¤±è´¥', err);
        //alert('âš ï¸ é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·å°†å¯¼å‡ºçš„ PDF æ‰‹åŠ¨å‘é€åˆ° RSEC é‚®ç®±ï¼šrsec@armstrong.com');
        showEmailResultPopup("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡æ–°å‘é€ï¼Ÿ");
      });
  }
}


// âœ… æ¸²æŸ“å®Œæˆé¡µä¸Šç”¨æˆ·æäº¤çš„ç­”æ¡ˆï¼ˆä¸åŒ…å«æ­£ç¡®ç­”æ¡ˆä¸å¾—åˆ†ï¼‰
function renderAnswersOnCompletePage(answers) {
  const now = new Date().toLocaleString('zh-CN', { hour12: false });

  // å¡«å……ç”¨æˆ·ä¿¡æ¯
  document.getElementById("resultCompany").textContent = answers.userInfo.company;
  document.getElementById("resultName").textContent = answers.userInfo.name;
  document.getElementById("resultEmail").textContent = answers.userInfo.email;
  document.getElementById("resultPhone").textContent = answers.userInfo.phone;
  document.getElementById("resultTime").textContent = now;

  // åªåˆ—å‡ºç­”é¢˜å†…å®¹ï¼Œä¸è¯„åˆ¤æ­£è¯¯
  const tbody = document.getElementById("resultTableBody");
  tbody.innerHTML = ""; // æ¸…ç©ºåŸæœ‰è¡Œ

  const createRow = (type, num, yourAnswer) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="border p-2">${type}</td>
      <td class="border p-2">${num}</td>
      <td class="border p-2">${yourAnswer}</td>
      <td class="border p-2 text-gray-400 italic">-</td>
      <td class="border p-2 text-gray-400 italic">-</td>
    `;
    tbody.appendChild(row);
  };

  // å•é€‰é¢˜
  for (let i = 1; i <= 25; i++) {
    const key = `q${i}`;
    createRow("å•é€‰é¢˜", i, answers.singleChoice[key] || "æœªç­”");
  }

  // å¤šé€‰é¢˜
  for (let i = 1; i <= 20; i++) {
    const key = i.toString();
    const val = answers.multipleChoice[key] || [];
    createRow("å¤šé€‰é¢˜", i, val.join(", ") || "æœªç­”");
  }

  // åˆ¤æ–­é¢˜
  for (let i = 1; i <= 20; i++) {
    const key = `jq${i}`;
    const val = answers.judgment[key];
    const label = val === "true" ? "âœ” æ­£ç¡®" : val === "false" ? "âœ˜ é”™è¯¯" : "æœªç­”";
    createRow("åˆ¤æ–­é¢˜", i, label);
  }

  // ç®€ç­”é¢˜
  createRow("ç®€ç­”é¢˜", 1, answers.essay.slice(0, 50) + (answers.essay.length > 50 ? "..." : ""));
}

/**
 * âœ… handleExportï¼šè€ƒè¯•æäº¤ä¸»æµç¨‹
 * åŒ…å«è¯„æµ‹ã€PDF å¯¼å‡ºã€é‚®ä»¶å‘é€åŠŸèƒ½ï¼ˆè°ƒç”¨ renderAssessmentResultï¼‰
 */
 async function handleExport() {
    // 1. æ ¡éªŒå¿…å¡«é¡¹
    if (!validateForm()) {
        alert("è¯·å®Œå–„å¿…å¡«ä¿¡æ¯å’Œç­”é¢˜å†…å®¹åå†æäº¤ï¼");
        return;
    }

    // 2. æ˜¾ç¤º loading åŠ¨ç”»ï¼ˆéœ€ç¡®ä¿é¡µé¢ä¸­å­˜åœ¨ id="loading" çš„å…ƒç´ ï¼‰
    const loading = document.getElementById("loading");
    loading?.classList.remove("hidden");

    try {
        // 3. æ¨¡æ‹Ÿå»¶è¿Ÿï¼Œç¡®ä¿ UI æ¸²æŸ“ç¨³å®š
        await new Promise(resolve => setTimeout(resolve, 300));

        // 4. æ”¶é›†ç”¨æˆ·ç­”é¢˜
        const answers = collectAnswers();

        // 5. åˆ‡æ¢åˆ°å®Œæˆé¡µï¼Œå¼€å§‹è¯„æµ‹ï¼ˆæ¸²æŸ“ç»“æœé¡µ + è¡¨æ ¼ï¼‰
        showPage("completePage");
        renderAssessmentResult(answers);
        evaluationStarted = true;

        // 6. ç­‰å¾… 1sï¼Œç¡®ä¿å®Œæˆé¡µåŠ è½½å®Œæ¯•åå†å¯¼å‡º PDF
        setTimeout(() => {
            const completePage = document.getElementById("completePage");
            const userName = answers.userInfo.name || "åŒ¿å";
            html2pdf().from(completePage).set({
              margin: [10, 10, 10, 10],
              filename: `EE-Wè¯„æµ‹ç»“æœ_${userName}.pdf`,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2, useCORS: true },
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
              pagebreak: { mode: ['css', 'legacy'] }  // âœ… è‡ªåŠ¨åˆ†é¡µ
            }).save().then(() => {
                console.log("[PDF] å¯¼å‡ºæˆåŠŸ");
            }).catch(err => {
                console.error("[PDF] å¯¼å‡ºå¤±è´¥", err);
            });
        }, 1000);

        // 7. æ„å»ºé‚®ä»¶å‚æ•°ï¼ˆå«ç­”é¢˜ç»“æœè¡¨æ ¼ï¼‰
        const tableHTML = generateEmailTableHTML(answers);
        const templateParams = {
            company: answers.userInfo.company,
            user_name: answers.userInfo.name,
            phone: answers.userInfo.phone,
            user_email: answers.userInfo.email,
            timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
            message: 'ç³»ç»Ÿè‡ªåŠ¨æäº¤ï¼šEE-Wäº§å“åŸ¹è®­ç­”å·',
            table_html: tableHTML
        };

        // 8. åŠ è½½ emailjs æ¨¡å—ï¼ˆä»…åŠ è½½ä¸€æ¬¡ï¼‰
        if (!window.emailjs) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js';
            script.onload = () => {
                emailjs.init('LoQCI3C98dk3FgEvj');
                emailjs.send('service_csl8frv', 'template_0v2mqw9', templateParams)
                    .then(() => console.log("[EmailJS] é‚®ä»¶å‘é€æˆåŠŸ"))
                    .catch(err => {
                        console.error('[EmailJS] é‚®ä»¶å¤±è´¥', err);
                        alert('âš ï¸ é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·å°†å¯¼å‡ºçš„ PDF æ‰‹åŠ¨å‘é€åˆ° RSEC é‚®ç®±ï¼šrsec@armstrong.com');
                        showEmailResultPopup("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡æ–°å‘é€ï¼Ÿ");
                      });
            };
            document.head.appendChild(script);
        } else {
            emailjs.init('LoQCI3C98dk3FgEvj');
            emailjs.send('service_csl8frv', 'template_0v2mqw9', templateParams)
                .then(() => console.log("[EmailJS] é‚®ä»¶å‘é€æˆåŠŸ"))
                .catch(err => {
                        console.error('[EmailJS] é‚®ä»¶å¤±è´¥', err);
                        //alert('âš ï¸ é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·å°†å¯¼å‡ºçš„ PDF æ‰‹åŠ¨å‘é€åˆ° RSEC é‚®ç®±ï¼šrsec@armstrong.com');
                        showEmailResultPopup("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡æ–°å‘é€ï¼Ÿ");
                      });
        }

    } catch (error) {
        console.error("æäº¤å¤±è´¥ï¼š", error);
        alert("æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯ï¼š" + error.message);
    } finally {
        // 9. éšè— loading åŠ¨ç”»
        loading?.classList.add("hidden");
    }
}

/**
 * âœ… è¡¨å•æ ¡éªŒå‡½æ•°ï¼šç¡®ä¿æ‰€æœ‰åŸºæœ¬ä¿¡æ¯ä¸é¢˜ç›®éƒ½å·²å¡«å†™
 * @returns {boolean} æ˜¯å¦é€šè¿‡æ ¡éªŒ
 */
 // âœ… ä¸´æ—¶å±è”½æ ¡éªŒé€»è¾‘ï¼ˆè°ƒè¯•ç”¨ï¼‰
function validateForm() {
  console.warn("[è°ƒè¯•æ¨¡å¼] è¡¨å•éªŒè¯å·²è·³è¿‡");
  return true;
}
// ğŸ” å¼¹å‡ºåŠ¨æ€å£ä»¤çª—å£
function promptPasswordAndSend(answers) {
  document.getElementById("passwordModal").classList.remove("hidden");

  // å›è°ƒå‡½æ•°ï¼šæ ¹æ®ç”¨æˆ·ç‚¹å‡»å†³å®šæ˜¯å¦å‘é€
  window.confirmPassword = async function(sendEmail) {
    const password = document.getElementById("passwordInput").value.trim();
    showUniversalModal("åŠ¨æ€éªŒè¯ç ", "è¯·è¾“å…¥éªŒè¯ç ä»¥å‘é€æˆç»©", true, (val) => {
      if (val === "AFT2025") {
        const html = buildEmailTable();
        sendResultEmail(html);
      } else {
        alert("éªŒè¯ç é”™è¯¯");
      }
});

    // åˆ¤æ–­å£ä»¤æœ‰æ•ˆæ€§ï¼ˆé»˜è®¤æ­£ç¡®å£ä»¤ï¼šAFT2025ï¼‰
    const isValid = password === "AFT2025";
    
    // æ— è®ºæ­£ç¡®ä¸å¦ï¼Œå¯¼å‡º PDF
    await exportResultPDF(answers);

    if (sendEmail && isValid) {
      await sendResultEmail(answers);
    } else if (sendEmail && !isValid) {
      alert("âŒ åŠ¨æ€å£ä»¤é”™è¯¯ï¼Œæœªå‘é€é‚®ä»¶ï¼Œä»…å¯¼å‡º PDFã€‚");
    } else {
      alert("âœ… å·²è·³è¿‡é‚®ä»¶ï¼Œä»…ä¿å­˜æœ¬åœ° PDFã€‚");
    }
  };
}

// ğŸ“„ å¯¼å‡ºå®Œæˆé¡µä¸º PDF
async function exportResultPDF(answers) {
  const page = document.getElementById("completePage");
  const user = answers.userInfo.name || "æœªå‘½å";
  await html2pdf().from(page).set({
    margin: 0,
    filename: `EE-Wè¯„æµ‹ç»“æœ_${user}.pdf`,
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
  }).save();
}

// ğŸ“© æ„å»ºé‚®ä»¶å‘é€é€»è¾‘
async function sendResultEmail(answers) {
  const tableHTML = generateEmailTableHTML(answers);
  const templateParams = {
    company: answers.userInfo.company,
    user_name: answers.userInfo.name,
    phone: answers.userInfo.phone,
    user_email: answers.userInfo.email,
    timestamp: new Date().toLocaleString("zh-CN", { hour12: false }),
    message: "EE-Wäº§å“åŸ¹è®­è‡ªåŠ¨æäº¤ç­”å·",
    table_html: tableHTML
  };

  try {
    if (!window.emailjs) {
      await new Promise(resolve => {
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
        s.onload = resolve;
        document.head.appendChild(s);
      });
    }
    emailjs.init("LoQCI3C98dk3FgEvj");
    await emailjs.send("service_csl8frv", "template_0v2mqw9", templateParams);
    alert("âœ… é‚®ä»¶å·²æˆåŠŸå‘é€ï¼");
  } catch (err) {
    console.error("[EmailJS] é‚®ä»¶å‘é€å¤±è´¥ï¼š", err);
    //alert("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼");
    showEmailResultPopup("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡æ–°å‘é€ï¼Ÿ");
  }
}

/**
 * âœ… å°è£…ç»Ÿä¸€çš„é‚®ä»¶å‘é€å‡½æ•°ï¼Œè‡ªåŠ¨åŠ è½½æ¨¡å—å¹¶å¤„ç†å›è°ƒ
 */
function sendEmailWithTemplate(templateParams, onSuccess = null, onFailure = null) {
  const serviceID = 'service_csl8frv';
  const templateID = 'template_0v2mqw9';
  const publicKey = 'LoQCI3C98dk3FgEvj';

  if (typeof emailjs === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js';
    script.onload = () => {
      emailjs.init(publicKey);
      emailjs.send(serviceID, templateID, templateParams)
        .then(() => {
          console.log('[EmailJS] é‚®ä»¶å‘é€æˆåŠŸ');
          alert("âœ… è¯„æµ‹ç»“æœå·²æˆåŠŸå‘é€è‡³ RSEC é‚®ç®±ï¼");
          if (typeof onSuccess === 'function') onSuccess();
        })
        .catch(err => {
          console.error('[EmailJS] é‚®ä»¶å‘é€å¤±è´¥:', err);
          showEmailResultPopup("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡æ–°å‘é€ï¼Ÿ");
          if (typeof onFailure === 'function') onFailure(err);
        });
    };
    script.onerror = () => {
      console.error('[EmailJS] æ¨¡å—åŠ è½½å¤±è´¥');
      if (typeof onFailure === 'function') onFailure(new Error('æ¨¡å—åŠ è½½å¤±è´¥'));
    };
    document.head.appendChild(script);
  } else {
    emailjs.init(publicKey);
    emailjs.send(serviceID, templateID, templateParams)
      .then(() => {
        console.log('[EmailJS] é‚®ä»¶å‘é€æˆåŠŸ');
        alert("âœ… è¯„æµ‹ç»“æœå·²æˆåŠŸå‘é€è‡³ RSEC é‚®ç®±ï¼");
        if (typeof onSuccess === 'function') onSuccess();
      })
      .catch(err => {
        console.error('[EmailJS] é‚®ä»¶å‘é€å¤±è´¥:', err);
        showEmailResultPopup("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡æ–°å‘é€ï¼Ÿ");
        if (typeof onFailure === 'function') onFailure(err);
      });
  }
}

/**
 * âœ… å°†ç”¨æˆ·ç­”é¢˜ç»“æœç”Ÿæˆ HTML è¡¨æ ¼ï¼Œç”¨äºæ’å…¥é‚®ä»¶æ­£æ–‡ä¸­
 * @param {Object} answers - ç”¨æˆ·ç­”é¢˜æ•°æ®ç»“æ„ï¼ˆç”± collectAnswers() è¿”å›ï¼‰
 * @returns {string} HTML å­—ç¬¦ä¸²ï¼ŒåŒ…å«æ‰€æœ‰ç­”é¢˜è¡¨æ ¼
 */
 function generateEmailTableHTML(answers) {
  let html = `
  <style>
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; font-family: sans-serif; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
    thead { background-color: #f3f4f6; color: #111827; }
    .title { background-color: #ef4444; color: white; font-weight: bold; }
  </style>

  <h2 style="margin-top: 0;">ğŸ“‹ ç­”é¢˜è¯„ä¼°ç»“æœ</h2>
  <p><strong>å…¬å¸åç§°ï¼š</strong>${answers.userInfo.company}</p>
  <p><strong>å§“åï¼š</strong>${answers.userInfo.name}</p>
  <p><strong>é‚®ç®±ï¼š</strong>${answers.userInfo.email}</p>
  <p><strong>ç”µè¯ï¼š</strong>${answers.userInfo.phone}</p>
  <p><strong>æäº¤æ—¶é—´ï¼š</strong>${new Date().toLocaleString('zh-CN', { hour12: false })}</p>
  `;

  const correctAnswers = {
    single: ["B", "C", "A", "B", "D", "C", "C", "B", "B", "B", "D", "C", "C", "B", "C", "B", "C", "B", "B", "B", "C", "D", "D", "B", "B"],
    multiple: [
      ["A", "B", "D"], ["C", "D"], ["A", "B", "C"], ["A", "B", "D"], ["A", "B", "C", "D"],
      ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"], ["A", "B", "C", "D"], ["A", "B", "C", "D"],
      ["A", "B", "D"], ["A", "B", "D"], ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"],
      ["A", "B", "C"], ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"], ["A", "B", "C", "D"]
    ],
    judge: ["true", "false", "false", "true", "true", "false", "true", "true", "false", "true", "false", "true", "false", "true", "false", "true", "true", "false", "true", "false"]
  };

  // æ¸²æŸ“æ¯ç±»é¢˜å‹è¡¨æ ¼
  const appendTable = (type, count, getUser, getCorrect, getScore) => {
    let rows = '';
    for (let i = 1; i <= count; i++) {
      const your = getUser(i);
      const correct = getCorrect(i);
      const score = getScore(i);
      rows += `<tr>
        <td>${type}</td>
        <td>${i}</td>
        <td>${your}</td>
        <td>${correct}</td>
        <td>${score}</td>
      </tr>`;
    }
    html += `
      <table>
        <thead class="title"><tr><th colspan="5">${type}</th></tr></thead>
        <thead><tr><th>é¢˜å‹</th><th>é¢˜å·</th><th>ä½ çš„ç­”æ¡ˆ</th><th>æ­£ç¡®ç­”æ¡ˆ</th><th>å¾—åˆ†</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  };

  // å•é€‰é¢˜
  appendTable("å•é€‰é¢˜", 25,
    i => answers.singleChoice[`q${i}`] || 'æœªç­”',
    i => correctAnswers.single[i - 1],
    i => (answers.singleChoice[`q${i}`] === correctAnswers.single[i - 1]) ? 2 : 0
  );

  // å¤šé€‰é¢˜
  appendTable("å¤šé€‰é¢˜", 20,
    i => (answers.multipleChoice[i] || []).join(', ') || 'æœªç­”',
    i => correctAnswers.multiple[i - 1].join(', '),
    i => {
      const your = (answers.multipleChoice[i] || []).sort();
      const correct = correctAnswers.multiple[i - 1].sort();
      return JSON.stringify(your) === JSON.stringify(correct) ? 1 : 0;
    }
  );

  // åˆ¤æ–­é¢˜
  appendTable("åˆ¤æ–­é¢˜", 20,
    i => {
      const v = answers.judgment[`jq${i}`];
      return v === 'true' ? 'âœ” æ­£ç¡®' : v === 'false' ? 'âœ˜ é”™è¯¯' : 'æœªç­”';
    },
    i => correctAnswers.judge[i - 1] === 'true' ? 'âœ” æ­£ç¡®' : 'âœ˜ é”™è¯¯',
    i => (answers.judgment[`jq${i}`] === correctAnswers.judge[i - 1]) ? 1 : 0
  );

  // ç®€ç­”é¢˜
  const essay = answers.essay || '';
  const keywords = ["ä¼ æ„Ÿå™¨", "æ¸©åº¦", "å·®å‹", "æ•°é‡", "å®‰è£…ä½ç½®", "é€šä¿¡"];
  const match = keywords.filter(k => essay.includes(k)).length;
  const essayScore = match >= 5 ? 35 : match >= 3 ? 25 : match >= 1 ? 10 : 0;
  html += `
    <table>
      <thead class="title"><tr><th colspan="5">ç®€ç­”é¢˜</th></tr></thead>
      <tbody><tr><td colspan="5" style="text-align: left;">${essay || 'æœªä½œç­”'}<br/><strong>å¾—åˆ†ï¼š</strong>${essayScore}ï¼ˆåŒ¹é…å…³é”®è¯ï¼š${match}ï¼‰</td></tr></tbody>
    </table>`;

  return html;
}
/**
 * âœ… è¡¥å……æŒ‰é’®åŠŸèƒ½ï¼šç‚¹å‡»â€œå‘é€è¯„ä¼°ç»“æœåˆ°é‚®ç®±â€æ—¶è§¦å‘
 * - è‡ªåŠ¨å¯¼å‡ºå®Œæˆé¡µ PDF
 * - æ„å»ºé‚®ä»¶è¡¨æ ¼å†…å®¹å¹¶é€šè¿‡ EmailJS å‘é€
 */
async function handleScreenshotAndEmail() {
  try {
    const answers = collectAnswers(); // âœ… è·å–å½“å‰ç­”é¢˜å†…å®¹ï¼ˆä½ å·²å®ç°è¯¥å‡½æ•°ï¼‰
    const userName = answers.userInfo.name || 'åŒ¿åç”¨æˆ·';

    // âœ… ä½¿ç”¨ html2pdf å¯¼å‡ºå®Œæˆé¡µ
    const completePage = document.getElementById("completePage");
    await html2pdf().from(completePage).set({
      margin: 0,
      filename: `EE-Wè¯„æµ‹ç»“æœ_${userName}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).save();

    // âœ… æ„å»ºé‚®ä»¶å†…å®¹
    const tableHTML = generateEmailTableHTML(answers);
    const templateParams = {
      company: answers.userInfo.company,
      user_name: userName,
      phone: answers.userInfo.phone,
      user_email: answers.userInfo.email,
      timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
      message: 'ç³»ç»Ÿè‡ªåŠ¨æäº¤ï¼šEE-Wäº§å“åŸ¹è®­ç­”å·ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰',
      table_html: tableHTML
    };

    // âœ… å‘é€é‚®ä»¶ï¼ˆEmailJS æ–¹å¼ï¼‰
    emailjs.send('service_csl8frv', 'template_0v2mqw9', templateParams)
      .then(() => alert("âœ… é‚®ä»¶å·²æˆåŠŸå‘é€ï¼"))
      .catch(err => {
        console.error("[EmailJS] é‚®ä»¶å‘é€å¤±è´¥ï¼š", err);
        //alert("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ï¼");
        showEmailResultPopup("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡æ–°å‘é€ï¼Ÿ");
      });

  } catch (err) {
    console.error("[å‘é€é”™è¯¯]ï¼š", err);
    alert("âŒ å‡ºç°é”™è¯¯ï¼Œæ— æ³•å®Œæˆæ“ä½œï¼Œè¯·ç¨åé‡è¯•ï¼");
  }
}

/**
 * âœ… ç”¨æˆ·ç‚¹å‡»â€œå¼€å§‹è¯„æµ‹â€æ—¶ï¼Œå¼¹å‡ºç¡®è®¤æ¡†
 */
 function confirmStartEvaluation() {
  if (confirm("æ‚¨ç¡®å®šå¼€å§‹è¿›è¡Œè¯„æµ‹å—ï¼Ÿ\næäº¤åå°†è‡ªåŠ¨æ¨é€ç»™ Armstrong RSEC éƒ¨é—¨ï¼Œå¹¶å¯¼å‡º PDFã€‚")) {
    // âœ… ç»§ç»­ä¸‹ä¸€æ­¥ï¼šåŠ¨æ€å£ä»¤éªŒè¯ + é‚®ä»¶æ¨é€
    const stored = sessionStorage.getItem("userAnswers");
    if (!stored) {
      alert("âš ï¸ æ— æ³•è·å–ç­”é¢˜æ•°æ®ï¼Œè¯·é‡æ–°æäº¤ï¼");
      return;
    }
    const answers = JSON.parse(stored);
    sessionStorage.setItem("hasEvaluated", "true"); // âœ… è®¾ç½®æ ‡å¿—ï¼šå·²è¯„æµ‹
    // ğŸ‘‰ æ‰§è¡ŒåŠ¨æ€å£ä»¤éªŒè¯é€»è¾‘ï¼ˆä¸‹ä¸€æ­¥å°†è¡¥å……ï¼‰
    promptPasswordAndSend(answers);
  } else {
    // âŒ ç”¨æˆ·å–æ¶ˆï¼Œä»€ä¹ˆéƒ½ä¸åš
    alert("å·²å–æ¶ˆè¯„æµ‹ï¼Œæ‚¨å¯ç»§ç»­æ£€æŸ¥ç­”é¢˜å†…å®¹ã€‚");
  }
}

/**
 * âœ… è¿”å›ç­”é¢˜é¡µé€»è¾‘ï¼ˆä»…åœ¨æœªå¼€å§‹è¯„æµ‹å‰å¯ç”¨ï¼‰
 */
 function returnToTestPage() {
  // å¦‚æœå·²ç»å¼€å§‹è¯„æµ‹ï¼Œå°±ä¸å…è®¸è¿”å›
  if (sessionStorage.getItem('hasEvaluated') === 'true') {
    alert('âš ï¸ æ‚¨å·²å®Œæˆè¯„æµ‹ï¼Œå¸¦æœ‰å®Œæˆæ—¶é—´çš„ç»“æœå·²ç»å‘é€å‡ºå»ï¼Œæ— æ³•è¿”å›ä¿®æ”¹ç­”å·ï¼');
    return;
  }

  // è·³è½¬å› testPage
  showPage('testPage');

  // æ¸…é™¤æ‰€æœ‰é¢˜ç›®ç­”æ¡ˆï¼Œåªä¿ç•™å­¦å‘˜ä¿¡æ¯
  document.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked').forEach(el => el.checked = false);
  document.getElementById('essay').value = '';

  // âœ… å¯é€‰ï¼šé‡ç½®æ»šåŠ¨åˆ°é¡¶éƒ¨
  window.scrollTo(0, 0);
}

// âœ… ç”¨æˆ·ç‚¹å‡»â€œå¼€å§‹è¯„æµ‹â€æŒ‰é’®åçš„ç¡®è®¤æç¤º
function startEvaluationPrompt() {
  // ä½¿ç”¨åŸç”Ÿ confirm ç®€æ´å®ç°ï¼Œä¹Ÿå¯ä»¥æ”¹ä¸º modal é£æ ¼
  const confirmed = confirm("æ‚¨ç¡®å®šè¦å¼€å§‹è¿›è¡Œè¯„æµ‹å—ï¼Ÿ\nè¯„æµ‹åå°†è‡ªåŠ¨å¯¼å‡º PDFï¼Œå¹¶å‘é€ç»“æœè‡³ Armstrong RSECã€‚");
  if (confirmed) {
    // ç”¨æˆ·ç‚¹å‡»â€œæ˜¯â€åï¼Œè¿›å…¥åŠ¨æ€å£ä»¤éªŒè¯æµç¨‹
    promptPasswordAndSend(); // ä¸‹ä¸€æ­¥å®šä¹‰
  } else {
    // å¦åˆ™ä¸åšä»»ä½•æ“ä½œï¼Œåœç•™åœ¨å®Œæˆé¡µ
    alert("å·²å–æ¶ˆè¯„æµ‹æ“ä½œã€‚æ‚¨ä»å¯æ£€æŸ¥ç­”é¢˜å†…å®¹ã€‚");
  }
}

// âœ… ç‚¹å‡»â€œå¼€å§‹è¯„æµ‹â€æŒ‰é’®æ—¶çš„å…¥å£
function onStartEvaluationClick() {
  if (confirm("æ‚¨ç¡®å®šå¼€å§‹è¿›è¡Œè¯„æµ‹å—ï¼Ÿ\n\nä¸€æ—¦å¼€å§‹ï¼Œå°†æ— æ³•è¿”å›æµ‹è¯•é¡µï¼Œå¹¶ä¼šå¯¼å‡º PDFã€æ¨é€ç»“æœåˆ° Armstrong RSECã€‚")) {
    // ç”¨æˆ·ç‚¹å‡»â€œæ˜¯â€ï¼Œç»§ç»­å¼¹å‡ºåŠ¨æ€éªŒè¯ç 
    promptPasswordAndSend();
  } else {
    // ç”¨æˆ·ç‚¹å‡»â€œå¦â€ï¼Œä»€ä¹ˆä¹Ÿä¸åš
    return;
  }
}

// âœ… åŠ¨æ€éªŒè¯ç éªŒè¯ + åˆ†æ”¯å¤„ç†
function promptPasswordAndSend() {
  const code = prompt("è¯·è¾“å…¥åŠ¨æ€å£ä»¤ï¼ˆå¦‚ç”± RSEC éƒ¨é—¨æä¾›ï¼‰ï¼š");

  if (!code) return alert("æœªè¾“å…¥éªŒè¯ç ï¼Œæ“ä½œå·²å–æ¶ˆã€‚");

  if (code === "AFT2025") {
    // âœ… éªŒè¯æˆåŠŸï¼Œæ‰§è¡Œå…¨éƒ¨é€»è¾‘
    const answers = collectAnswers();
    renderAssessmentResult(answers); // æ¸²æŸ“å®Œæˆé¡µ
    exportPDF(answers);              // å¯¼å‡º PDF
    sendEmailResult(answers);        // å‘é€é‚®ä»¶
    evaluationStarted = true;
  } else {
    // âŒ éªŒè¯å¤±è´¥ï¼Œåªå¯¼å‡º PDF å¹¶æé†’
    const answers = collectAnswers();
    evaluationStarted = true;
    renderAssessmentResult(answers);
    exportPDF(answers);
    alert("åŠ¨æ€éªŒè¯ç é”™è¯¯ï¼Œä»…å¯¼å‡º PDFï¼Œæœªå‘é€é‚®ä»¶ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚");
  }
}

function exportPDF(answers) {
  const userName = answers.userInfo.name || 'åŒ¿åç”¨æˆ·';
  const completePage = document.getElementById("completePage");
  html2pdf().from(completePage).set({
  margin: [10, 10, 10, 10],
  filename: `EE-Wè¯„æµ‹ç»“æœ_${userName}.pdf`,
  image: { type: 'jpeg', quality: 0.98 },
  html2canvas: {
    scale: 2,          // ä¿è¯æ¸…æ™°
    useCORS: true,
    scrollX: 0,
    scrollY: 0,
    windowWidth: completePage.scrollWidth, // âœ¨ åŠ è¿™ä¸ª
    windowHeight: completePage.scrollHeight // âœ¨ åŠ è¿™ä¸ª
  },
  jsPDF: {
    unit: 'mm',
    format: 'a4',
    orientation: 'portrait'
  }
}).save();
}

function sendEmailResult(answers) {
  const tableHTML = generateEmailTableHTML(answers);

  const templateParams = {
    company: answers.userInfo.company,
    user_name: answers.userInfo.name,
    phone: answers.userInfo.phone,
    user_email: answers.userInfo.email,
    timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
    message: 'ç³»ç»Ÿè‡ªåŠ¨æäº¤ï¼šEE-Wäº§å“åŸ¹è®­ç­”å·',
    table_html: tableHTML
  };

  // âœ… è°ƒç”¨ EmailJS
  emailjs.send('service_csl8frv', 'template_0v2mqw9', templateParams)
    .then(() => {
        console.log("âœ… é‚®ä»¶å‘é€æˆåŠŸ");
        alert("âœ… è¯„æµ‹ç»“æœå·²æˆåŠŸå‘é€è‡³ RSEC é‚®ç®±ï¼");
      })
    .catch(err => {
        console.error('[EmailJS] é‚®ä»¶å¤±è´¥', err);
        //alert('âš ï¸ é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·å°†å¯¼å‡ºçš„ PDF æ‰‹åŠ¨å‘é€åˆ° RSEC é‚®ç®±ï¼šrsec@armstrong.com');
        showEmailResultPopup("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡æ–°å‘é€ï¼Ÿ");
      });
}

function onReturnToTestPage() {
  if (evaluationStarted) {
    alert("âš ï¸ è¯„æµ‹å·²å¼€å§‹ï¼Œæ— æ³•è¿”å›ç­”é¢˜é¡µï¼");
    return;
  }

  // âœ… æ¸…é™¤ç­”é¢˜å†…å®¹ï¼ˆä¿ç•™å­¦å‘˜ä¿¡æ¯ï¼‰
  const answers = collectAnswers();
  // æ¸…ç©ºé€‰é¡¹å’Œç®€ç­”é¢˜å†…å®¹ï¼ˆâš ï¸ æ³¨é‡Šä»¥ä¸‹ä¸¤è¡Œå³å¯ä¿ç•™ç­”é¢˜è®°å½•ï¼‰
  //document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => input.checked = false);
  //document.getElementById('essay').value = '';

  showPage('testPage');
  document.getElementById('company').value = answers.userInfo.company;
  document.getElementById('name').value = answers.userInfo.name;
  document.getElementById('email').value = answers.userInfo.email;
  document.getElementById('phone').value = answers.userInfo.phone;
}

// ğŸ§© æ˜¾ç¤ºé‚®ä»¶é‡è¯•å¼¹çª—
function showRetryModal() {
  document.getElementById("emailRetryModal").classList.remove("hidden");
}

// ğŸ§© å…³é—­å¼¹çª—
function closeRetryModal() {
  document.getElementById("emailRetryModal").classList.add("hidden");
}

// ğŸ§© ç‚¹å‡»é‡è¯•æŒ‰é’®æ—¶ï¼Œé‡æ–°åˆå§‹åŒ–å¹¶æ¨é€é‚®ä»¶
console.log("ç»‘å®š retryEmailBtn...");
const btn = document.getElementById("retryEmailBtn");
console.log("retryEmailBtn =", btn);

if (btn) {
  btn.addEventListener("click", () => {
    closeRetryModal();

    if (window.emailjs) {
      try {
        emailjs.init("LoQCI3C98dk3FgEvj");
      } catch (e) {
        console.error("EmailJS åˆå§‹åŒ–å¤±è´¥", e);
      }
    }

    handleEmailSendAgain();
  });
} else {
  console.warn("âš ï¸ æ²¡æœ‰æ‰¾åˆ° #retryEmailBtnï¼Œè·³è¿‡ç»‘å®š");
}


// âœ… é‡æ–°åˆå§‹åŒ– EmailJSï¼ˆé¿å…æ¨é€å¤±è´¥åå¡æ­»ï¼‰
function reinitializeEmailJS() {
  if (window.emailjs) {
    try {
      emailjs.init("LoQCI3C98dk3FgEvj");  // ä½ çš„ Public Key
      console.log("âœ… EmailJS å·²é‡æ–°åˆå§‹åŒ–");
    } catch (err) {
      console.error("âŒ EmailJS åˆå§‹åŒ–å¤±è´¥", err);
    }
  } else {
    console.error("âš ï¸ EmailJS æ¨¡å—æœªåŠ è½½");
  }
}

// âœ… é‡è¯•æŒ‰é’®ç»‘å®šçš„å‡½æ•°
function retryEmailSend() {
  hideEmailResultPopup();  // å…ˆå…³é—­å¼¹çª—
  reinitializeEmailJS();   // é‡æ–°åˆå§‹åŒ–
  setTimeout(() => {
    handleExportWithPDFAndEmail(); // å†æ¬¡æ‰§è¡Œå¯¼å‡ºå’Œæ¨é€
  }, 200);  // ç¨ç­‰200msï¼Œé¿å…åˆå§‹åŒ–æœªå®Œæˆ
}


// âœ… ç”¨äºæ˜¾ç¤ºé‚®ä»¶å‘é€ç»“æœå¼¹çª—ï¼Œå¹¶æ”¯æŒé‡è¯•é€»è¾‘
function showEmailResultPopup(message) {
  // æ„å»ºå¼¹çª— HTML
  const modalHTML = `
    <div id="emailResultPopup" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-[300px] text-center fade-in-bounce">
        <p class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">${message}</p>
        <div class="flex justify-center gap-4">
          <button id="retrySendBtn" class="bg-blue-600 text-white px-4 py-1.5 rounded hover:bg-blue-700">æ˜¯</button>
          <button id="cancelSendBtn" class="bg-gray-300 text-gray-800 px-4 py-1.5 rounded hover:bg-gray-400">å¦</button>
        </div>
      </div>
    </div>
  `;

  // æ’å…¥å¼¹çª—
  document.body.insertAdjacentHTML('beforeend', modalHTML);

  // âœ… ç»‘å®šæŒ‰é’®äº‹ä»¶
  document.getElementById('retrySendBtn').onclick = () => {
    document.getElementById('emailResultPopup').remove();

    // âœ… é‡åˆå§‹åŒ– EmailJSï¼ˆç¡®ä¿çŠ¶æ€æ¸…ç©ºï¼‰
    emailjs.init("LoQCI3C98dk3FgEvj");

    // âœ… é‡æ–°å‘é€ï¼ˆè°ƒç”¨ä½ å·²æœ‰çš„ä¸»å‘é€å‡½æ•°ï¼‰
    try {
      handleExportWithPDFAndEmail(true); // åŠ ä¸€ä¸ªå‚æ•°æ ‡è¯†é‡è¯•
    } catch (err) {
      alert("é‚®ä»¶å†æ¬¡å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚");
    }
  };

  document.getElementById('cancelSendBtn').onclick = () => {
    document.getElementById('emailResultPopup').remove();
  };
}




 </script>
 <!--  By Martin æ­¤å¤„æ˜¯æ ¸å¿ƒå‡½æ•°åŠåŠŸèƒ½çš„ä»£ç  ç»“å°¾ -->

<script>
// âœ… éšæœºæ‰“ä¹±åˆ†å¸ƒ 30Â° ç»Ÿä¸€å€¾æ–œæ°´å°
document.addEventListener("DOMContentLoaded", () => {
  const COUNT = 30; // æ°´å°ä¸ªæ•°
  for (let i = 0; i < COUNT; i++) {
    const wm = document.createElement("div");
    wm.className = "watermark-random";
    wm.style.top = `${Math.random() * 120 - 10}vh`;
    wm.style.left = `${Math.random() * 120 - 10}vw`;
    wm.style.transform = `rotate(30deg) scale(${0.7 + Math.random() * 0.6})`;
    document.body.appendChild(wm);
  }
});
</script>

<!-- ğŸ” åŠ¨æ€å£ä»¤å¼¹çª— -->
<div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md w-full max-w-sm text-center">
    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">è¯·è¾“å…¥åŠ¨æ€å£ä»¤ä»¥å‘é€è¯„æµ‹ç»“æœè‡³é‚®ç®±</h3>
    <input id="passwordInput" type="password" placeholder="è¯·è¾“å…¥å£ä»¤..." 
           class="w-full p-2 border rounded-md mb-4 focus:outline-none focus:ring focus:border-blue-300" />
    <div class="flex justify-between space-x-4">
      <button onclick="confirmPassword(true)" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded">ç¡®å®š</button>
      <button onclick="confirmPassword(false)" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white py-2 rounded">è·³è¿‡å‘é€</button>
    </div>
  </div>
</div>

<!-- âœ… å€’è®¡æ—¶æš‚åœæç¤ºé®ç½© -->
<div id="countdownCenterOverlay" class="hidden fixed inset-0 flex">
  <div class="text-center">
    <p>å½“å‰è€ƒè¯•å·²æš‚åœ</p>
    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯æ¢å¤è€ƒè¯•</p>
    <button onclick="resumeFromCenterOverlay()">ç»§ç»­ç­”é¢˜</button>
  </div>
</div>

<script>
  // âœ… é¡µé¢åŠ è½½åè‡ªåŠ¨è§¦å‘å€’è®¡æ—¶å‡½æ•°
  document.addEventListener("DOMContentLoaded", function () {
    startTimer(); // è‡ªåŠ¨å¯åŠ¨å€’è®¡æ—¶
  });
</script>

<!-- é‚®ä»¶é‡è¯•å¼¹çª— -->
<div id="emailRetryModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-80 text-center shadow-lg">
    <p class="text-lg font-semibold text-gray-900 dark:text-white mb-4">é‚®ä»¶å‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡è¯•ï¼Ÿ</p>
    <div class="flex justify-center gap-4">
      <!-- é‚®ä»¶å¤±è´¥å¼¹çª—æŒ‰é’® -->
    <button id="retryEmailBtn" onclick="retryEmailSend()" class="bg-green-500 hover:bg-green-600 ...">
      æ˜¯ï¼Œé‡æ–°å‘é€
    </button>
    <button id="retryEmailBtn" onclick="hideEmailResultPopup()" class="bg-gray-400 hover:bg-gray-500 ...">
      å¦ï¼Œæš‚ä¸å‘é€
    </button>
    </div>
  </div>
</div>

<!-- âœ… é¡µé¢å¿ƒè·³æœºåˆ¶è„šæœ¬ï¼ˆæ–°å¢ï¼‰ -->
    <!-- âœ… é¡µé¢åº•éƒ¨ï¼Œåœ¨ 
<!-- PapaParse CSV åŠ è½½ + åŠ¨æ€é¢˜ç›®å¡«å……è„šæœ¬ï¼ˆåŒ¹é…ä¸­æ–‡å­—æ®µï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  // é˜²æ­¢å˜é‡é‡å¤å£°æ˜
  if (typeof currentLang === 'undefined') {
    var currentLang = 'zh';  // é»˜è®¤è¯­è¨€
  }

// åŠ è½½ CSV å¹¶å¡«å……æ‰€æœ‰é¢˜å‹
function loadQuestionsFromCSV(csvPath) {
  Papa.parse(csvPath, {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data;

      // ========== 1. å•é€‰é¢˜ =========
      
      

      // ========== 2. å¤šé€‰é¢˜ =========
      
      

      // ========== 3. åˆ¤æ–­é¢˜ =========
      

      // ========== 4. ç®€ç­”é¢˜ =========
      const short = data.filter(q => q['é¢˜å‹'] === 'ç®€ç­”é¢˜');
      if (short.length > 0) {
        const q = short[0];
        const container = document.querySelector(`#short1`);
        if (container) {
          const title = currentLang === 'en' ? q['English Question'] : q['ä¸­æ–‡é¢˜å¹²'];
          container.querySelector('h3').textContent = title;
        }
      }
    }
  });
}

// é¡µé¢åŠ è½½åè‡ªåŠ¨æ‰§è¡Œ
window.addEventListener("DOMContentLoaded", () => {
  loadQuestionsFromCSV("/static/csv/EE-W.csv");
});

// è¯­è¨€åˆ‡æ¢å‡½æ•°ï¼ˆé€šè¿‡æŒ‰é’®è°ƒç”¨ï¼‰
function switchLanguage(lang) {
  currentLang = lang;
  loadQuestionsFromCSV("/static/csv/EE-W.csv");
}
</script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  if (typeof currentLang === 'undefined') var currentLang = 'zh';
  document.addEventListener("DOMContentLoaded", function () {
    Papa.parse("/static/csv/EE-W.csv", {
      download: true,
      header: true,
      complete: function (results) {
        const data = results.data;
        // âœ… å•é€‰é¢˜æ¸²æŸ“
        data.filter(q => q['é¢˜å‹'] === 'å•é€‰é¢˜').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#q${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['ä¸­æ–‡é¢˜å¹²'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D'].forEach(opt => {
            const label = container.querySelector(`label[for="q${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="radio" id="q${index}-${opt}" name="q${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });
        // âœ… å¤šé€‰é¢˜æ¸²æŸ“
        data.filter(q => q['é¢˜å‹'] === 'å¤šé€‰é¢˜').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#multi${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['ä¸­æ–‡é¢˜å¹²'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D', 'E', 'F'].forEach(opt => {
            const label = container.querySelector(`label[for="m${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="checkbox" id="m${index}-${opt}" name="multi${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });
        // âœ… åˆ¤æ–­é¢˜æ¸²æŸ“
        data.filter(q => q['é¢˜å‹'] === 'åˆ¤æ–­é¢˜').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#jq${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['ä¸­æ–‡é¢˜å¹²'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
        });
        // âœ… ç®€ç­”é¢˜æ¸²æŸ“
        const short = data.find(q => q['é¢˜å‹'] === 'ç®€ç­”é¢˜');
        const container = document.querySelector("#short1");
        if (short && container) {
          const title = currentLang === 'en' ? short['English Question'] : short['ä¸­æ–‡é¢˜å¹²'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = title;
        }
      },
      error: function (err) {
        console.error("âŒ é¢˜åº“åŠ è½½å¤±è´¥ï¼š", err);
      }
    });
  });
</script>

    <script>
      let lastActivityTime = Date.now();
  
      // è®°å½•äººå·¥æ“ä½œäº‹ä»¶æ—¶é—´
      const recordActivity = () => {
      lastActivityTime = Date.now();
      };
  
      // âœ… ç»‘å®šæ‰€æœ‰äººå·¥æ“ä½œäº‹ä»¶ï¼ˆç‚¹å‡»ã€æ»šåŠ¨ã€è¾“å…¥ç­‰ï¼‰
      ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
      document.addEventListener(evt, recordActivity);
      });
  
      // âœ… æ¯åˆ†é’Ÿå‘é€å¿ƒè·³è¯·æ±‚ï¼Œä»…åœ¨ç”¨æˆ·1åˆ†é’Ÿå†…æœ‰æ“ä½œæ—¶æ‰å‘é€
      setInterval(() => {
      if (Date.now() - lastActivityTime < 60000) {
          fetch('/heartbeat')
          .then(res => {
              if (res.status === 440) {
              alert("ç™»å½•å·²è¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•ï¼");
              window.location.href = "/login";
              }
          })
          .catch(() => {});
      }
      }, 60000);
  </script>




<!-- âœ… ç™»å½•å¼¹çª— -->
<div id="loginOverlay" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-xs shadow-xl">
    <h2 class="text-lg font-bold text-center mb-4">ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•</h2>
    <input id="reLoginUser" class="w-full mb-3 px-4 py-2 rounded-md bg-gray-100 dark:bg-gray-700" placeholder="ç”¨æˆ·å">
    <input id="reLoginPass" type="password" class="w-full mb-3 px-4 py-2 rounded-md bg-gray-100 dark:bg-gray-700" placeholder="å¯†ç ">
    <button onclick="submitRelogin()" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">é‡æ–°ç™»å½•</button>
  </div>
</div>

<!-- é¡µé¢æœ«å°¾ -->
<script>
  function showLoginOverlay() {
    document.getElementById("loginOverlay").classList.remove("hidden");
  }
  
  async function submitRelogin() {
    const username = document.getElementById("reLoginUser").value.trim();
    const password = document.getElementById("reLoginPass").value.trim();
  
    const res = await fetch("/login", {
      method: "POST",
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ username, password })
    });
  
    if (res.redirected) {
      location.reload();  // âœ… ç™»å½•æˆåŠŸååˆ·æ–°é¡µé¢ç»§ç»­ä½¿ç”¨
    } else {
      alert("é‡æ–°ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åæˆ–å¯†ç ");
    }
  }

  document.getElementById("reLoginPass").addEventListener("keyup", function (e) {
      if (e.key === "Enter") {
          submitRelogin();
      }
  });
  </script>

  <!-- å…³é—­ç™»å½•å¼¹çª— -->
  <script>
      function closeLoginOverlay() {
          document.getElementById("loginOverlay").classList.add("hidden");
      }
  </script>



<!-- âœ… ç»Ÿä¸€ PapaParse åŠ è½½ä¸é¢˜ç›®æ¸²æŸ“å…¥å£ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  if (typeof currentLang === 'undefined') var currentLang = 'zh';

  document.addEventListener("DOMContentLoaded", function () {
    Papa.parse("/static/csv/EE-W.csv", {
      download: true,
      header: true,
      complete: function (results) {
        const data = results.data;

        // âœ… å•é€‰é¢˜æ¸²æŸ“
        data.filter(q => q['é¢˜å‹'] === 'å•é€‰é¢˜').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#q${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['ä¸­æ–‡é¢˜å¹²'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D'].forEach(opt => {
            const label = container.querySelector(`label[for="q${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="radio" id="q${index}-${opt}" name="q${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });

        // âœ… å¤šé€‰é¢˜æ¸²æŸ“
        data.filter(q => q['é¢˜å‹'] === 'å¤šé€‰é¢˜').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#multi${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['ä¸­æ–‡é¢˜å¹²'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D', 'E', 'F'].forEach(opt => {
            const label = container.querySelector(`label[for="m${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="checkbox" id="m${index}-${opt}" name="multi${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });

        // âœ… åˆ¤æ–­é¢˜æ¸²æŸ“
        data.filter(q => q['é¢˜å‹'] === 'åˆ¤æ–­é¢˜').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#jq${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['ä¸­æ–‡é¢˜å¹²'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
        });

        // âœ… ç®€ç­”é¢˜æ¸²æŸ“
        const short = data.find(q => q['é¢˜å‹'] === 'ç®€ç­”é¢˜');
        const container = document.querySelector("#short1");
        if (short && container) {
          const title = currentLang === 'en' ? short['English Question'] : short['ä¸­æ–‡é¢˜å¹²'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = title;
        }
      },
      error: function (err) {
        console.error("âŒ é¢˜åº“åŠ è½½å¤±è´¥ï¼š", err);
      }
    });
  });
</script>

<!-- âœ… åŠ è½½ CSV é¢˜åº“å¹¶æ¸²æŸ“ -->
<script src="/static/common/render.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // åŠ è½½å¹¶æ¸²æŸ“ CSV é¢˜ç›®ï¼ŒEE-W ä¸ºé»˜è®¤é¢˜åº“è·¯å¾„
    loadCSVAndRender("/static/csv/EE-W.csv", "zh");
  });
</script>

<!-- âœ… é€šç”¨æ¨¡æ€å¼¹çª—æ¨¡æ¿ -->
<div id="universalModal" class="fixed z-50 inset-0 overflow-y-auto bg-gray-800 bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white dark:bg-gray-900 p-6 rounded-lg shadow-lg w-full max-w-md text-center">
    <h2 id="modalTitle" class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">æç¤ºæ ‡é¢˜</h2>
    <p id="modalMessage" class="text-gray-700 dark:text-gray-300 mb-6">æç¤ºå†…å®¹æ–‡æœ¬ï¼Œå¯æ ¹æ®å®é™…å†…å®¹åŠ¨æ€è®¾ç½®</p>

    <!-- å¯é€‰è¾“å…¥æ¡†ï¼ˆä¾‹å¦‚åŠ¨æ€å£ä»¤ï¼‰ -->
    <input
      id="modalInput"
      class="bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded p-2 w-full mb-4 hidden"
      type="text"
      placeholder="è¯·è¾“å…¥å†…å®¹"
    />

    <div class="flex justify-end gap-4">
      <button id="modalConfirmBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
        ç¡®å®š
      </button>
      <button onclick="closeUniversalModal()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">
        å–æ¶ˆ
      </button>
    </div>
  </div>
</div>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const html = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
  
    // ä» localStorage æ¢å¤ä¸»é¢˜
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      html.classList.add('dark');
      console.log('[Init] æ¢å¤ä¸º dark æ¨¡å¼');
    } else if (savedTheme === 'light') {
      html.classList.remove('dark');
      console.log('[Init] æ¢å¤ä¸º light æ¨¡å¼');
    } else {
      // é¦–æ¬¡è®¿é—®æ—¶è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿä¸»é¢˜
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      html.classList.toggle('dark', prefersDark);
      localStorage.setItem('theme', prefersDark ? 'dark' : 'light');
    }
  
    // âœ… ç‚¹å‡»æŒ‰é’®åˆ‡æ¢æ˜æš—æ¨¡å¼
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const isDark = html.classList.contains('dark');
        html.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
      });
    }
  });
</script>

<script>
  function positionCountdownBar() {
    const nav = document.getElementById("mainNavbar");
    const bar = document.getElementById("examStatusBar");

    if (nav && bar) {
      const navRect = nav.getBoundingClientRect();
      const scrollY = window.scrollY || window.pageYOffset;

      // ğŸ§  è®¡ç®—å¯¼èˆªæ åº•éƒ¨ç›¸å¯¹æ•´ä¸ªé¡µé¢çš„å®é™…ä½ç½®
      const navBottom = navRect.bottom + scrollY;

      // âœ… è®¾ç½®å€’è®¡æ—¶æ  top = å¯¼èˆªæ åº• + 8px é—´è·
      bar.style.top = `${navBottom + 0}px`;
    }
  }

  // âœ… é¡µé¢åŠ è½½å®Œæˆåå®šä½ä¸€æ¬¡
  window.addEventListener("DOMContentLoaded", positionCountdownBar);
  // âœ… æµè§ˆå™¨å°ºå¯¸å˜åŒ–æ—¶é‡æ–°å®šä½
  window.addEventListener("resize", positionCountdownBar);
</script>

</div>
</body>
</html>
