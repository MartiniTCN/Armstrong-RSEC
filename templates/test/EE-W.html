<!DOCTYPE html>
<html lang="zh-CN" class="">
  <!-- ✅ html2pdf.js CDN：用于将页面导出为 PDF -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EE-W 产品培训测试系统</title>
    

    <script>
      tailwind.config = {
        darkMode: 'class', // ✅ 在这里设置
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="/static/common/style.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- ✅ csv 解析库 -->


	<!-- ✅ 🆕 立即加上这段，开启 dark 模式支持 -->



<style>
  /* ✅ 避免分页时拆行 */
  tr {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
  }

  /* ✅ 完整内容居中，防止边缘溢出 */
  #completePage {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
  }

  /* ✅ 小屏适配：答题页和表格字体适配 */
  @media screen and (max-width: 768px) {
    #completePage {
      font-size: 13px;
    }

    table {
      font-size: 12px;
    }

    td, th {
      padding: 6px 4px;
      word-break: break-word;
    }
  }

  /* ✅ 居中显示倒计时提示 + 按钮 */
#countdownCenterOverlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(6px);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  color: #1f2937; /* text-gray-800 */
  font-size: 18px;
}

#countdownCenterOverlay button {
  margin-top: 1rem;
  padding: 0.5rem 1.5rem;
  border-radius: 9999px;
  background: #16a34a; /* bg-green-600 */
  color: white;
  font-weight: bold;
  border: none;
  cursor: pointer;
}

</style>

<!-- ✅ 正确引入 EmailJS 的浏览器版本 SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  // ✅ 初始化 EmailJS，必须放在引入之后
  (function() {
    emailjs.init("LoQCI3C98dk3FgEvj");
  })();
</script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='common/style.css') }}">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
	
        /* 保持原有所有样式 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        .option-selected { background-color: rgba(59, 130, 246, 0.1); }
        .page { display: none; }
        .active-page { display: block; }
        .input-field-highlight {
            @apply w-full p-2 rounded-md border-2 border-blue-300 shadow-sm 
                   dark:border-blue-500 transition-colors focus:ring-2 
                   focus:ring-blue-500 focus:border-blue-500;
        }
        .question-card {
            @apply p-6 rounded-lg bg-gray-50 dark:bg-gray-700 
                   transition-colors hover:bg-gray-100 dark:hover:bg-gray-600
                   mb-6 border-2 border-transparent;
        }
        .options-grid {
            @apply grid grid-cols-1 md:grid-cols-2 gap-4;
        }
        .option {
            @apply flex items-center p-3 rounded-lg border-2 border-gray-200
                   dark:border-gray-600 cursor-pointer transition-all
                   hover:border-blue-500;
        }
        .option input {
            @apply mr-3;
        }
		.option span {
  color: #1f2937; /* light mode 默认颜色 */
}

.dark .option span {
  color: #e5e7eb; /* dark mode 字体颜色 */
}
        .judge-card {
            @apply p-4 rounded-lg bg-gray-50 dark:bg-gray-700
                   border-2 border-transparent;
        }
        .judge-btn {
            @apply w-12 h-12 flex items-center justify-center rounded-full 
                   border-2 border-gray-300 dark:border-gray-600 
                   hover:border-blue-500 cursor-pointer transition-all;
        }
        .judge-btn i {
            @apply text-xl opacity-0 transition-opacity;
        }
        .judge-btn input:checked ~ i {
            @apply opacity-100;
        }
        .border-red-500 {
            border-color: rgb(239 68 68) !important;
        }
		
 /* ✅ 加入弹出提示动画 */
    .fade-in-bounce {
      animation: fadeInBounce 0.5s ease-out;
    }
    @keyframes fadeInBounce {
      0% { opacity: 0; transform: translateY(-20px); }
      60% { transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
		
/* ✅ 用于动态生成的打乱水印元素样式 */
.watermark-random {
  position: fixed;
  width: 220px;
  height: 220px;
  background-image: url('https://i.stardots.io/armstrong/水印图片 - 金色_副本.png?width=500&rotate=0&blur=0&quality=50');
  background-repeat: no-repeat;
  background-size: contain;
  background-position: center;
  opacity: 0.2;
  z-index: 0;
  pointer-events: none;
}

/* ✅ 页面模糊时使用的样式 */
.blur-overlay {
  filter: blur(5px);
  pointer-events: none;
  user-select: none;
  transition: all 0.3s ease;
}

/* ✅ 倒计时和暂停按钮容器样式 */
#examStatusBar {
  position: fixed;
  top: 18px; /* 稍微离顶部远一点 */
  left: 50%;
  transform: translateX(-50%);
  background-color: #dc2626; /* 红色背景 */
  color: white;
  padding: 0.3rem 1rem; /* ✅ 上下更窄，左右保留 */
  border-radius: 9999px; /* 胶囊形状 */
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  font-size: 0.875rem; /* 稍小字体 */
  font-weight: 600;
  z-index: 9999;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  height: auto;
  line-height: 1;
}

#examStatusBar button {
  background-color: white;
  color: #dc2626;
  font-weight: 600;
  padding: 0.2rem 0.75rem; /* ✅ 更小按钮尺寸 */
  border-radius: 9999px;
  font-size: 0.75rem;
  line-height: 1;
  transition: all 0.2s ease;
}

#examStatusBar button:hover {
  background-color: #fef2f2;
}

@media (max-width: 640px) {
  #examStatusBar {
    top: 50% !important;              /* 居中对齐 */
    left: auto !important;
    right: 0.5rem !important;         /* 靠右 */
    transform: translateY(-50%);      /* 垂直居中 */
    flex-direction: column;           /* 垂直排列：时间在上，按钮在下 */
    padding: 0.5rem 0.8rem;
    font-size: 0.75rem;
    gap: 0.5rem;
    border-radius: 1rem;
    background-color: #dc2626;        /* 红色背景保留 */
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 9999;
  }

  #examStatusBar button {
    padding: 0.3rem 0.75rem;
    font-size: 0.75rem;
  }

  #examStatusBar button span {
    display: inline;
  }
}
    </style>

</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
  
  <div class="page-container">
  <!-- ✅ 动态题目容器（必须有这个 ID） -->
  <!-- <div id="testContainer" class="mt-6 space-y-6"></div> -->

    <!-- 加载遮罩 -->
    <div id="loading" class="fixed inset-0 bg-black/50 z-50 hidden">
        <div class="flex items-center justify-center h-full">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg flex items-center">
                <i class="fas fa-spinner animate-spin text-2xl text-blue-500 mr-3"></i>
                <span class="text-gray-700 dark:text-gray-200">正在生成报告...</span>
            </div>
        </div>
    </div>

  <!-- ✅ 导航栏  -->
  <nav id="mainNavbar"
  class="sticky top-2 mx-auto max-w-7xl bg-white/80 !dark:bg-[#2a2a2a] backdrop-blur border border-gray-200 dark:border-gray-700 z-40 rounded-2xl shadow-md">
  <div class="flex flex-col px-4 py-2 gap-1">

    <!-- ✅ 顶部中间：Logo + 标题 -->
    <div class="flex justify-center items-center gap-2">
      <!-- Logo 缩小 50% -->
      <img
        src="https://i.stardots.io/armstrong/Armstrong%20Logo%20-%20Martin.png?width=500"
        alt="Logo"
        class="h-8 w-auto"
      />
      <!-- 竖线分隔 -->
      <span class="text-gray-400 text-base">｜</span>
      <!-- 测试标题 -->
      <h1
        id="pageTitle"
        class="text-base font-semibold text-gray-800 dark:text-gray-200 tracking-wide"
      >
        EE-W 产品培训测试系统
      </h1>
    </div>

    <!-- ✅ 底部：左侧用户名，右侧切换按钮 -->
    <div class="flex justify-between items-center mt-2 text-sm text-gray-700 dark:text-gray-300">
      
      <!-- 左侧：用户名显示（JS 渲染） -->
      <span id="loggedInUser" class="font-semibold">欢迎：Armstrong</span>

      <!-- 右侧：明暗模式 + 语言切换 -->
      <div class="flex items-center gap-3">
        <!-- 明暗模式切换按钮 -->
        <!-- ✅ 明暗模式切换按钮（统一高度 + 图标居中） -->
        <button
        id="themeToggle"
        class="h-8 w-8 rounded-md bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 
              flex items-center justify-center text-gray-800 dark:text-white 
              hover:bg-gray-100 dark:hover:bg-gray-700 transition-all"
        aria-label="切换明暗模式"
        >
        <i class="fas fa-moon text-sm dark:hidden"></i>
        <i class="fas fa-sun text-sm hidden dark:block"></i>
        </button>

        <!-- ✅ 语言切换按钮（统一尺寸 + 图标居中） -->
        <button
        id="langToggle"
        onclick="toggleLanguage()"
        class="h-8 w-8 rounded-md bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 
              flex items-center justify-center 
              hover:bg-gray-100 dark:hover:bg-gray-700 transition-all"
        aria-label="切换语言"
        >
        <img
          id="languageFlag"
          src="https://flagcdn.com/cn.svg"
          alt="Language"
          class="w-5 h-4"
        />
        </button>
      </div>
    </div>
  </div>
</nav>
    <!-- 倒计时卡片：固定在导航栏下边缘 -->
    <!-- ✅ 倒计时卡片结构：fixed + 正确闭合标签 -->
    <div
    id="examStatusBar"
    class="fixed left-1/2 -translate-x-1/2 z-30 sm:flex hidden px-4 py-2 bg-red-600 text-white text-sm rounded-xl shadow-md"
    style="top: 0px;"
    >
    <i class="fas fa-clock mr-2"></i>
    <span id="countdown">60:00</span>
    <button
      onclick="togglePause()"
      id="pauseBtn"
      class="ml-3 bg-white text-red-600 px-3 py-1 rounded-full hover:bg-red-100 text-xs sm:text-sm"
    >
      <i class="fas fa-pause mr-1"></i><span>暂停</span>
    </button>
    </div>
    <!-- 删除首页 -->

    <!-- 直接进入测试页 -->
    <section id="testPage" class="page active-page container mx-auto px-4 py-6">
	

        <div class="flex justify-between mb-6">
          <a href="/course" class="text-blue-600 dark:text-blue-400 hover:underline">
            <i class="fas fa-arrow-left mr-2"></i>返回课程选择页
          </a>
			<!-- ✅ 错误提示框：嵌入顶部 -->
    <div id="errorMessage"
         class="hidden mb-6 px-6 py-4 rounded-lg text-lg font-semibold text-red-700 bg-red-100 border border-red-400 shadow fade-in-bounce flex items-center gap-3">
      <i class="fas fa-exclamation-triangle"></i>
      <span id="errorText">请完善信息</span>
    </div>
            <div class="text-gray-600 dark:text-gray-300">
                <i class="fas fa-clock mr-2"></i>考试时间：60:00
            </div>
        </div>

        <!-- ✅ 学员信息卡片（优化明暗模式 + 不透明） -->
        <div class="card-darkmode rounded-xl p-6 shadow-md mb-8 transition-colors duration-300">
          <h2 class="text-xl font-semibold mb-6 text-gray-800 !dark:text-gray-100">
            <i class="fas fa-id-card mr-2 text-blue-500"></i>学员信息
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            
            <!-- 公司名称 -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300">
                <span class="text-red-500">*</span> 公司名称
              </label>
              <input type="text" id="company"
                class="bg-white !dark:bg-[#2a2a2a] text-gray-900 !dark:text-gray-100 border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 w-full"
                placeholder="请输入公司全称" required>
            </div>

            <!-- 学员姓名 -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300">
                <span class="text-red-500">*</span> 学员姓名
              </label>
              <input type="text" id="name"
                class="bg-white !dark:bg-[#2a2a2a] text-gray-900 !dark:text-gray-100 border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 w-full"
                placeholder="请输入真实姓名" required>
            </div>

            <!-- 手机号码 -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300">
                <span class="text-red-500">*</span> 手机号码
              </label>
              <input type="tel" id="phone"
                class="bg-white !dark:bg-[#2a2a2a] text-gray-900 !dark:text-gray-100 border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 w-full"
                placeholder="11位手机号码" pattern="[0-9]{11}" required>
            </div>

            <!-- 邮箱地址 -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300">
                <span class="text-red-500">*</span> 邮箱地址
              </label>
              <input type="email" id="email"
                class="bg-white !dark:bg-[#2a2a2a] text-gray-900 !dark:text-gray-100 border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 w-full"
                placeholder="name@company.com"
                pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                required>
            </div>
          </div>
        </div>


        <!-- 单选题 -->
        <div class="bg-white !dark:bg-[#1f1f1f] text-gray-800 !dark:text-gray-100 rounded-xl p-6 shadow-md mb-8 transition-colors duration-300">
          <h2 class="text-xl font-semibold mb-6">
            <i class="fas fa-list-ol mr-2 text-blue-500"></i>单选题（每题2分，共40分）
          </h2>
          <!-- ✅ 单选题挂载区域：PapaParse 渲染的多选题将插入到这里 -->
          <div class="space-y-6" data-section="single"></div>
        </div>

        <!-- ✅ 多选题卡片 -->
        <div class="bg-white !dark:bg-[#1f1f1f] text-gray-800 !dark:text-gray-100 rounded-xl p-6 shadow-md mb-8 transition-colors duration-300">
          <h2 class="text-xl font-semibold mb-6">
            <i class="fas fa-check-square mr-2 text-purple-500"></i>多选题（每题2分，共40分）
          </h2>
          <!-- ✅ PapaParse 渲染的多选题将插入到这里 -->
          <div class="space-y-6" data-section="multi"></div>
        </div>

        <!-- ✅ 判断题卡片 -->
        <div class="bg-white !dark:bg-[#1f1f1f] text-gray-800 !dark:text-gray-100 rounded-xl p-6 shadow-md mb-8 transition-colors duration-300">
          <h2 class="text-xl font-semibold mb-6">
            <i class="fas fa-balance-scale mr-2 text-yellow-500"></i>判断题（每题1分，共20分）
          </h2>
          <!-- ✅ PapaParse 渲染的判断题将插入到这里 -->
          <div class="space-y-6" data-section="judge"></div>
        </div>    
        <!-- ✅ 简答题卡片 -->
        <div class="bg-white !dark:bg-[#1f1f1f] text-gray-800 !dark:text-gray-100 rounded-xl p-6 shadow-md mb-8 transition-colors duration-300">
          <h2 class="text-xl font-semibold mb-6">
            <i class="fas fa-keyboard mr-2 text-pink-500"></i>简答题（共1题，10分）
          </h2>
          <!-- ✅ PapaParse 渲染的简答题将插入到这里 -->
          <div class="space-y-6" data-section="essay"></div>
        </div>

        <!-- 提交按钮 -->
 <div class="flex justify-center mt-8">
  <button onclick="confirmSubmitTest()"
    class="relative inline-flex items-center justify-center px-4 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600
           text-white text-sm font-medium rounded-full shadow-md hover:from-emerald-500 hover:to-green-600
           transform hover:scale-105 transition-all duration-300 ease-in-out group overflow-hidden">
    <span class="relative z-10 flex items-center">
      <i class="fas fa-file-export mr-2 text-white text-base"></i>
      提交答卷
    </span>
    <!-- 💫 光晕动画 -->
    <div class="absolute inset-0 bg-white opacity-10 blur-xl group-hover:opacity-20 transition-all duration-500"></div>
  </button>
</div>

<!-- ✅ 这是你的 testPage 页面末尾的提交按钮 -->


    </section>

  <!-- ✅ 完成页：展示答题详情、学员信息、总分评定 -->
<section id="completePage" class="page container mx-auto px-4 py-8 text-center">
  <div id="resultCard" class="bg-white dark:bg-gray-800 rounded-xl p-8 shadow-sm max-w-4xl mx-auto text-left">
    <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200 flex items-center">
      <i class="fas fa-clipboard-check text-green-500 mr-2"></i>答题评估结果
    </h2>

    <!-- 学员信息与分数展示 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6 text-sm sm:text-base text-gray-700 dark:text-gray-300 break-words">
      <div class="space-y-2">
        <p><strong>公司名称：</strong><span id="resultCompany">-</span></p>
        <p><strong>姓名：</strong><span id="resultName">-</span></p>
        <p><strong>邮箱：</strong><span id="resultEmail">-</span></p>
        <p><strong>电话：</strong><span id="resultPhone">-</span></p>
      </div>
      <div class="sm:text-right space-y-2">
        <p><strong>提交时间：</strong><span id="resultTime">-</span></p>
        <p><strong>总得分：</strong><span id="resultScore" class="text-green-600 dark:text-green-400 text-xl font-bold">-</span> / 100</p>
        <p><strong>评定等级：</strong><span id="resultLevel" class="font-semibold">-</span></p>
      </div>
    </div>

    <!-- 详细答题列表 -->
    <div class="overflow-x-auto">
      <table class="min-w-[680px] table-auto border border-gray-300 dark:border-gray-600 text-xs sm:text-sm">
        <thead class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
          <tr>
            <th class="p-2 border w-20">题型</th>
            <th class="p-2 border w-16">题号</th>
            <th class="p-2 border w-1/4">你的答案</th>
            <th class="p-2 border w-1/4">正确答案</th>
            <th class="p-2 border w-20">得分</th>
          </tr>
        </thead>
        <tbody id="resultTableBody" class="text-gray-700 dark:text-gray-300">
          <!-- JavaScript 渲染内容 -->
        </tbody>
      </table>
    </div>


    <!-- 操作按钮 -->
    <div class="mt-6 text-center">
      <!-- ✅ 返回答题页按钮 -->
      <button onclick="onReturnToTestPage()"
      class="mr-4 px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full shadow-md transition-all">
      <i class="fas fa-arrow-left mr-2"></i>返回答题页
      </button>

      <button onclick="onStartEvaluationClick()"
        class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-full shadow-md transition-all">
        <i class="fas fa-paper-plane mr-2"></i>开始打分
      </button>
    </div>
  </div>

</section>



 <!--  By Martin 此处是核心函数及功能的代码 开始 -->
 <script>
 // ✅ EE-W 产品培训考试系统脚本（整合版）
 // 包含倒计时、答题收集、评估评分、导出 PDF、发送邮件、动态口令等模块
 
 let remainingTime = 60 * 60; // 考试总时长：60分钟
 let timerInterval = null;
 let isPaused = false;
 let evaluationStarted = false; // ✅ 控制是否已开始评测

 let emailjsReady = false;  // ✅ 状态变量：标记是否已加载成功

 let emailSent = false; // ✅ 全局变量：标记邮件是否已发送成功

 const EMAIL_ENABLED = false; // ✅ 控制是否启用邮件发送功能（调试时设为 false）
  
 // ✅ 动态加载 SDK（更灵活稳定）
function loadEmailJS() {
  return new Promise((resolve, reject) => {
    if (window.emailjs) {
      emailjsReady = true;
      resolve(); // 已加载，无需重复
      return;
    }

    const script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
    script.async = true;

    script.onload = () => {
      try {
        emailjs.init("LoQCI3C98dk3FgEvj"); // ✅ 替换为你的 Public Key
        emailjsReady = true;
        resolve();
      } catch (e) {
        console.error("[EmailJS] 初始化失败", e);
        reject(e);
      }
    };

    script.onerror = () => {
      console.error("[EmailJS] 加载失败，可能是网络问题");
      reject(new Error("SDK 加载失败"));
    };

    document.head.appendChild(script);
  });
}


 
 // ⏳ 倒计时更新函数
 function updateCountdown() {
   const min = String(Math.floor(remainingTime / 60)).padStart(2, '0');
   const sec = String(remainingTime % 60).padStart(2, '0');
   document.getElementById('countdown').innerText = `${min}:${sec}`;
 }
 
 // ⏱️ 启动倒计时
 function startTimer() {
   if (timerInterval) clearInterval(timerInterval);
   timerInterval = setInterval(() => {
     if (!isPaused) {
       remainingTime--;
       updateCountdown();
       if (remainingTime <= 0) {
         clearInterval(timerInterval);
         isPaused = true;
         document.getElementById('testPage').classList.add('blur-overlay');
         alert('时间已到，考试结束！');
       }
     }
   }, 1000);
 }
 
 // ⏸️ 暂停 / 恢复
 function togglePause() {
   isPaused = !isPaused;
   const testPage = document.getElementById('testPage');
   const pauseBtn = document.getElementById('pauseBtn');
   if (isPaused) {
     testPage.classList.add('blur-overlay');
     pauseBtn.innerHTML = '<i class="fas fa-play mr-1"></i><span>继续</span>';
   } else {
     testPage.classList.remove('blur-overlay');
     pauseBtn.innerHTML = '<i class="fas fa-pause mr-1"></i><span>暂停</span>';
   }
 }

 let hasEnteredBefore = false; // ✅ 是否首次进入标记
function showTestPage() { // ✅ 切换到考试页面，并启动计时器/清除毛玻璃遮罩/显示“暂停”按钮/启动倒计时（仅首次进入）
  // 切换至考试页面
  showPage('testPage');

  // 启动倒计时（仅在首次进入时）
  if (!timerInterval) {
    startTimer(); // ⏱️ 启动 60 分钟倒计时
  }

  // 清除暂停状态
  if (remainingTime > 0) {
    isPaused = false;
    document.getElementById('testPage').classList.remove('blur-overlay');
    document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause mr-1"></i>暂停';

    if (hasEnteredBefore) {
      // ✅ 非首次进入，显示遮罩提示
      document.getElementById('countdownCenterOverlay').style.display = 'flex';
    }

    hasEnteredBefore = true; // ✅ 设置为已进入
  }
}

 // 📄 页面切换控制
 function showPage(pageId) {
   document.querySelectorAll('.page').forEach(page => {
     page.classList.remove('active-page');
   });
   document.getElementById(pageId).classList.add('active-page');
   window.scrollTo(0, 0);
   if (pageId === 'homePage' || pageId === 'completePage') {
     isPaused = true;
     document.getElementById('testPage').classList.add('blur-overlay');
   }
 }
 
 // document.addEventListener('DOMContentLoaded', updateCountdown);
 
 
 // ✅ 答案收集
function collectAnswers() {
  return {
    // 🧠 基础信息采集
    userInfo: {
      company: document.getElementById('company')?.value || "",
      name: document.getElementById('name')?.value || "",
      phone: document.getElementById('phone')?.value || "",
      email: document.getElementById('email')?.value || ""
    },

    // ✅ 单选题收集（按 name 分组）
    singleChoice: Array.from(document.querySelectorAll('input[type="radio"]:checked'))
      .filter(el => el.name.startsWith('q'))
      .reduce((acc, el) => {
        acc[el.name] = el.value;
        return acc;
      }, {}),

    // ✅ 多选题收集（按 name 分组）
    multipleChoice: Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
      .reduce((acc, el) => {
        const group = el.name.replace('mq', '');
        if (!acc[group]) acc[group] = [];
        acc[group].push(el.value);
        return acc;
      }, {}),

    // ✅ 判断题收集（只选中项）
    judgment: Array.from(document.querySelectorAll('.judge-card input[type="radio"]:checked'))
      .reduce((acc, el) => {
        acc[el.name] = el.value;
        return acc;
      }, {}),

    // ✅ 简答题收集：支持多个 textarea[data-essay-id]
    essay: (() => {
      const result = {};
      document.querySelectorAll("textarea[data-essay-id]").forEach(textarea => {
        const id = textarea.dataset.essayId;
        result[id] = textarea.value.trim();
      });
      return result;
    })()
  };
}

 
 // ✅ 评估评分并渲染完成页
 function renderAssessmentResult(answers) {
   const now = new Date().toLocaleString('zh-CN', { hour12: false });
   document.getElementById('resultCompany').textContent = answers.userInfo.company;
   document.getElementById('resultName').textContent = answers.userInfo.name;
   document.getElementById('resultEmail').textContent = answers.userInfo.email;
   document.getElementById('resultPhone').textContent = answers.userInfo.phone;
   document.getElementById('resultTime').textContent = now;
 
   let totalScore = 0;
   let tbody = document.getElementById('resultTableBody');
   tbody.innerHTML = '';
 
   const createRow = (type, num, your, correct, score) => {
     const row = document.createElement('tr');
     row.innerHTML = `
       <td class="border p-2">${type}</td>
       <td class="border p-2">${num}</td>
       <td class="border p-2">${your}</td>
       <td class="border p-2">${correct}</td>
       <td class="border p-2">${score === 0 ? '✘' : '✔'} ${score}</td>
     `;
     tbody.appendChild(row);
   };
 
   // ✅ 正确答案库
   
 
   // ✅ 单选题（25题 * 2分）
   
 
   // ✅ 多选题（20题 * 1分）
   
 
   // ✅ 判断题（20题 * 1分）
   
 
   // ✅ 简答题评分逻辑（关键词命中）


// ✅ 简答题仅显示用户答案与得分，不显示“正确答案”
const essayRow = document.createElement('tr');
essayRow.innerHTML = `
  <td class="border p-2">简答题</td>
  <td class="border p-2">1</td>
  <td class="border p-2">${answers.essay.slice(0, 30)}...</td>
  <td class="border p-2 text-center text-gray-400 italic">-</td>
  <td class="border p-2">${essayScore === 0 ? '✘' : '✔'} ${essayScore}</td>
`;
tbody.appendChild(essayRow);
totalScore += essayScore;
 
   // ✅ 评定结果显示
   document.getElementById('resultScore').textContent = totalScore;
   document.getElementById('resultLevel').textContent = totalScore >= 80 ? '✅ 合格' : '❌ 不合格';
 }

 // ✅ 导出完成页为 PDF 文件
async function exportResultToPDF(userName = '匿名用户') {
  const completePage = document.getElementById("completePage");

  // ✅ 使用 html2canvas 渲染当前完成页为图片，并插入 PDF 中
  const canvas = await html2canvas(completePage, { scale: 2, useCORS: true });
  const imgData = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(imgData);
  const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;

  pdf.addImage(imgData, "PNG", 0, 0, pageWidth, pdfHeight);
  pdf.save(`EE-W评测结果_${userName}.pdf`);
}


// ✅ 将答题结果生成 HTML 表格用于插入邮件
function buildEmailHTMLTable(answers) {
  const getRow = (type, index, your, correct, score) => `
    <tr>
      <td>${type}</td>
      <td>${index}</td>
      <td>${your}</td>
      <td>${correct}</td>
      <td>${score}</td>
    </tr>`;

  const rows = [];

  const correctAnswers = {
    single: ["B", "C", "A", "B", "D", "C", "C", "B", "B", "B", "D", "C", "C", "B", "C", "B", "C", "B", "B", "B", "C", "D", "D", "B", "B"],
    multiple: [
      ["A", "B", "D"], ["C", "D"], ["A", "B", "C"], ["A", "B", "D"], ["A", "B", "C", "D"],
      ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"], ["A", "B", "C", "D"], ["A", "B", "C", "D"],
      ["A", "B", "D"], ["A", "B", "D"], ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"],
      ["A", "B", "C"], ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"], ["A", "B", "C", "D"]
    ],
    judge: ["true", "false", "false", "true", "true", "false", "true", "true", "false", "true", "false", "true", "false", "true", "false", "true", "true", "false", "true", "false"]
  };

  // 单选题
  for (let i = 1; i <= 25; i++) {
    const key = `q${i}`;
    const your = answers.singleChoice[key] || "-";
    const correct = correctAnswers.single[i - 1];
    const score = (your === correct) ? 2 : 0;
    rows.push(getRow("单选题", i, your, correct, score));
  }

  // 多选题
  for (let i = 1; i <= 20; i++) {
    const key = i.toString();
    const your = (answers.multipleChoice[key] || []).join(", ");
    const correct = correctAnswers.multiple[i - 1].join(", ");
    const score = (your.split(', ').sort().join(',') === correct.split(', ').sort().join(',')) ? 1 : 0;
    rows.push(getRow("多选题", i, your, correct, score));
  }

  // 判断题
  for (let i = 1; i <= 20; i++) {
    const key = `jq${i}`;
    const your = answers.judgment[key] === "true" ? "✔ 正确" : answers.judgment[key] === "false" ? "✘ 错误" : "-";
    const correct = correctAnswers.judge[i - 1] === "true" ? "✔ 正确" : "✘ 错误";
    const score = answers.judgment[key] === correctAnswers.judge[i - 1] ? 1 : 0;
    rows.push(getRow("判断题", i, your, correct, score));
  }

  // 简答题打分
  const keywords = ["传感器", "温度", "差压", "数量", "安装位置", "通信"];
  const match = keywords.filter(k => answers.essay.includes(k)).length;
  let essayScore = 0;
  if (match >= 5) essayScore = 35;
  else if (match >= 3) essayScore = 25;
  else if (match >= 1) essayScore = 10;
  rows.push(getRow("简答题", 1, answers.essay.slice(0, 20) + "...", "(关键词匹配)", essayScore));

  // 返回完整 HTML 表格
  return `
    <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
      <thead style="background-color: #f3f4f6; color: #111">
        <tr><th>题型</th><th>题号</th><th>你的答案</th><th>正确答案</th><th>得分</th></tr>
      </thead>
      <tbody>${rows.join('')}</tbody>
    </table>`;
}


// ✅ EmailJS 邮件发送
function sendResultEmail(answers) {
  if (!EMAIL_ENABLED) {
    console.log("[调试] 邮件功能已禁用，未执行发送。");
    return;
  }

  if (emailSent) {
    console.log("[调试] 邮件已发送，无需重复发送。");
    return;
  }

  const templateParams = {
    company: answers.userInfo.company,
    user_name: answers.userInfo.name,
    phone: answers.userInfo.phone,
    user_email: answers.userInfo.email,
    timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
    message: '来自 EE-W 培训系统的评测结果',
    table_html: buildEmailHTMLTable(answers)
  };

  if (!window.emailjs) {
    const script = document.createElement("script");
    script.src = "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
    script.onload = () => {
      emailjs.init("LoQCI3C98dk3FgEvj");
      emailjs.send("service_csl8frv", "template_0v2mqw9", templateParams)
        .then(() => {
          console.log("✅ 邮件发送成功");
          alert('✅ 邮件已成功发送到 RSEC 邮箱！');
          emailSent = true; // ✅ 设置状态，表示已成功发送
        })
        .catch(err => {
          console.error('[EmailJS] 邮件失败', err);
          //alert('⚠️ 邮件发送失败，请将导出的 PDF 手动发送到 RSEC 邮箱：rsec@armstrong.com');
          showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
        });
    };
    document.head.appendChild(script);
  } else {
    emailjs.init("LoQCI3C98dk3FgEvj");
    emailjs.send("service_csl8frv", "template_0v2mqw9", templateParams)
      .then(() => {
        console.log("✅ 邮件发送成功");
        alert('✅ 邮件已成功发送到 RSEC 邮箱！');
        emailSent = true; // ✅ 设置状态，表示已成功发送
      })
      .catch(err => {
        console.error('[EmailJS] 邮件失败', err);
        //alert('⚠️ 邮件发送失败，请将导出的 PDF 手动发送到 RSEC 邮箱：rsec@armstrong.com');
        showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
      });
  }
}


// ✅ 渲染完成页上用户提交的答案（不包含正确答案与得分）
function renderAnswersOnCompletePage(answers) {
  const now = new Date().toLocaleString('zh-CN', { hour12: false });

  // 填充用户信息
  document.getElementById("resultCompany").textContent = answers.userInfo.company;
  document.getElementById("resultName").textContent = answers.userInfo.name;
  document.getElementById("resultEmail").textContent = answers.userInfo.email;
  document.getElementById("resultPhone").textContent = answers.userInfo.phone;
  document.getElementById("resultTime").textContent = now;

  // 只列出答题内容，不评判正误
  const tbody = document.getElementById("resultTableBody");
  tbody.innerHTML = ""; // 清空原有行

  const createRow = (type, num, yourAnswer) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="border p-2">${type}</td>
      <td class="border p-2">${num}</td>
      <td class="border p-2">${yourAnswer}</td>
      <td class="border p-2 text-gray-400 italic">-</td>
      <td class="border p-2 text-gray-400 italic">-</td>
    `;
    tbody.appendChild(row);
  };

  // 单选题
  for (let i = 1; i <= 25; i++) {
    const key = `q${i}`;
    createRow("单选题", i, answers.singleChoice[key] || "未答");
  }

  // 多选题
  for (let i = 1; i <= 20; i++) {
    const key = i.toString();
    const val = answers.multipleChoice[key] || [];
    createRow("多选题", i, val.join(", ") || "未答");
  }

  // 判断题
  for (let i = 1; i <= 20; i++) {
    const key = `jq${i}`;
    const val = answers.judgment[key];
    const label = val === "true" ? "✔ 正确" : val === "false" ? "✘ 错误" : "未答";
    createRow("判断题", i, label);
  }

  // 简答题
  createRow("简答题", 1, answers.essay.slice(0, 50) + (answers.essay.length > 50 ? "..." : ""));
}

/**
 * ✅ handleExport：考试提交主流程
 * 包含评测、PDF 导出、邮件发送功能（调用 renderAssessmentResult）
 */
 async function handleExport() {
    // 1. 校验必填项
    if (!validateForm()) {
        alert("请完善必填信息和答题内容后再提交！");
        return;
    }

    // 2. 显示 loading 动画（需确保页面中存在 id="loading" 的元素）
    const loading = document.getElementById("loading");
    loading?.classList.remove("hidden");

    try {
        // 3. 模拟延迟，确保 UI 渲染稳定
        await new Promise(resolve => setTimeout(resolve, 300));

        // 4. 收集用户答题
        const answers = collectAnswers();

        // 5. 切换到完成页，开始评测（渲染结果页 + 表格）
        showPage("completePage");
        renderAssessmentResult(answers);
        evaluationStarted = true;

        // 6. 等待 1s，确保完成页加载完毕后再导出 PDF
        setTimeout(() => {
            const completePage = document.getElementById("completePage");
            const userName = answers.userInfo.name || "匿名";
            html2pdf().from(completePage).set({
              margin: [10, 10, 10, 10],
              filename: `EE-W评测结果_${userName}.pdf`,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2, useCORS: true },
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
              pagebreak: { mode: ['css', 'legacy'] }  // ✅ 自动分页
            }).save().then(() => {
                console.log("[PDF] 导出成功");
            }).catch(err => {
                console.error("[PDF] 导出失败", err);
            });
        }, 1000);

        // 7. 构建邮件参数（含答题结果表格）
        const tableHTML = generateEmailTableHTML(answers);
        const templateParams = {
            company: answers.userInfo.company,
            user_name: answers.userInfo.name,
            phone: answers.userInfo.phone,
            user_email: answers.userInfo.email,
            timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
            message: '系统自动提交：EE-W产品培训答卷',
            table_html: tableHTML
        };

        // 8. 加载 emailjs 模块（仅加载一次）
        if (!window.emailjs) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js';
            script.onload = () => {
                emailjs.init('LoQCI3C98dk3FgEvj');
                emailjs.send('service_csl8frv', 'template_0v2mqw9', templateParams)
                    .then(() => console.log("[EmailJS] 邮件发送成功"))
                    .catch(err => {
                        console.error('[EmailJS] 邮件失败', err);
                        alert('⚠️ 邮件发送失败，请将导出的 PDF 手动发送到 RSEC 邮箱：rsec@armstrong.com');
                        showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
                      });
            };
            document.head.appendChild(script);
        } else {
            emailjs.init('LoQCI3C98dk3FgEvj');
            emailjs.send('service_csl8frv', 'template_0v2mqw9', templateParams)
                .then(() => console.log("[EmailJS] 邮件发送成功"))
                .catch(err => {
                        console.error('[EmailJS] 邮件失败', err);
                        //alert('⚠️ 邮件发送失败，请将导出的 PDF 手动发送到 RSEC 邮箱：rsec@armstrong.com');
                        showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
                      });
        }

    } catch (error) {
        console.error("提交失败：", error);
        alert("提交失败，请稍后重试。\n错误信息：" + error.message);
    } finally {
        // 9. 隐藏 loading 动画
        loading?.classList.add("hidden");
    }
}

/**
 * ✅ 表单校验函数：确保所有基本信息与题目都已填写
 * @returns {boolean} 是否通过校验
 */
 // ✅ 临时屏蔽校验逻辑（调试用）
function validateForm() {
  console.warn("[调试模式] 表单验证已跳过");
  return true;
}
// 🔐 弹出动态口令窗口
function promptPasswordAndSend(answers) {
  document.getElementById("passwordModal").classList.remove("hidden");

  // 回调函数：根据用户点击决定是否发送
  window.confirmPassword = async function(sendEmail) {
    const password = document.getElementById("passwordInput").value.trim();
    showUniversalModal("动态验证码", "请输入验证码以发送成绩", true, (val) => {
      if (val === "AFT2025") {
        const html = buildEmailTable();
        sendResultEmail(html);
      } else {
        alert("验证码错误");
      }
});

    // 判断口令有效性（默认正确口令：AFT2025）
    const isValid = password === "AFT2025";
    
    // 无论正确与否，导出 PDF
    await exportResultPDF(answers);

    if (sendEmail && isValid) {
      await sendResultEmail(answers);
    } else if (sendEmail && !isValid) {
      alert("❌ 动态口令错误，未发送邮件，仅导出 PDF。");
    } else {
      alert("✅ 已跳过邮件，仅保存本地 PDF。");
    }
  };
}

// 📄 导出完成页为 PDF
async function exportResultPDF(answers) {
  const page = document.getElementById("completePage");
  const user = answers.userInfo.name || "未命名";
  await html2pdf().from(page).set({
    margin: 0,
    filename: `EE-W评测结果_${user}.pdf`,
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
  }).save();
}

// 📩 构建邮件发送逻辑
async function sendResultEmail(answers) {
  const tableHTML = generateEmailTableHTML(answers);
  const templateParams = {
    company: answers.userInfo.company,
    user_name: answers.userInfo.name,
    phone: answers.userInfo.phone,
    user_email: answers.userInfo.email,
    timestamp: new Date().toLocaleString("zh-CN", { hour12: false }),
    message: "EE-W产品培训自动提交答卷",
    table_html: tableHTML
  };

  try {
    if (!window.emailjs) {
      await new Promise(resolve => {
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
        s.onload = resolve;
        document.head.appendChild(s);
      });
    }
    emailjs.init("LoQCI3C98dk3FgEvj");
    await emailjs.send("service_csl8frv", "template_0v2mqw9", templateParams);
    alert("✅ 邮件已成功发送！");
  } catch (err) {
    console.error("[EmailJS] 邮件发送失败：", err);
    //alert("❌ 邮件发送失败，请稍后重试！");
    showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
  }
}

/**
 * ✅ 封装统一的邮件发送函数，自动加载模块并处理回调
 */
function sendEmailWithTemplate(templateParams, onSuccess = null, onFailure = null) {
  const serviceID = 'service_csl8frv';
  const templateID = 'template_0v2mqw9';
  const publicKey = 'LoQCI3C98dk3FgEvj';

  if (typeof emailjs === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js';
    script.onload = () => {
      emailjs.init(publicKey);
      emailjs.send(serviceID, templateID, templateParams)
        .then(() => {
          console.log('[EmailJS] 邮件发送成功');
          alert("✅ 评测结果已成功发送至 RSEC 邮箱！");
          if (typeof onSuccess === 'function') onSuccess();
        })
        .catch(err => {
          console.error('[EmailJS] 邮件发送失败:', err);
          showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
          if (typeof onFailure === 'function') onFailure(err);
        });
    };
    script.onerror = () => {
      console.error('[EmailJS] 模块加载失败');
      if (typeof onFailure === 'function') onFailure(new Error('模块加载失败'));
    };
    document.head.appendChild(script);
  } else {
    emailjs.init(publicKey);
    emailjs.send(serviceID, templateID, templateParams)
      .then(() => {
        console.log('[EmailJS] 邮件发送成功');
        alert("✅ 评测结果已成功发送至 RSEC 邮箱！");
        if (typeof onSuccess === 'function') onSuccess();
      })
      .catch(err => {
        console.error('[EmailJS] 邮件发送失败:', err);
        showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
        if (typeof onFailure === 'function') onFailure(err);
      });
  }
}

/**
 * ✅ 将用户答题结果生成 HTML 表格，用于插入邮件正文中
 * @param {Object} answers - 用户答题数据结构（由 collectAnswers() 返回）
 * @returns {string} HTML 字符串，包含所有答题表格
 */
 function generateEmailTableHTML(answers) {
  let html = `
  <style>
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; font-family: sans-serif; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
    thead { background-color: #f3f4f6; color: #111827; }
    .title { background-color: #ef4444; color: white; font-weight: bold; }
  </style>

  <h2 style="margin-top: 0;">📋 答题评估结果</h2>
  <p><strong>公司名称：</strong>${answers.userInfo.company}</p>
  <p><strong>姓名：</strong>${answers.userInfo.name}</p>
  <p><strong>邮箱：</strong>${answers.userInfo.email}</p>
  <p><strong>电话：</strong>${answers.userInfo.phone}</p>
  <p><strong>提交时间：</strong>${new Date().toLocaleString('zh-CN', { hour12: false })}</p>
  `;

  const correctAnswers = {
    single: ["B", "C", "A", "B", "D", "C", "C", "B", "B", "B", "D", "C", "C", "B", "C", "B", "C", "B", "B", "B", "C", "D", "D", "B", "B"],
    multiple: [
      ["A", "B", "D"], ["C", "D"], ["A", "B", "C"], ["A", "B", "D"], ["A", "B", "C", "D"],
      ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"], ["A", "B", "C", "D"], ["A", "B", "C", "D"],
      ["A", "B", "D"], ["A", "B", "D"], ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"],
      ["A", "B", "C"], ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"], ["A", "B", "C", "D"]
    ],
    judge: ["true", "false", "false", "true", "true", "false", "true", "true", "false", "true", "false", "true", "false", "true", "false", "true", "true", "false", "true", "false"]
  };

  // 渲染每类题型表格
  const appendTable = (type, count, getUser, getCorrect, getScore) => {
    let rows = '';
    for (let i = 1; i <= count; i++) {
      const your = getUser(i);
      const correct = getCorrect(i);
      const score = getScore(i);
      rows += `<tr>
        <td>${type}</td>
        <td>${i}</td>
        <td>${your}</td>
        <td>${correct}</td>
        <td>${score}</td>
      </tr>`;
    }
    html += `
      <table>
        <thead class="title"><tr><th colspan="5">${type}</th></tr></thead>
        <thead><tr><th>题型</th><th>题号</th><th>你的答案</th><th>正确答案</th><th>得分</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  };

  // 单选题
  appendTable("单选题", 25,
    i => answers.singleChoice[`q${i}`] || '未答',
    i => correctAnswers.single[i - 1],
    i => (answers.singleChoice[`q${i}`] === correctAnswers.single[i - 1]) ? 2 : 0
  );

  // 多选题
  appendTable("多选题", 20,
    i => (answers.multipleChoice[i] || []).join(', ') || '未答',
    i => correctAnswers.multiple[i - 1].join(', '),
    i => {
      const your = (answers.multipleChoice[i] || []).sort();
      const correct = correctAnswers.multiple[i - 1].sort();
      return JSON.stringify(your) === JSON.stringify(correct) ? 1 : 0;
    }
  );

  // 判断题
  appendTable("判断题", 20,
    i => {
      const v = answers.judgment[`jq${i}`];
      return v === 'true' ? '✔ 正确' : v === 'false' ? '✘ 错误' : '未答';
    },
    i => correctAnswers.judge[i - 1] === 'true' ? '✔ 正确' : '✘ 错误',
    i => (answers.judgment[`jq${i}`] === correctAnswers.judge[i - 1]) ? 1 : 0
  );

  // 简答题
  const essay = answers.essay || '';
  const keywords = ["传感器", "温度", "差压", "数量", "安装位置", "通信"];
  const match = keywords.filter(k => essay.includes(k)).length;
  const essayScore = match >= 5 ? 35 : match >= 3 ? 25 : match >= 1 ? 10 : 0;
  html += `
    <table>
      <thead class="title"><tr><th colspan="5">简答题</th></tr></thead>
      <tbody><tr><td colspan="5" style="text-align: left;">${essay || '未作答'}<br/><strong>得分：</strong>${essayScore}（匹配关键词：${match}）</td></tr></tbody>
    </table>`;

  return html;
}
/**
 * ✅ 补充按钮功能：点击“发送评估结果到邮箱”时触发
 * - 自动导出完成页 PDF
 * - 构建邮件表格内容并通过 EmailJS 发送
 */
async function handleScreenshotAndEmail() {
  try {
    const answers = collectAnswers(); // ✅ 获取当前答题内容（你已实现该函数）
    const userName = answers.userInfo.name || '匿名用户';

    // ✅ 使用 html2pdf 导出完成页
    const completePage = document.getElementById("completePage");
    await html2pdf().from(completePage).set({
      margin: 0,
      filename: `EE-W评测结果_${userName}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).save();

    // ✅ 构建邮件内容
    const tableHTML = generateEmailTableHTML(answers);
    const templateParams = {
      company: answers.userInfo.company,
      user_name: userName,
      phone: answers.userInfo.phone,
      user_email: answers.userInfo.email,
      timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
      message: '系统自动提交：EE-W产品培训答卷（手动触发）',
      table_html: tableHTML
    };

    // ✅ 发送邮件（EmailJS 方式）
    emailjs.send('service_csl8frv', 'template_0v2mqw9', templateParams)
      .then(() => alert("✅ 邮件已成功发送！"))
      .catch(err => {
        console.error("[EmailJS] 邮件发送失败：", err);
        //alert("❌ 邮件发送失败，请检查网络或稍后再试！");
        showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
      });

  } catch (err) {
    console.error("[发送错误]：", err);
    alert("❌ 出现错误，无法完成操作，请稍后重试！");
  }
}

/**
 * ✅ 用户点击“开始评测”时，弹出确认框
 */
 function confirmStartEvaluation() {
  if (confirm("您确定开始进行评测吗？\n提交后将自动推送给 Armstrong RSEC 部门，并导出 PDF。")) {
    // ✅ 继续下一步：动态口令验证 + 邮件推送
    const stored = sessionStorage.getItem("userAnswers");
    if (!stored) {
      alert("⚠️ 无法获取答题数据，请重新提交！");
      return;
    }
    const answers = JSON.parse(stored);
    sessionStorage.setItem("hasEvaluated", "true"); // ✅ 设置标志：已评测
    // 👉 执行动态口令验证逻辑（下一步将补充）
    promptPasswordAndSend(answers);
  } else {
    // ❌ 用户取消，什么都不做
    alert("已取消评测，您可继续检查答题内容。");
  }
}

/**
 * ✅ 返回答题页逻辑（仅在未开始评测前可用）
 */
 function returnToTestPage() {
  // 如果已经开始评测，就不允许返回
  if (sessionStorage.getItem('hasEvaluated') === 'true') {
    alert('⚠️ 您已完成评测，带有完成时间的结果已经发送出去，无法返回修改答卷！');
    return;
  }

  // 跳转回 testPage
  showPage('testPage');

  // 清除所有题目答案，只保留学员信息
  document.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked').forEach(el => el.checked = false);
  document.getElementById('essay').value = '';

  // ✅ 可选：重置滚动到顶部
  window.scrollTo(0, 0);
}

// ✅ 用户点击“开始评测”按钮后的确认提示
function startEvaluationPrompt() {
  // 使用原生 confirm 简洁实现，也可以改为 modal 风格
  const confirmed = confirm("您确定要开始进行评测吗？\n评测后将自动导出 PDF，并发送结果至 Armstrong RSEC。");
  if (confirmed) {
    // 用户点击“是”后，进入动态口令验证流程
    promptPasswordAndSend(); // 下一步定义
  } else {
    // 否则不做任何操作，停留在完成页
    alert("已取消评测操作。您仍可检查答题内容。");
  }
}

// ✅ 点击“开始评测”按钮时的入口
function onStartEvaluationClick() {
  if (confirm("您确定开始进行评测吗？\n\n一旦开始，将无法返回测试页，并会导出 PDF、推送结果到 Armstrong RSEC。")) {
    // 用户点击“是”，继续弹出动态验证码
    promptPasswordAndSend();
  } else {
    // 用户点击“否”，什么也不做
    return;
  }
}

// ✅ 动态验证码验证 + 分支处理
function promptPasswordAndSend() {
  const code = prompt("请输入动态口令（如由 RSEC 部门提供）：");

  if (!code) return alert("未输入验证码，操作已取消。");

  if (code === "AFT2025") {
    // ✅ 验证成功，执行全部逻辑
    const answers = collectAnswers();
    renderAssessmentResult(answers); // 渲染完成页
    exportPDF(answers);              // 导出 PDF
    sendEmailResult(answers);        // 发送邮件
    evaluationStarted = true;
  } else {
    // ❌ 验证失败，只导出 PDF 并提醒
    const answers = collectAnswers();
    evaluationStarted = true;
    renderAssessmentResult(answers);
    exportPDF(answers);
    alert("动态验证码错误，仅导出 PDF，未发送邮件，请联系管理员。");
  }
}

function exportPDF(answers) {
  const userName = answers.userInfo.name || '匿名用户';
  const completePage = document.getElementById("completePage");
  html2pdf().from(completePage).set({
  margin: [10, 10, 10, 10],
  filename: `EE-W评测结果_${userName}.pdf`,
  image: { type: 'jpeg', quality: 0.98 },
  html2canvas: {
    scale: 2,          // 保证清晰
    useCORS: true,
    scrollX: 0,
    scrollY: 0,
    windowWidth: completePage.scrollWidth, // ✨ 加这个
    windowHeight: completePage.scrollHeight // ✨ 加这个
  },
  jsPDF: {
    unit: 'mm',
    format: 'a4',
    orientation: 'portrait'
  }
}).save();
}

function sendEmailResult(answers) {
  const tableHTML = generateEmailTableHTML(answers);

  const templateParams = {
    company: answers.userInfo.company,
    user_name: answers.userInfo.name,
    phone: answers.userInfo.phone,
    user_email: answers.userInfo.email,
    timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
    message: '系统自动提交：EE-W产品培训答卷',
    table_html: tableHTML
  };

  // ✅ 调用 EmailJS
  emailjs.send('service_csl8frv', 'template_0v2mqw9', templateParams)
    .then(() => {
        console.log("✅ 邮件发送成功");
        alert("✅ 评测结果已成功发送至 RSEC 邮箱！");
      })
    .catch(err => {
        console.error('[EmailJS] 邮件失败', err);
        //alert('⚠️ 邮件发送失败，请将导出的 PDF 手动发送到 RSEC 邮箱：rsec@armstrong.com');
        showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
      });
}

function onReturnToTestPage() {
  if (evaluationStarted) {
    alert("⚠️ 评测已开始，无法返回答题页！");
    return;
  }

  // ✅ 清除答题内容（保留学员信息）
  const answers = collectAnswers();
  // 清空选项和简答题内容（⚠️ 注释以下两行即可保留答题记录）
  //document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => input.checked = false);
  //document.getElementById('essay').value = '';

  showPage('testPage');
  document.getElementById('company').value = answers.userInfo.company;
  document.getElementById('name').value = answers.userInfo.name;
  document.getElementById('email').value = answers.userInfo.email;
  document.getElementById('phone').value = answers.userInfo.phone;
}

// 🧩 显示邮件重试弹窗
function showRetryModal() {
  document.getElementById("emailRetryModal").classList.remove("hidden");
}

// 🧩 关闭弹窗
function closeRetryModal() {
  document.getElementById("emailRetryModal").classList.add("hidden");
}

// 🧩 点击重试按钮时，重新初始化并推送邮件
console.log("绑定 retryEmailBtn...");
const btn = document.getElementById("retryEmailBtn");
console.log("retryEmailBtn =", btn);

if (btn) {
  btn.addEventListener("click", () => {
    closeRetryModal();

    if (window.emailjs) {
      try {
        emailjs.init("LoQCI3C98dk3FgEvj");
      } catch (e) {
        console.error("EmailJS 初始化失败", e);
      }
    }

    handleEmailSendAgain();
  });
} else {
  console.warn("⚠️ 没有找到 #retryEmailBtn，跳过绑定");
}


// ✅ 重新初始化 EmailJS（避免推送失败后卡死）
function reinitializeEmailJS() {
  if (window.emailjs) {
    try {
      emailjs.init("LoQCI3C98dk3FgEvj");  // 你的 Public Key
      console.log("✅ EmailJS 已重新初始化");
    } catch (err) {
      console.error("❌ EmailJS 初始化失败", err);
    }
  } else {
    console.error("⚠️ EmailJS 模块未加载");
  }
}

// ✅ 重试按钮绑定的函数
function retryEmailSend() {
  hideEmailResultPopup();  // 先关闭弹窗
  reinitializeEmailJS();   // 重新初始化
  setTimeout(() => {
    handleExportWithPDFAndEmail(); // 再次执行导出和推送
  }, 200);  // 稍等200ms，避免初始化未完成
}


// ✅ 用于显示邮件发送结果弹窗，并支持重试逻辑
function showEmailResultPopup(message) {
  // 构建弹窗 HTML
  const modalHTML = `
    <div id="emailResultPopup" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-[300px] text-center fade-in-bounce">
        <p class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">${message}</p>
        <div class="flex justify-center gap-4">
          <button id="retrySendBtn" class="bg-blue-600 text-white px-4 py-1.5 rounded hover:bg-blue-700">是</button>
          <button id="cancelSendBtn" class="bg-gray-300 text-gray-800 px-4 py-1.5 rounded hover:bg-gray-400">否</button>
        </div>
      </div>
    </div>
  `;

  // 插入弹窗
  document.body.insertAdjacentHTML('beforeend', modalHTML);

  // ✅ 绑定按钮事件
  document.getElementById('retrySendBtn').onclick = () => {
    document.getElementById('emailResultPopup').remove();

    // ✅ 重初始化 EmailJS（确保状态清空）
    emailjs.init("LoQCI3C98dk3FgEvj");

    // ✅ 重新发送（调用你已有的主发送函数）
    try {
      handleExportWithPDFAndEmail(true); // 加一个参数标识重试
    } catch (err) {
      alert("邮件再次发送失败，请稍后再试。");
    }
  };

  document.getElementById('cancelSendBtn').onclick = () => {
    document.getElementById('emailResultPopup').remove();
  };
}




 </script>
 <!--  By Martin 此处是核心函数及功能的代码 结尾 -->

<script>
// ✅ 随机打乱分布 30° 统一倾斜水印
document.addEventListener("DOMContentLoaded", () => {
  const COUNT = 30; // 水印个数
  for (let i = 0; i < COUNT; i++) {
    const wm = document.createElement("div");
    wm.className = "watermark-random";
    wm.style.top = `${Math.random() * 120 - 10}vh`;
    wm.style.left = `${Math.random() * 120 - 10}vw`;
    wm.style.transform = `rotate(30deg) scale(${0.7 + Math.random() * 0.6})`;
    document.body.appendChild(wm);
  }
});
</script>

<!-- 🔐 动态口令弹窗 -->
<div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md w-full max-w-sm text-center">
    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">请输入动态口令以发送评测结果至邮箱</h3>
    <input id="passwordInput" type="password" placeholder="请输入口令..." 
           class="w-full p-2 border rounded-md mb-4 focus:outline-none focus:ring focus:border-blue-300" />
    <div class="flex justify-between space-x-4">
      <button onclick="confirmPassword(true)" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded">确定</button>
      <button onclick="confirmPassword(false)" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white py-2 rounded">跳过发送</button>
    </div>
  </div>
</div>

<!-- ✅ 倒计时暂停提示遮罩 -->
<div id="countdownCenterOverlay" class="hidden fixed inset-0 flex">
  <div class="text-center">
    <p>当前考试已暂停</p>
    <p>点击下方按钮可恢复考试</p>
    <button onclick="resumeFromCenterOverlay()">继续答题</button>
  </div>
</div>

<script>
  // ✅ 页面加载后自动触发倒计时函数
  document.addEventListener("DOMContentLoaded", function () {
    startTimer(); // 自动启动倒计时
  });
</script>

<!-- 邮件重试弹窗 -->
<div id="emailRetryModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-80 text-center shadow-lg">
    <p class="text-lg font-semibold text-gray-900 dark:text-white mb-4">邮件发送失败，是否重试？</p>
    <div class="flex justify-center gap-4">
      <!-- 邮件失败弹窗按钮 -->
    <button id="retryEmailBtn" onclick="retryEmailSend()" class="bg-green-500 hover:bg-green-600 ...">
      是，重新发送
    </button>
    <button id="retryEmailBtn" onclick="hideEmailResultPopup()" class="bg-gray-400 hover:bg-gray-500 ...">
      否，暂不发送
    </button>
    </div>
  </div>
</div>

<!-- ✅ 页面心跳机制脚本（新增） -->
    <!-- ✅ 页面底部，在 
<!-- PapaParse CSV 加载 + 动态题目填充脚本（匹配中文字段） -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  // 防止变量重复声明
  if (typeof currentLang === 'undefined') {
    var currentLang = 'zh';  // 默认语言
  }

// 加载 CSV 并填充所有题型
function loadQuestionsFromCSV(csvPath) {
  Papa.parse(csvPath, {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data;

      // ========== 1. 单选题 =========
      
      

      // ========== 2. 多选题 =========
      
      

      // ========== 3. 判断题 =========
      

      // ========== 4. 简答题 =========
      const short = data.filter(q => q['题型'] === '简答题');
      if (short.length > 0) {
        const q = short[0];
        const container = document.querySelector(`#short1`);
        if (container) {
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          container.querySelector('h3').textContent = title;
        }
      }
    }
  });
}

// 页面加载后自动执行
window.addEventListener("DOMContentLoaded", () => {
  loadQuestionsFromCSV("/static/csv/EE-W.csv");
});

// 语言切换函数（通过按钮调用）
function switchLanguage(lang) {
  currentLang = lang;
  loadQuestionsFromCSV("/static/csv/EE-W.csv");
}
</script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  if (typeof currentLang === 'undefined') var currentLang = 'zh';
  document.addEventListener("DOMContentLoaded", function () {
    Papa.parse("/static/csv/EE-W.csv", {
      download: true,
      header: true,
      complete: function (results) {
        const data = results.data;
        // ✅ 单选题渲染
        data.filter(q => q['题型'] === '单选题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#q${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D'].forEach(opt => {
            const label = container.querySelector(`label[for="q${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="radio" id="q${index}-${opt}" name="q${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });
        // ✅ 多选题渲染
        data.filter(q => q['题型'] === '多选题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#multi${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D', 'E', 'F'].forEach(opt => {
            const label = container.querySelector(`label[for="m${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="checkbox" id="m${index}-${opt}" name="multi${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });
        // ✅ 判断题渲染
        data.filter(q => q['题型'] === '判断题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#jq${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
        });
        // ✅ 简答题渲染
        const short = data.find(q => q['题型'] === '简答题');
        const container = document.querySelector("#short1");
        if (short && container) {
          const title = currentLang === 'en' ? short['English Question'] : short['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = title;
        }
      },
      error: function (err) {
        console.error("❌ 题库加载失败：", err);
      }
    });
  });
</script>

    <script>
      let lastActivityTime = Date.now();
  
      // 记录人工操作事件时间
      const recordActivity = () => {
      lastActivityTime = Date.now();
      };
  
      // ✅ 绑定所有人工操作事件（点击、滚动、输入等）
      ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
      document.addEventListener(evt, recordActivity);
      });
  
      // ✅ 每分钟发送心跳请求，仅在用户1分钟内有操作时才发送
      setInterval(() => {
      if (Date.now() - lastActivityTime < 60000) {
          fetch('/heartbeat')
          .then(res => {
              if (res.status === 440) {
              alert("登录已超时，请重新登录！");
              window.location.href = "/login";
              }
          })
          .catch(() => {});
      }
      }, 60000);
  </script>




<!-- ✅ 登录弹窗 -->
<div id="loginOverlay" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-xs shadow-xl">
    <h2 class="text-lg font-bold text-center mb-4">会话已过期，请重新登录</h2>
    <input id="reLoginUser" class="w-full mb-3 px-4 py-2 rounded-md bg-gray-100 dark:bg-gray-700" placeholder="用户名">
    <input id="reLoginPass" type="password" class="w-full mb-3 px-4 py-2 rounded-md bg-gray-100 dark:bg-gray-700" placeholder="密码">
    <button onclick="submitRelogin()" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">重新登录</button>
  </div>
</div>

<!-- 页面末尾 -->
<script>
  function showLoginOverlay() {
    document.getElementById("loginOverlay").classList.remove("hidden");
  }
  
  async function submitRelogin() {
    const username = document.getElementById("reLoginUser").value.trim();
    const password = document.getElementById("reLoginPass").value.trim();
  
    const res = await fetch("/login", {
      method: "POST",
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ username, password })
    });
  
    if (res.redirected) {
      location.reload();  // ✅ 登录成功后刷新页面继续使用
    } else {
      alert("重新登录失败，请检查用户名或密码");
    }
  }

  document.getElementById("reLoginPass").addEventListener("keyup", function (e) {
      if (e.key === "Enter") {
          submitRelogin();
      }
  });
  </script>

  <!-- 关闭登录弹窗 -->
  <script>
      function closeLoginOverlay() {
          document.getElementById("loginOverlay").classList.add("hidden");
      }
  </script>



<!-- ✅ 统一 PapaParse 加载与题目渲染入口 -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  if (typeof currentLang === 'undefined') var currentLang = 'zh';

  document.addEventListener("DOMContentLoaded", function () {
    Papa.parse("/static/csv/EE-W.csv", {
      download: true,
      header: true,
      complete: function (results) {
        const data = results.data;

        // ✅ 单选题渲染
        data.filter(q => q['题型'] === '单选题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#q${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D'].forEach(opt => {
            const label = container.querySelector(`label[for="q${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="radio" id="q${index}-${opt}" name="q${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });

        // ✅ 多选题渲染
        data.filter(q => q['题型'] === '多选题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#multi${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D', 'E', 'F'].forEach(opt => {
            const label = container.querySelector(`label[for="m${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="checkbox" id="m${index}-${opt}" name="multi${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });

        // ✅ 判断题渲染
        data.filter(q => q['题型'] === '判断题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#jq${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
        });

        // ✅ 简答题渲染
        const short = data.find(q => q['题型'] === '简答题');
        const container = document.querySelector("#short1");
        if (short && container) {
          const title = currentLang === 'en' ? short['English Question'] : short['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = title;
        }
      },
      error: function (err) {
        console.error("❌ 题库加载失败：", err);
      }
    });
  });
</script>

<!-- ✅ 加载 CSV 题库并渲染 -->
<script src="/static/common/render.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 加载并渲染 CSV 题目，EE-W 为默认题库路径
    loadCSVAndRender("/static/csv/EE-W.csv", "zh");
  });
</script>

<!-- ✅ 通用模态弹窗模板 -->
<div id="universalModal" class="fixed z-50 inset-0 overflow-y-auto bg-gray-800 bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white dark:bg-gray-900 p-6 rounded-lg shadow-lg w-full max-w-md text-center">
    <h2 id="modalTitle" class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">提示标题</h2>
    <p id="modalMessage" class="text-gray-700 dark:text-gray-300 mb-6">提示内容文本，可根据实际内容动态设置</p>

    <!-- 可选输入框（例如动态口令） -->
    <input
      id="modalInput"
      class="bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded p-2 w-full mb-4 hidden"
      type="text"
      placeholder="请输入内容"
    />

    <div class="flex justify-end gap-4">
      <button id="modalConfirmBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
        确定
      </button>
      <button onclick="closeUniversalModal()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">
        取消
      </button>
    </div>
  </div>
</div>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const html = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
  
    // 从 localStorage 恢复主题
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      html.classList.add('dark');
      console.log('[Init] 恢复为 dark 模式');
    } else if (savedTheme === 'light') {
      html.classList.remove('dark');
      console.log('[Init] 恢复为 light 模式');
    } else {
      // 首次访问时自动检测系统主题
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      html.classList.toggle('dark', prefersDark);
      localStorage.setItem('theme', prefersDark ? 'dark' : 'light');
    }
  
    // ✅ 点击按钮切换明暗模式
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const isDark = html.classList.contains('dark');
        html.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
      });
    }
  });
</script>

<script>
  function positionCountdownBar() {
    const nav = document.getElementById("mainNavbar");
    const bar = document.getElementById("examStatusBar");

    if (nav && bar) {
      const navRect = nav.getBoundingClientRect();
      const scrollY = window.scrollY || window.pageYOffset;

      // 🧠 计算导航栏底部相对整个页面的实际位置
      const navBottom = navRect.bottom + scrollY;

      // ✅ 设置倒计时栏 top = 导航栏底 + 8px 间距
      bar.style.top = `${navBottom + 0}px`;
    }
  }

  // ✅ 页面加载完成后定位一次
  window.addEventListener("DOMContentLoaded", positionCountdownBar);
  // ✅ 浏览器尺寸变化时重新定位
  window.addEventListener("resize", positionCountdownBar);
</script>

</div>
</body>
</html>
