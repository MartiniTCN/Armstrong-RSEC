<!DOCTYPE html>
<html lang="zh-CN"> <!-- ✅ 不写 class="dark"，JS 控制 -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- ✅ 告诉浏览器支持浅色/深色，但不强制使用系统设置 -->
  <meta name="color-scheme" content="light dark">
    <title>SE-F 产品培训测试系统</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      tailwind.config = {
        darkMode: 'class', // ✅ 在这里设置
      };
    </script>

    
        

    <link rel="stylesheet" href="/static/common/style.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- ✅ csv 解析库 -->


	<!-- ✅ 🆕 立即加上这段，开启 dark 模式支持 -->



<style>
  /* ✅ 避免分页时拆行 */
  tr {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
  }

  /* ✅ 完整内容居中，防止边缘溢出 */
  #completePage {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
  }

  /* ✅ 小屏适配：答题页和表格字体适配 */
  @media screen and (max-width: 768px) {
    #completePage {
      font-size: 13px;
    }

    table {
      font-size: 12px;
    }

    td, th {
      padding: 6px 4px;
      word-break: break-word;
    }
  }

  /* ✅ 居中显示倒计时提示 + 按钮 */
#countdownCenterOverlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(6px);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  color: #1f2937; /* text-gray-800 */
  font-size: 18px;
}

#countdownCenterOverlay button {
  margin-top: 1rem;
  padding: 0.5rem 1.5rem;
  border-radius: 9999px;
  background: #16a34a; /* bg-green-600 */
  color: white;
  font-weight: bold;
  border: none;
  cursor: pointer;
}

</style>

<!-- ✅ 正确引入 EmailJS 的浏览器版本 SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  // ✅ 初始化 EmailJS，必须放在引入之后
  (function() {
    emailjs.init("LoQCI3C98dk3FgEvj");
  })();

  function onReturnToTestPage() {
  if (evaluationStarted) {
    alert("⚠️ 评测已开始，无法返回答题页！");
    return;
  }

  // ✅ 清除答题内容（保留学员信息）
  const answers = collectAnswers();
  // 清空选项和简答题内容（⚠️ 注释以下两行即可保留答题记录）
  //document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => input.checked = false);
  //document.getElementById('essay').value = '';

  showPage('testPage');
  document.getElementById('company').value = answers.userInfo.company;
  document.getElementById('name').value = answers.userInfo.name;
  document.getElementById('email').value = answers.userInfo.email;
  document.getElementById('phone').value = answers.userInfo.phone;
}

</script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='common/style.css') }}">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
	
        /* 保持原有所有样式 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        .option-selected { background-color: rgba(59, 130, 246, 0.1); }
        .page { display: none; }
        .active-page { display: block; }
        .input-field-highlight {
            @apply w-full p-2 rounded-md border-2 border-blue-300 shadow-sm 
                   dark:border-blue-500 transition-colors focus:ring-2 
                   focus:ring-blue-500 focus:border-blue-500;
        }
        .question-card {
            @apply p-6 rounded-lg bg-gray-50 dark:bg-gray-700 
                   transition-colors hover:bg-gray-100 dark:hover:bg-gray-600
                   mb-6 border-2 border-transparent;
        }
        .options-grid {
            @apply grid grid-cols-1 md:grid-cols-2 gap-4;
        }
        .option {
            @apply flex items-center p-3 rounded-lg border-2 border-gray-200
                   dark:border-gray-600 cursor-pointer transition-all
                   hover:border-blue-500;
        }
        .option input {
            @apply mr-3;
        }
		.option span {
  color: #1f2937; /* light mode 默认颜色 */
}

.dark .option span {
  color: #e5e7eb; /* dark mode 字体颜色 */
}
        .judge-card {
            @apply p-4 rounded-lg bg-gray-50 dark:bg-gray-700
                   border-2 border-transparent;
        }
        .judge-btn {
            @apply w-12 h-12 flex items-center justify-center rounded-full 
                   border-2 border-gray-300 dark:border-gray-600 
                   hover:border-blue-500 cursor-pointer transition-all;
        }
        .judge-btn i {
            @apply text-xl opacity-0 transition-opacity;
        }
        .judge-btn input:checked ~ i {
            @apply opacity-100;
        }
        .border-red-500 {
            border-color: rgb(239 68 68) !important;
        }
		
 /* ✅ 加入弹出提示动画 */
    .fade-in-bounce {
      animation: fadeInBounce 0.5s ease-out;
    }
    @keyframes fadeInBounce {
      0% { opacity: 0; transform: translateY(-20px); }
      60% { transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
		
/* ✅ 用于动态生成的打乱水印元素样式 */
.watermark-random {
  position: fixed;
  width: 220px;
  height: 220px;
  background-image: url('https://i.stardots.io/armstrong/水印图片 - 金色_副本.png?width=500&rotate=0&blur=0&quality=50');
  background-repeat: no-repeat;
  background-size: contain;
  background-position: center;
  opacity: 0.2;
  z-index: 0;
  pointer-events: none;
}

/* ✅ 页面模糊时使用的样式 */
.blur-overlay {
  filter: blur(5px);
  pointer-events: none;
  user-select: none;
  transition: all 0.3s ease;
}

#examStatusBar {
  position: fixed;              /* ✅ 固定在屏幕上，随滚动保持可见 */
  top: 70px;                    /* ✅ 距离页面顶部 70px，刚好紧贴导航栏下方 */
  left: 50%;                    /* ✅ 元素左边在屏幕中间 */
  transform: translateX(-50%); /* ✅ 左移自身宽度的一半，真正实现水平居中 */

  /* right: auto; */            /* ✅ 你可以保留这一行作为备选，表示取消右侧定位 */
  /* ✅ 如果以后想靠右显示，可注释 left 和 transform，改用 right: 10rem; */

  background-color: #dc2626;   /* ✅ 红色背景，Tailwind 中的 red-600 */
  color: white;                /* ✅ 白色字体 */
  padding: 0.2rem 0.5rem;      /* ✅ 上下 0.2rem，左右 0.5rem，控制胶囊大小 */
  border-radius: 9999px;       /* ✅ 圆角最大值，形成胶囊外观 */

  display: flex;               /* ✅ 使用 Flex 布局对齐内容 */
  justify-content: center;     /* ✅ 水平居中 */
  align-items: center;         /* ✅ 垂直居中 */
  gap: 0.5rem;                 /* ✅ 图标、数字、按钮之间的间距 */

  font-size: 0.75rem;          /* ✅ 字体略小（等于 Tailwind 的 text-xs） */
  font-weight: 600;            /* ✅ 字体加粗 */
  z-index: 9999;               /* ✅ 保证显示在最上层 */
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);  /* ✅ 添加阴影提升层次感 */
  height: auto;                /* ✅ 高度自动适应内容 */
  line-height: 1;              /* ✅ 行距紧凑，避免撑高胶囊 */
  transition: all 0.3s ease;   /* ✅ 添加平滑过渡动画 */
}

/* ✅ 暂停按钮的样式（按钮本身） */
#examStatusBar button {
  background-color: white;          /* 背景白色 */
  color: #dc2626;                   /* 文字红色 */
  font-weight: 600;                 /* 加粗 */
  padding: 0.1rem 0.6rem;           /* 内边距（控制按钮大小） */
  border-radius: 9999px;            /* 圆角按钮 */
  font-size: 0.7rem;                /* 字体略小 */
  line-height: 1;                   /* 紧凑行距 */
  transition: all 0.2s ease;        /* 添加按钮 hover 过渡效果 */
}

#examStatusBar button:hover {
  background-color: #fef2f2;        /* 鼠标悬停时背景变为淡粉色 */
}

/* ✅ 小屏幕优化（例如手机） */


  #examStatusBar button span {
    display: none;                 /* 隐藏暂停按钮文字，只保留图标 */
  }

  #examStatusBar button i {
    margin-right: 0;               /* 去掉图标后的空隙 */
  }

    h2[data-title-zh],
    h2[data-title-en] {
      font-size: 1rem;
      line-height: 1.4;
      font-weight: 600;
      color: #1f2937;
    }
    .dark h2[data-title-zh],
    .dark h2[data-title-en] {
      color: #e5e7eb;
    }
</style>

</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
  <script>
    const currentUsername = "{{ username }}";  // 从 Flask 中传递过来的变量
  </script>

  <div class="page-container">
  <!-- ✅ 动态题目容器（必须有这个 ID） -->
  <!-- <div id="testContainer" class="mt-6 space-y-6"></div> -->

    <!-- 加载遮罩 -->
    <div id="loading" class="fixed inset-0 bg-black/50 z-50 hidden">
        <div class="flex items-center justify-center h-full">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg flex items-center">
                <i class="fas fa-spinner animate-spin text-2xl text-blue-500 mr-3"></i>
                <span class="text-gray-700 dark:text-gray-200">正在生成报告...</span>
            </div>
        </div>
    </div>

  <!-- ✅ 导航栏卡片 -->
<!-- ✅ 顶部导航栏 -->
<nav id="mainNavbar" class="sticky top-0 z-40 w-full bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-sm">
  <div class="flex items-center justify-between px-4 py-2 sm:px-6 sm:py-3">
    <!-- ✅ 左侧 Logo + 标题 -->
    <div class="flex items-center gap-2">
      <img src="https://i.stardots.io/armstrong/Armstrong%20Logo%20-%20Martin.png?width=500" alt="Logo" class="h-5 sm:h-8 w-auto" />
      <span class="text-gray-400 text-xs sm:text-base">｜</span>
      <h1 id="pageTitle"
          data-title-zh="SE-F 产品培训测试系统"
          data-title-en="SE-F Product Training Test System"
          class="text-xs sm:text-base font-semibold text-gray-800 dark:text-gray-200 tracking-wide">
        SE-F 产品培训测试系统
      </h1>
    </div>

    

  <!-- ✅ 下方中间：按钮区域（居中） -->
  <div class="flex justify-center gap-4 mt-2 mb-2 items-center">
    <!-- 明暗模式切换 -->
    <button id="themeToggle"
      class="w-6 h-6 flex items-center justify-center rounded-full bg-white dark:bg-gray-800 border border-gray-500 dark:border-gray-600 shadow hover:scale-110 transition-transform"
      aria-label="切换明暗模式">
      <i class="fas fa-sun dark:hidden text-xs"></i>
      <i class="fas fa-moon hidden dark:block text-xs"></i>
    </button>

    <!-- 语言切换按钮 -->
    <button id="languageToggle" onclick="toggleLanguage()"
      class="w-4 h-4 flex items-center justify-center rounded-full overflow-hidden bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 shadow-inner hover:scale-110 transition-transform"
      aria-label="切换语言">
      <img id="languageFlag" src="https://flagcdn.com/cn.svg" alt="Language" class="w-full h-full object-cover" />
    </button>

    <!-- 用户名 -->
    <span class="text-sm font-semibold text-gray-800 dark:text-gray-200">{{ username }} ｜</span>

    <!-- 退出按钮（中英文切换）-->
    <button onclick="handleLogout()" id="logoutText"
      class="flex items-center gap-2 hover:underline transition-all text-[#f53029] font-bold py-1 px-2"
      style="font-size: 0.85rem; color: #f53029; font-weight: bold;">
      <!-- 使用 Font Awesome 的退出图标 -->
      <i class="fas fa-sign-out-alt" style="font-size: 1rem; color: #f53029;"></i>
      {{ '退出' if lang == 'zh' else 'Logout' }}
    </button>

  </div>
</nav>

<!-- ✅ 倒计时胶囊条（放在导航栏正下方） -->
<div
  id="examStatusBar"
  class="mx-auto mt-1 flex items-center justify-center bg-red-600 text-white text-xs sm:text-sm rounded-full shadow-md px-4 py-1 space-x-2 w-fit"
>
  <i class="fas fa-clock"></i>
  <span id="countdown">59:59</span>
  <button
    onclick="togglePause()"
    id="pauseBtn"
    class="bg-white text-red-600 px-2 py-0.5 rounded-full hover:bg-red-100 transition"
  >
    <i class="fas fa-pause"></i>
    <span class="hidden sm:inline ml-1">暂停</span>
  </button>
</div>
    <!-- 删除首页 -->

    <!-- 直接进入测试页 -->
    <section id="testPage" class="page active-page container mx-auto px-4 py-6">
	

        <div class="flex justify-between mb-6">
          <a href="/course" class="text-blue-600 dark:text-blue-400 hover:underline">
            <i class="fas fa-arrow-left mr-2"></i>返回课程选择页
          </a>
			<!-- ✅ 错误提示框：嵌入顶部 -->
    <div id="errorMessage"
         class="hidden mb-6 px-6 py-4 rounded-lg text-lg font-semibold text-red-700 bg-red-100 border border-red-400 shadow fade-in-bounce flex items-center gap-3">
      <i class="fas fa-exclamation-triangle"></i>
      <span id="errorText">请完善信息</span>
    </div>
            <div class="text-gray-600 dark:text-gray-300">
                <i class="fas fa-clock mr-2"></i>考试时间：60:00
            </div>
        </div>

        <!-- ✅ 学员信息卡片（优化明暗模式 + 不透明） -->
        <div class="card">
          <h2 data-title-zh="学员信息" data-title-en="User Info">
            <i class="fas fa-id-card mr-2 text-blue-500"></i>学员信息
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- 公司名称 -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300"
                     data-zh="公司名称" data-en="Company Name">
                <span class="text-red-500">*</span>
                <span class="lang-label">公司名称</span>
              </label>
              <div class="relative">
                <input type="text" id="company"
                       class="bg-white dark:bg-[#2a2a2a] text-xs placeholder:text-xs text-gray-900 !dark:text-gray-100
                              border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 pl-10 w-full"
                       placeholder="请输入公司全称"
                       data-placeholder-zh="请输入公司全称"
                       data-placeholder-en="Enter full company name"
                       required>
                <i class="fas fa-building absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 text-sm"></i>
              </div>
            </div>
          
            <!-- 学员姓名 -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300"
                     data-zh="学员姓名" data-en="Your Name">
                <span class="text-red-500">*</span>
                <span class="lang-label">学员姓名</span>
              </label>
              <div class="relative">
                <input type="text" id="name"
                       class="bg-white dark:bg-[#2a2a2a] text-xs placeholder:text-xs text-gray-900 !dark:text-gray-100
                              border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 pl-10 w-full"
                       placeholder="请输入真实姓名"
                       data-placeholder-zh="请输入真实姓名"
                       data-placeholder-en="Enter your name"
                       required>
                <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 text-sm"></i>
              </div>
            </div>
          
            <!-- 手机号码 -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300"
                     data-zh="手机号码" data-en="Phone Number">
                <span class="text-red-500">*</span>
                <span class="lang-label">手机号码</span>
              </label>
              <div class="relative">
                <input type="tel" id="phone"
                       class="bg-white dark:bg-[#2a2a2a] text-xs placeholder:text-xs text-gray-900 !dark:text-gray-100
                              border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 pl-10 w-full"
                       placeholder="11位手机号码"
                       data-placeholder-zh="11位手机号码"
                       data-placeholder-en="11-digit phone number"
                       pattern="[0-9]{11}" required>
                <i class="fas fa-phone-alt absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 text-sm"></i>
              </div>
            </div>
          
            <!-- 邮箱地址 -->
            <div>
              <label class="block text-sm font-bold mb-2 text-gray-700 !dark:text-gray-300"
                     data-zh="邮箱地址" data-en="Email Address">
                <span class="text-red-500">*</span>
                <span class="lang-label">邮箱地址</span>
              </label>
              <div class="relative">
                <input type="email" id="email"
                       class="bg-white dark:bg-[#2a2a2a] text-xs placeholder:text-xs text-gray-900 !dark:text-gray-100
                              border border-gray-300 !dark:border-gray-600 rounded px-3 py-2 pl-10 w-full"
                       placeholder="name@company.com"
                       data-placeholder-zh="name@company.com"
                       data-placeholder-en="name@company.com"
                       pattern="[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}"
                       required>
                <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 text-sm"></i>
              </div>
            </div>
          </div>

        </div>


        <!-- ✅ 题型导航悬浮面板（含进度提示） -->
        <div class="fixed right-2 top-1/3 z-50 bg-white dark:bg-gray-800 rounded shadow p-2 space-y-2 text-xs text-center border border-gray-200 dark:border-gray-700">
          <button onclick="scrollToType('single')" class="block w-full px-2 py-1 hover:bg-blue-100 dark:hover:bg-gray-700 rounded">
            <i class="fas fa-list text-sm mr-1"></i> 单选题
            <span id="status-single" class="ml-1 font-semibold">0 / 0</span>
          </button>
          <button onclick="scrollToType('multi')" class="block w-full px-2 py-1 hover:bg-purple-100 dark:hover:bg-gray-700 rounded">
            <i class="fas fa-check-square text-sm mr-1"></i> 多选题
            <span id="status-multi" class="ml-1 font-semibold">0 / 0</span>
          </button>
          <button onclick="scrollToType('judge')" class="block w-full px-2 py-1 hover:bg-yellow-100 dark:hover:bg-gray-700 rounded">
            <i class="fas fa-balance-scale text-sm mr-1"></i> 判断题
            <span id="status-judge" class="ml-1 font-semibold">0 / 0</span>
          </button>
          <button onclick="scrollToType('essay')" class="block w-full px-2 py-1 hover:bg-pink-100 dark:hover:bg-gray-700 rounded">
            <i class="fas fa-keyboard text-sm mr-1"></i> 简答题
            <span id="status-essay" class="ml-1 font-semibold">0 / 0</span>
          </button>
        </div>

        <!-- 单选题 -->
        <div class="card" id="section-single">
          <h2 data-title-zh="单选题（每题2分，共40分）" data-title-en="Single Choice (2 pts each, 40 pts total)">
            <i class="fas fa-list-ol mr-2 text-blue-500"></i>单选题（每题2分，共40分）
          </h2>
          <div class="space-y-6" data-section="single"></div>
        </div>

        <!-- 多选题卡片 -->
        <div class="card" id="section-multi">
          <h2 data-title-zh="多选题（每题1分，共20分）" data-title-en="Multiple Choice (1 pts each,20 pts total)">
            <i class="fas fa-check-square mr-2 text-purple-500"></i>多选题（每题1分，共20分）
          </h2>
          <div class="space-y-6" data-section="multi"></div>
        </div>

        <!-- 判断题卡片 -->
        <div class="card" id="section-judge">
          <h2 data-title-zh="判断题（每题1分，共20分）" data-title-en="True/False (1 pt each, 20 pts total)">
            <i class="fas fa-balance-scale mr-2 text-yellow-500"></i>判断题（每题1分，共20分）
          </h2>
          <div class="space-y-6" data-section="judge"></div>
        </div>    

        <!-- 简答题卡片 -->
        <div class="card" id="section-essay">
          <h2 data-title-zh="简答题（共1题，20分）" data-title-en="Essay Question (1 question, 10 pts)">
            <i class="fas fa-keyboard mr-2 text-pink-500"></i>简答题（共1题，20分）
          </h2>
          <div class="space-y-6" data-section="essay"></div>
        </div>

        <script>
          function scrollToType(type) {
            const section = document.querySelector(`[data-section="${type}"]`);
            if (section) {
              const yOffset = type === 'essay' ? 0 : -130;  // ✅ 只对非简答题加偏移，单位 px
              const y = section.getBoundingClientRect().top + window.scrollY + yOffset;
              window.scrollTo({ top: y, behavior: 'smooth' });
            } else {
              console.warn("❌ 无法找到题型锚点：", type);
            }
          }
        </script>


        <!-- 提交按钮 -->
        <div class="flex justify-center mt-8">
          <button id="submitBtn"
            class="relative inline-flex items-center justify-center px-4 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600
                  text-white text-sm font-medium rounded-full shadow-md hover:from-emerald-500 hover:to-green-600
                  transform hover:scale-105 transition-all duration-300 ease-in-out group overflow-hidden">
            <span class="relative z-10 flex items-center">
              <i class="fas fa-file-export mr-2 text-white text-base"></i>
              提交答卷
            </span>
            <!-- 💫 光晕动画 -->
            <div class="absolute inset-0 bg-white opacity-10 blur-xl group-hover:opacity-20 transition-all duration-500"></div>
          </button>
        </div>

<!-- ✅ 这是你的 testPage 页面末尾的提交按钮 -->


    </section>
    
  <!-- ✅ 完成页：展示答题详情、学员信息、总分评定 -->
<section id="completePage" class="page container mx-auto px-4 py-8 text-center">
  <div id="resultCard" class="bg-white dark:bg-gray-800 rounded-xl p-8 shadow-sm max-w-4xl mx-auto text-left">
    <div class="flex justify-between items-center mb-4">
      <!-- 左侧：标题 -->
      <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 flex items-center">
        <i class="fas fa-clipboard-check text-green-500 mr-2"></i>答题评估结果
      </h2>
    
      <!-- 右侧：登录用户信息 -->
      <span class="text-sm font-semibold text-gray-800 dark:text-gray-200 flex items-center space-x-1">
        <i class="fas fa-user-tie"></i>
        <span>{{ username }}</span>
      </span>
    </div>


<!-- ✅ 优化后的用户信息卡片（使用图标类） -->
<div class="bg-white dark:bg-gray-800 shadow rounded-xl p-4 sm:p-6 text-sm mb-6 w-full max-w-3xl mx-auto">
  <table class="w-full table-fixed text-gray-700 dark:text-gray-200 border-separate border-spacing-y-2">
    <tbody>
      <tr>
        <!-- 左列 -->
        <td class="w-1/2 pr-4 align-top">
          <table class="w-full">
            <tr>
              <td colspan="3">
                <span class="inline-flex items-center w-full">
                  <i class="fas fa-building text-gray-500 dark:text-gray-400 text-sm mr-1"></i>
                  <span class="w-24 text-right font-medium">公司名称：</span>
                  <span id="resultCompany" class="ml-2 flex-1 text-left">-</span>
                </span>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <span class="inline-flex items-center w-full">
                  <i class="fas fa-user text-gray-500 dark:text-gray-400 text-sm mr-1"></i>
                  <span class="w-24 text-right font-medium">姓　　名：</span>
                  <span id="resultName" class="ml-2 flex-1 text-left">-</span>
                </span>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <span class="inline-flex items-center w-full">
                  <i class="fas fa-envelope text-gray-500 dark:text-gray-400 text-sm mr-1"></i>
                  <span class="w-24 text-right font-medium">邮　　箱：</span>
                  <span id="resultEmail" class="ml-2 flex-1 text-left">-</span>
                </span>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <span class="inline-flex items-center w-full">
                  <i class="fas fa-phone-alt text-gray-500 dark:text-gray-400 text-sm mr-1"></i>
                  <span class="w-24 text-right font-medium">电　　话：</span>
                  <span id="resultPhone" class="ml-2 flex-1 text-left">-</span>
                </span>
              </td>
            </tr>
          </table>
        </td>

        <!-- 右列 -->
        <td class="w-1/2 align-top">
          <table class="w-full">
            <tr>
              <td colspan="3">
                <span class="inline-flex items-center w-full">
                  <i class="fas fa-clock text-red-500 dark:text-gray-400 text-sm mr-1"></i>
                  <span class="w-24 text-right font-medium">提交时间：</span>
                  <span id="resultTime" class="ml-2 flex-1 text-left">-</span>
                </span>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <span class="inline-flex items-center w-full">
                  <i class="fas fa-percentage text-blue-500 text-sm mr-1"></i>
                  <span class="w-24 text-right font-medium">总&ensp;得&ensp;分：</span>
                  <span id="resultScore" class="ml-2 text-green-600 dark:text-green-400 font-bold text-base text-left">-</span>
                </span>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <span class="inline-flex items-center w-full">
                  <i class="fas fa-bullseye text-green-500 text-sm mr-1"></i>
                  <span class="w-24 text-right font-medium">评定等级：</span>
                  <span id="resultLevel" class="ml-2 text-base font-semibold text-left">-</span>
                </span>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- 详细答题列表 -->
<div class="overflow-x-auto">
  <table class="min-w-[680px] table-auto border border-gray-300 dark:border-gray-600 text-xs sm:text-sm">
    <thead class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
      <tr>
        <th class="p-2 border w-20">题型</th>
        <th class="p-2 border w-16">题号</th>
        <th class="p-2 border w-1/4">你的答案</th>
        <th class="p-2 border w-1/4">正确答案</th>
        <th class="p-2 border w-20">得分</th>
      </tr>
    </thead>
    <tbody id="resultTableBody" class="text-gray-700 dark:text-gray-300">
      <!-- JavaScript 渲染内容 -->
    </tbody>
  </table>
</div>

    <!-- 操作按钮 -->
    <div class="mt-6 text-center">
      <!-- ✅ 返回答题页按钮 -->
      <button onclick="onReturnToTestPage()"
      class="mr-4 px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full shadow-md transition-all">
      <i class="fas fa-arrow-left mr-2"></i>返回答题页
      </button>

      <button onclick="onStartEvaluationClick()"
        class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-full shadow-md transition-all">
        <i class="fas fa-paper-plane mr-2"></i>开始打分
      </button>
    </div>
  </div>

</section>



 <!--  By Martin 此处是核心函数及功能的代码 开始 -->
 <script>
 // ✅ SE-F 产品培训考试系统脚本（整合版）
 // 包含倒计时、答题收集、评估评分、导出 PDF、发送邮件、动态口令等模块
 
 let remainingTime = 60 * 60; // 考试总时长：60分钟
 let timerInterval = null;
 let isPaused = false;
 let evaluationStarted = false; // ✅ 控制是否已开始评测

 let emailjsReady = false;  // ✅ 状态变量：标记是否已加载成功

 let emailSent = false; // ✅ 全局变量：标记邮件是否已发送成功

 const EMAIL_ENABLED = true; // ✅ 控制是否启用邮件发送功能（调试时设为 false）
  
 // ✅ 动态加载 SDK（更灵活稳定）
function loadEmailJS() {
  return new Promise((resolve, reject) => {
    if (window.emailjs) {
      emailjsReady = true;
      resolve(); // 已加载，无需重复
      return;
    }

    const script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
    script.async = true;

    script.onload = () => {
      try {
        emailjs.init("LoQCI3C98dk3FgEvj"); // ✅ 替换为你的 Public Key
        emailjsReady = true;
        resolve();
      } catch (e) {
        console.error("[EmailJS] 初始化失败", e);
        reject(e);
      }
    };

    script.onerror = () => {
      console.error("[EmailJS] 加载失败，可能是网络问题");
      reject(new Error("SDK 加载失败"));
    };

    document.head.appendChild(script);
  });
}


 
 // ⏳ 倒计时更新函数
 function updateCountdown() {
   const min = String(Math.floor(remainingTime / 60)).padStart(2, '0');
   const sec = String(remainingTime % 60).padStart(2, '0');
   document.getElementById('countdown').innerText = `${min}:${sec}`;
 }
 
 // ⏱️ 启动倒计时
 function startTimer() {
   if (timerInterval) clearInterval(timerInterval);
   timerInterval = setInterval(() => {
     if (!isPaused) {
       remainingTime--;
       updateCountdown();
       if (remainingTime <= 0) {
         clearInterval(timerInterval);
         isPaused = true;
         document.getElementById('testPage').classList.add('blur-overlay');
         alert('时间已到，考试结束！');
       }
     }
   }, 1000);
 }
 
 // ⏸️ 暂停 / 恢复
 function togglePause() {
   isPaused = !isPaused;
   const testPage = document.getElementById('testPage');
   const pauseBtn = document.getElementById('pauseBtn');
   if (isPaused) {
     testPage.classList.add('blur-overlay');
     pauseBtn.innerHTML = '<i class="fas fa-play mr-1"></i><span>继续</span>';
   } else {
     testPage.classList.remove('blur-overlay');
     pauseBtn.innerHTML = '<i class="fas fa-pause mr-1"></i><span>暂停</span>';
   }
 }

 let hasEnteredBefore = false; // ✅ 是否首次进入标记
function showTestPage() { // ✅ 切换到考试页面，并启动计时器/清除毛玻璃遮罩/显示“暂停”按钮/启动倒计时（仅首次进入）
  // 切换至考试页面
  showPage('testPage');

  // 启动倒计时（仅在首次进入时）
  if (!timerInterval) {
    startTimer(); // ⏱️ 启动 60 分钟倒计时
  }

  // 清除暂停状态
  if (remainingTime > 0) {
    isPaused = false;
    document.getElementById('testPage').classList.remove('blur-overlay');
    document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause mr-1"></i>暂停';

    if (hasEnteredBefore) {
      // ✅ 非首次进入，显示遮罩提示
      document.getElementById('countdownCenterOverlay').style.display = 'flex';
    }

    hasEnteredBefore = true; // ✅ 设置为已进入
  }
}

 // 📄 页面切换控制
 function showPage(pageId) {
   document.querySelectorAll('.page').forEach(page => {
     page.classList.remove('active-page');
   });
   document.getElementById(pageId).classList.add('active-page');
   window.scrollTo(0, 0);
   if (pageId === 'homePage' || pageId === 'completePage') {
     isPaused = true;
     document.getElementById('testPage').classList.add('blur-overlay');
   }
 }
 
 // document.addEventListener('DOMContentLoaded', updateCountdown);
 
 
 

 // ✅ 导出完成页为 PDF 文件
async function exportResultToPDF(userName = '匿名用户') {
  const completePage = document.getElementById("completePage");

  // ✅ 使用 html2canvas 渲染当前完成页为图片，并插入 PDF 中
  const canvas = await html2canvas(completePage, { scale: 2, useCORS: true });
  const imgData = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(imgData);
  const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;

  pdf.addImage(imgData, "PNG", 0, 0, pageWidth, pdfHeight);
  pdf.save(`SE-F评测结果_${userName}.pdf`);
}


// ✅ 将答题结果生成 HTML 表格用于插入邮件
function buildEmailHTMLTable(answers) {
  const getRow = (type, index, your, correct, score) => `
    <tr>
      <td>${type}</td>
      <td>${index}</td>
      <td>${your}</td>
      <td>${correct}</td>
      <td>${score}</td>
    </tr>`;

  const rows = [];

  const correctAnswers = {
    single: ["B", "C", "A", "B", "D", "C", "C", "B", "B", "B", "D", "C", "C", "B", "C", "B", "C", "B", "B", "B", "C", "D", "D", "B", "B"],
    multiple: [
      ["A", "B", "D"], ["C", "D"], ["A", "B", "C"], ["A", "B", "D"], ["A", "B", "C", "D"],
      ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"], ["A", "B", "C", "D"], ["A", "B", "C", "D"],
      ["A", "B", "D"], ["A", "B", "D"], ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"],
      ["A", "B", "C"], ["A", "B", "C", "D"], ["A", "B", "C"], ["A", "B", "C"], ["A", "B", "C", "D"]
    ],
    judge: ["true", "false", "false", "true", "true", "false", "true", "true", "false", "true", "false", "true", "false", "true", "false", "true", "true", "false", "true", "false"]
  };

  // 单选题
  for (let i = 1; i <= 25; i++) {
    const key = `q${i}`;
    const your = answers.singleChoice[key] || "-";
    const correct = correctAnswers.single[i - 1];
    const score = (your === correct) ? 2 : 0;
    rows.push(getRow("单选题", i, your, correct, score));
  }

  // 多选题
  for (let i = 1; i <= 20; i++) {
    const key = i.toString();
    const your = (answers.multipleChoice[key] || []).join(", ");
    const correct = correctAnswers.multiple[i - 1].join(", ");
    const score = (your.split(', ').sort().join(',') === correct.split(', ').sort().join(',')) ? 1 : 0;
    rows.push(getRow("多选题", i, your, correct, score));
  }

  // 判断题
  for (let i = 1; i <= 20; i++) {
    const key = `jq${i}`;
    const your = answers.judgment[key] === "true" ? "✔ 正确" : answers.judgment[key] === "false" ? "✘ 错误" : "-";
    const correct = correctAnswers.judge[i - 1] === "true" ? "✔ 正确" : "✘ 错误";
    const score = answers.judgment[key] === correctAnswers.judge[i - 1] ? 1 : 0;
    rows.push(getRow("判断题", i, your, correct, score));
  }

  // 简答题打分
  const keywords = ["传感器", "温度", "差压", "数量", "安装位置", "通信"];
  const match = keywords.filter(k => answers.essay.includes(k)).length;
  let essayScore = 0;
  if (match >= 5) essayScore = 35;
  else if (match >= 3) essayScore = 25;
  else if (match >= 1) essayScore = 10;
  rows.push(getRow("简答题", 1, answers.essay.slice(0, 20) + "...", "(关键词匹配)", essayScore));

  // 返回完整 HTML 表格
  return `
    <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
      <thead style="background-color: #f3f4f6; color: #111">
        <tr><th>题型</th><th>题号</th><th>你的答案</th><th>正确答案</th><th>得分</th></tr>
      </thead>
      <tbody>${rows.join('')}</tbody>
    </table>`;
}


// ✅ EmailJS 邮件发送
function sendResultEmail(answers) {
  if (!EMAIL_ENABLED) {
    console.log("[调试] 邮件功能已禁用，未执行发送。");
    return;
  }

  if (emailSent) {
    console.log("[调试] 邮件已发送，无需重复发送。");
    return;
  }

  const templateParams = {
    company: answers.userInfo.company,
    user_name: answers.userInfo.name,
    phone: answers.userInfo.phone,
    user_email: answers.userInfo.email,
    timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
    message: '来自 SE-F 培训系统的评测结果',
    table_html: buildEmailHTMLTable(answers)
  };

  if (!window.emailjs) {
    const script = document.createElement("script");
    script.src = "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
    script.onload = () => {
      emailjs.init("LoQCI3C98dk3FgEvj");
      emailjs.send("service_csl8frv", "template_0v2mqw9", templateParams)
        .then(() => {
          console.log("✅ 邮件发送成功");
          alert('✅ 邮件已成功发送到 RSEC 邮箱！');
          emailSent = true; // ✅ 设置状态，表示已成功发送
        })
        .catch(err => {
          console.error('[EmailJS] 邮件失败', err);
          //alert('⚠️ 邮件发送失败，请将导出的 PDF 手动发送到 RSEC 邮箱：rsec@armstrong.com');
          showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
        });
    };
    document.head.appendChild(script);
  } else {
    emailjs.init("LoQCI3C98dk3FgEvj");
    emailjs.send("service_csl8frv", "template_0v2mqw9", templateParams)
      .then(() => {
        console.log("✅ 邮件发送成功");
        alert('✅ 邮件已成功发送到 RSEC 邮箱！');
        emailSent = true; // ✅ 设置状态，表示已成功发送
      })
      .catch(err => {
        console.error('[EmailJS] 邮件失败', err);
        //alert('⚠️ 邮件发送失败，请将导出的 PDF 手动发送到 RSEC 邮箱：rsec@armstrong.com');
        showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
      });
  }
}




/**
 * ✅ handleExport：考试提交主流程
 * 包含评测、PDF 导出、邮件发送功能（调用 renderAssessmentResult）
 */
 async function handleExport() {
    // 1. 校验必填项
    if (!validateForm()) {
        alert("请完善必填信息和答题内容后再提交！");
        return;
    }

    // 2. 显示 loading 动画（需确保页面中存在 id="loading" 的元素）
    const loading = document.getElementById("loading");
    loading?.classList.remove("hidden");

    try {
        // 3. 模拟延迟，确保 UI 渲染稳定
        await new Promise(resolve => setTimeout(resolve, 300));

        // 4. 收集用户答题
        const answers = collectAnswers();

        // 5. 切换到完成页，开始评测（渲染结果页 + 表格）
        showPage("completePage");
        renderAssessmentResult(answers);
        evaluationStarted = true;

        // 6. 等待 1s，确保完成页加载完毕后再导出 PDF
        setTimeout(() => {
            const completePage = document.getElementById("completePage");
            const userName = answers.userInfo.name || "匿名";
            html2pdf().from(completePage).set({
              margin: [10, 10, 10, 10],
              filename: `SE-F评测结果_${userName}.pdf`,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2, useCORS: true },
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
              pagebreak: { mode: ['css', 'legacy'] }  // ✅ 自动分页
            }).save().then(() => {
                console.log("[PDF] 导出成功");
            }).catch(err => {
                console.error("[PDF] 导出失败", err);
            });
        }, 1000);

        // 7. 构建邮件参数（含答题结果表格）
        const tableHTML = generateEmailTableHTML(answers);
        const templateParams = {
            company: answers.userInfo.company,
            user_name: answers.userInfo.name,
            phone: answers.userInfo.phone,
            user_email: answers.userInfo.email,
            timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
            message: '系统自动提交：SE-F产品培训答卷',
            table_html: tableHTML
        };

        // 8. 加载 emailjs 模块（仅加载一次）
        if (!window.emailjs) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js';
            script.onload = () => {
                emailjs.init('LoQCI3C98dk3FgEvj');
                emailjs.send('service_csl8frv', 'template_0v2mqw9', templateParams)
                    .then(() => console.log("[EmailJS] 邮件发送成功"))
                    .catch(err => {
                        console.error('[EmailJS] 邮件失败', err);
                        alert('⚠️ 邮件发送失败，请将导出的 PDF 手动发送到 RSEC 邮箱：rsec@armstrong.com');
                        showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
                      });
            };
            document.head.appendChild(script);
        } else {
            emailjs.init('LoQCI3C98dk3FgEvj');
            emailjs.send('service_csl8frv', 'template_0v2mqw9', templateParams)
                .then(() => console.log("[EmailJS] 邮件发送成功"))
                .catch(err => {
                        console.error('[EmailJS] 邮件失败', err);
                        //alert('⚠️ 邮件发送失败，请将导出的 PDF 手动发送到 RSEC 邮箱：rsec@armstrong.com');
                        showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
                      });
        }

    } catch (error) {
        console.error("提交失败：", error);
        alert("提交失败，请稍后重试。\n错误信息：" + error.message);
    } finally {
        // 9. 隐藏 loading 动画
        loading?.classList.add("hidden");
    }
}

/**
 * ✅ 表单校验函数：确保所有基本信息与题目都已填写
 * @returns {boolean} 是否通过校验
 */
 // ✅ 临时屏蔽校验逻辑（调试用）
function validateForm() {
  console.warn("[调试模式] 表单验证已跳过");
  return true;
}
// 🔐 弹出动态口令窗口
function promptPasswordAndSend(answers) {
  document.getElementById("passwordModal").classList.remove("hidden");

  // 回调函数：根据用户点击决定是否发送
  window.confirmPassword = async function(sendEmail) {
    const password = document.getElementById("passwordInput").value.trim();
    showUniversalModal("动态验证码", "请输入验证码以发送成绩", true, (val) => {
      if (val === "AFT2025") {
        const html = buildEmailTable();
        sendResultEmail(html);
      } else {
        alert("验证码错误");
      }
});

    // 判断口令有效性（默认正确口令：AFT2025）
    const isValid = password === "AFT2025";
    
    // 无论正确与否，导出 PDF
    await exportResultPDF(answers);

    if (sendEmail && isValid) {
      await sendResultEmail(answers);
    } else if (sendEmail && !isValid) {
      alert("❌ 动态口令错误，未发送邮件，仅导出 PDF。");
    } else {
      alert("✅ 已跳过邮件，仅保存本地 PDF。");
    }
  };
}

// 📄 导出完成页为 PDF
async function exportResultPDF(answers) {
  const page = document.getElementById("completePage");
  const user = answers.userInfo.name || "未命名";
  await html2pdf().from(page).set({
    margin: 0,
    filename: `SE-F评测结果_${user}.pdf`,
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
  }).save();
}

// 📩 构建邮件发送逻辑
async function sendResultEmail(answers) {
  const tableHTML = generateEmailTableHTML(answers);
  const templateParams = {
    company: answers.userInfo.company,
    user_name: answers.userInfo.name,
    phone: answers.userInfo.phone,
    user_email: answers.userInfo.email,
    timestamp: new Date().toLocaleString("zh-CN", { hour12: false }),
    message: "SE-F产品培训自动提交答卷",
    table_html: tableHTML
  };

  try {
    if (!window.emailjs) {
      await new Promise(resolve => {
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
        s.onload = resolve;
        document.head.appendChild(s);
      });
    }
    emailjs.init("LoQCI3C98dk3FgEvj");
    await emailjs.send("service_csl8frv", "template_0v2mqw9", templateParams);
    alert("✅ 邮件已成功发送！");
  } catch (err) {
    console.error("[EmailJS] 邮件发送失败：", err);
    //alert("❌ 邮件发送失败，请稍后重试！");
    showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
  }
}

/**
 * ✅ 封装统一的邮件发送函数，自动加载模块并处理回调
 */
function sendEmailWithTemplate(templateParams, onSuccess = null, onFailure = null) {
  const serviceID = 'service_csl8frv';
  const templateID = 'template_0v2mqw9';
  const publicKey = 'LoQCI3C98dk3FgEvj';

  if (typeof emailjs === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js';
    script.onload = () => {
      emailjs.init(publicKey);
      emailjs.send(serviceID, templateID, templateParams)
        .then(() => {
          console.log('[EmailJS] 邮件发送成功');
          alert("✅ 评测结果已成功发送至 RSEC 邮箱！");
          if (typeof onSuccess === 'function') onSuccess();
        })
        .catch(err => {
          console.error('[EmailJS] 邮件发送失败:', err);
          showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
          if (typeof onFailure === 'function') onFailure(err);
        });
    };
    script.onerror = () => {
      console.error('[EmailJS] 模块加载失败');
      if (typeof onFailure === 'function') onFailure(new Error('模块加载失败'));
    };
    document.head.appendChild(script);
  } else {
    emailjs.init(publicKey);
    emailjs.send(serviceID, templateID, templateParams)
      .then(() => {
        console.log('[EmailJS] 邮件发送成功');
        alert("✅ 评测结果已成功发送至 RSEC 邮箱！");
        if (typeof onSuccess === 'function') onSuccess();
      })
      .catch(err => {
        console.error('[EmailJS] 邮件发送失败:', err);
        showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
        if (typeof onFailure === 'function') onFailure(err);
      });
  }
}

/**
 * ✅ 从完成页表格中提取 HTML（用于发送邮件）
 * 📌 表格已由 renderAssessmentResult() 渲染，无需重新生成
 */
 function generateEmailTableHTML() {
  const completePage = document.getElementById("completePage");
  if (!completePage) {
    console.error("❌ 未找到完成页内容 completePage！");
    return "<p>⚠️ 未找到评测结果内容。</p>";
  }

  // ✅ 提取完整内容
  const cloned = completePage.cloneNode(true);
  const scripts = cloned.querySelectorAll("script");
  scripts.forEach(s => s.remove()); // 移除嵌入脚本

  return `
    <style>
      table { border-collapse: collapse; width: 100%; margin-bottom: 20px; font-family: sans-serif; font-size: 14px; }
      th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
      thead { background-color: #f3f4f6; color: #111827; }
      .title { background-color: #ef4444; color: white; font-weight: bold; }
    </style>
    ${cloned.innerHTML}
  `;
}


/**
 * ✅ 补充按钮功能：点击“发送评估结果到邮箱”时触发
 * - 自动导出完成页 PDF
 * - 构建邮件表格内容并通过 EmailJS 发送
 */
async function handleScreenshotAndEmail() {
  try {
    const answers = collectAnswers(); // ✅ 获取当前答题内容（你已实现该函数）
    const userName = answers.userInfo.name || '匿名用户';

    // ✅ 使用 html2pdf 导出完成页
    const completePage = document.getElementById("completePage");
    await html2pdf().from(completePage).set({
      margin: 0,
      filename: `SE-F评测结果_${userName}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).save();

    // ✅ 构建邮件内容
    const tableHTML = generateEmailTableHTML(answers);
    const templateParams = {
      company: answers.userInfo.company,
      user_name: userName,
      phone: answers.userInfo.phone,
      user_email: answers.userInfo.email,
      timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
      message: '系统自动提交：SE-F产品培训答卷（手动触发）',
      table_html: tableHTML
    };

    // ✅ 发送邮件（EmailJS 方式）
    emailjs.send('service_csl8frv', 'template_0v2mqw9', templateParams)
      .then(() => alert("✅ 邮件已成功发送！"))
      .catch(err => {
        console.error("[EmailJS] 邮件发送失败：", err);
        //alert("❌ 邮件发送失败，请检查网络或稍后再试！");
        showEmailResultPopup("❌ 邮件发送失败，是否重新发送？");
      });

  } catch (err) {
    console.error("[发送错误]：", err);
    alert("❌ 出现错误，无法完成操作，请稍后重试！");
  }
}

/**
 * ✅ 用户点击“开始评测”时，弹出确认框
 */
 function confirmStartEvaluation() {
  if (confirm("您确定开始进行评测吗？\n提交后将自动推送给 Armstrong RSEC 部门，并导出 PDF。")) {
    // ✅ 继续下一步：动态口令验证 + 邮件推送
    const stored = sessionStorage.getItem("userAnswers");
    if (!stored) {
      alert("⚠️ 无法获取答题数据，请重新提交！");
      return;
    }
    const answers = JSON.parse(stored);
    sessionStorage.setItem("hasEvaluated", "true"); // ✅ 设置标志：已评测
    // 👉 执行动态口令验证逻辑（下一步将补充）
    promptPasswordAndSend(answers);
  } else {
    // ❌ 用户取消，什么都不做
    alert("已取消评测，您可继续检查答题内容。");
  }
}

/**
 * ✅ 返回答题页逻辑（仅在未开始评测前可用）
 */
 function returnToTestPage() {
  // 如果已经开始评测，就不允许返回
  if (sessionStorage.getItem('hasEvaluated') === 'true') {
    alert('⚠️ 您已完成评测，带有完成时间的结果已经发送出去，无法返回修改答卷！');
    return;
  }

  // 跳转回 testPage
  showPage('testPage');

  // 清除所有题目答案，只保留学员信息
  document.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked').forEach(el => el.checked = false);
  document.getElementById('essay').value = '';

  // ✅ 可选：重置滚动到顶部
  window.scrollTo(0, 0);
}

// ✅ 用户点击“开始评测”按钮后的确认提示
function startEvaluationPrompt() {
  // 使用原生 confirm 简洁实现，也可以改为 modal 风格
  const confirmed = confirm("您确定要开始进行评测吗？\n评测后将自动导出 PDF，并发送结果至 Armstrong RSEC。");
  if (confirmed) {
    // 用户点击“是”后，进入动态口令验证流程
    promptPasswordAndSend(); // 下一步定义
  } else {
    // 否则不做任何操作，停留在完成页
    alert("已取消评测操作。您仍可检查答题内容。");
  }
}





function exportPDF(answers) {
  // ✅ 加强容错，确保 answers 和 userInfo 存在
  const safeUserInfo = answers?.userInfo || {};
  const userName = safeUserInfo.name || '匿名用户';
  const userEmail = safeUserInfo.email || '未知邮箱';
  const userCompany = safeUserInfo.company || '未填写单位';
  const userPhone = safeUserInfo.phone || '未提供手机号';
  const completePage = document.getElementById("completePage");
  html2pdf().from(completePage).set({
  margin: [10, 10, 10, 10],
  filename: `SE-F评测结果_${userName}.pdf`,
  image: { type: 'jpeg', quality: 0.98 },
  html2canvas: {
    scale: 2,          // 保证清晰
    useCORS: true,
    scrollX: 0,
    scrollY: 0,
    windowWidth: completePage.scrollWidth, // ✨ 加这个
    windowHeight: completePage.scrollHeight // ✨ 加这个
  },
  jsPDF: {
    unit: 'mm',
    format: 'a4',
    orientation: 'portrait'
  }
}).save();
}





// 🧩 显示邮件重试弹窗
function showRetryModal() {
  document.getElementById("emailRetryModal").classList.remove("hidden");
}

// 🧩 关闭弹窗
function closeRetryModal() {
  document.getElementById("emailRetryModal").classList.add("hidden");
}

// 🧩 点击重试按钮时，重新初始化并推送邮件
console.log("绑定 retryEmailBtn...");
const btn = document.getElementById("retryEmailBtn");
console.log("retryEmailBtn =", btn);

if (btn) {
  btn.addEventListener("click", () => {
    closeRetryModal();

    if (window.emailjs) {
      try {
        emailjs.init("LoQCI3C98dk3FgEvj");
      } catch (e) {
        console.error("EmailJS 初始化失败", e);
      }
    }

    handleEmailSendAgain();
  });
} else {
  console.warn("⚠️ 没有找到 #retryEmailBtn，跳过绑定");
}


// ✅ 重新初始化 EmailJS（避免推送失败后卡死）
function reinitializeEmailJS() {
  if (window.emailjs) {
    try {
      emailjs.init("LoQCI3C98dk3FgEvj");  // 你的 Public Key
      console.log("✅ EmailJS 已重新初始化");
    } catch (err) {
      console.error("❌ EmailJS 初始化失败", err);
    }
  } else {
    console.error("⚠️ EmailJS 模块未加载");
  }
}

// ✅ 重试按钮绑定的函数
function retryEmailSend() {
  hideEmailResultPopup();  // 先关闭弹窗
  reinitializeEmailJS();   // 重新初始化
  setTimeout(() => {
    handleExportWithPDFAndEmail(); // 再次执行导出和推送
  }, 200);  // 稍等200ms，避免初始化未完成
}


// ✅ 用于显示邮件发送结果弹窗，并支持重试逻辑
function showEmailResultPopup(message) {
  // 构建弹窗 HTML
  const modalHTML = `
    <div id="emailResultPopup" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-[300px] text-center fade-in-bounce">
        <p class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">${message}</p>
        <div class="flex justify-center gap-4">
          <button id="retrySendBtn" class="bg-blue-600 text-white px-4 py-1.5 rounded hover:bg-blue-700">是</button>
          <button id="cancelSendBtn" class="bg-gray-300 text-gray-800 px-4 py-1.5 rounded hover:bg-gray-400">否</button>
        </div>
      </div>
    </div>
  `;

  // 插入弹窗
  document.body.insertAdjacentHTML('beforeend', modalHTML);

  // ✅ 绑定按钮事件
  document.getElementById('retrySendBtn').onclick = () => {
    document.getElementById('emailResultPopup').remove();

    // ✅ 重初始化 EmailJS（确保状态清空）
    emailjs.init("LoQCI3C98dk3FgEvj");

    // ✅ 重新发送（调用你已有的主发送函数）
    try {
      handleExportWithPDFAndEmail(true); // 加一个参数标识重试
    } catch (err) {
      alert("邮件再次发送失败，请稍后再试。");
    }
  };

  document.getElementById('cancelSendBtn').onclick = () => {
    document.getElementById('emailResultPopup').remove();
  };
}




 </script>
 <!--  By Martin 此处是核心函数及功能的代码 结尾 -->

<script>
// ✅ 随机打乱分布 30° 统一倾斜水印
document.addEventListener("DOMContentLoaded", () => {
  const COUNT = 30; // 水印个数
  for (let i = 0; i < COUNT; i++) {
    const wm = document.createElement("div");
    wm.className = "watermark-random";
    wm.style.top = `${Math.random() * 120 - 10}vh`;
    wm.style.left = `${Math.random() * 120 - 10}vw`;
    wm.style.transform = `rotate(30deg) scale(${0.7 + Math.random() * 0.6})`;
    document.body.appendChild(wm);
  }
});
</script>

<!-- 🔐 动态口令弹窗 -->
<div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md w-full max-w-sm text-center">
    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">请输入动态口令以发送评测结果至邮箱</h3>
    <input id="passwordInput" type="password" placeholder="请输入口令..." 
           class="w-full p-2 border rounded-md mb-4 focus:outline-none focus:ring focus:border-blue-300" />
    <div class="flex justify-between space-x-4">
      <button onclick="confirmPassword(true)" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded">确定</button>
      <button onclick="confirmPassword(false)" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white py-2 rounded">跳过发送</button>
    </div>
  </div>
</div>

<!-- ✅ 倒计时暂停提示遮罩 -->
<div id="countdownCenterOverlay" class="hidden fixed inset-0 flex">
  <div class="text-center">
    <p>当前考试已暂停</p>
    <p>点击下方按钮可恢复考试</p>
    <button onclick="resumeFromCenterOverlay()">继续答题</button>
  </div>
</div>

<script>
  // ✅ 页面加载后自动触发倒计时函数
  document.addEventListener("DOMContentLoaded", function () {
    startTimer(); // 自动启动倒计时
  });
</script>

<!-- 邮件重试弹窗 -->
<div id="emailRetryModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-80 text-center shadow-lg">
    <p class="text-lg font-semibold text-gray-900 dark:text-white mb-4">邮件发送失败，是否重试？</p>
    <div class="flex justify-center gap-4">
      <!-- 邮件失败弹窗按钮 -->
    <button id="retryEmailBtn" onclick="retryEmailSend()" class="bg-green-500 hover:bg-green-600 ...">
      是，重新发送
    </button>
    <button id="retryEmailBtn" onclick="hideEmailResultPopup()" class="bg-gray-400 hover:bg-gray-500 ...">
      否，暂不发送
    </button>
    </div>
  </div>
</div>



<script>
  // ✅ 验证学员信息完整性与格式
  function validateUserInfo() {
    const company = document.getElementById("company")?.value.trim();
    const name = document.getElementById("name")?.value.trim();
    const phone = document.getElementById("phone")?.value.trim();
    const email = document.getElementById("email")?.value.trim();

    if (!company || !name || !phone || !email) {
      alert("请先完整填写学员信息（公司、姓名、手机号、邮箱）后再提交答卷！");
      return false;
    }

    const phonePattern = /^\d{11}$/;
    const emailPattern = /^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/;

    if (!phonePattern.test(phone)) {
      alert("手机号格式不正确，应为 11 位数字");
      return false;
    }

    if (!emailPattern.test(email)) {
      alert("邮箱格式不正确，请检查！");
      return false;
    }

    return true;
  }

  // ✅ 页面加载后绑定事件
  window.addEventListener("DOMContentLoaded", () => {
    const submitBtn = document.getElementById("submitBtn");
    if (submitBtn) {
      submitBtn.addEventListener("click", () => {
        if (validateUserInfo()) {
          confirmSubmitTest(); // ✅ 正式提交逻辑（你已有的函数）
        }
      });
    }
  });
</script>

<!-- ✅ 页面心跳机制脚本（新增） -->
    <!-- ✅ 页面底部， PapaParse CSV 加载 + 动态题目填充脚本（匹配中文字段） -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  // 防止变量重复声明
  if (typeof currentLang === 'undefined') {
    var currentLang = 'zh';  // 默认语言
  }

// 加载 CSV 并填充所有题型
function loadQuestionsFromCSV(csvPath) {
  Papa.parse(csvPath, {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data;

      // ========== 1. 单选题 =========
      
      

      // ========== 2. 多选题 =========
      
      

      // ========== 3. 判断题 =========
      

      // ========== 4. 简答题 =========
      const short = data.filter(q => q['题型'] === '简答题');
      if (short.length > 0) {
        const q = short[0];
        const container = document.querySelector(`#short1`);
        if (container) {
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          container.querySelector('h3').textContent = title;
        }
      }
    }
  });
}

// 页面加载后自动执行
window.addEventListener("DOMContentLoaded", () => {
  loadQuestionsFromCSV("/static/csv/SE-F.csv");
});

// 语言切换函数（通过按钮调用）
function switchLanguage(lang) {
  currentLang = lang;
  loadQuestionsFromCSV("/static/csv/SE-F.csv");
}
</script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  if (typeof currentLang === 'undefined') var currentLang = 'zh';
  document.addEventListener("DOMContentLoaded", function () {
    // ✅ 使用日期 + 毫秒时间戳，避免缓存
    const timestamp = new Date().toISOString().replace(/[-:TZ.]/g, "") + "_" + Date.now();
    const csvPath = `/static/csv/SE-F.csv?t=${timestamp}`;

    Papa.parse(csvPath, {
      download: true,
      header: true,
      complete: function (results) {
        const data = results.data;
        // ✅ 单选题渲染
        data.filter(q => q['题型'] === '单选题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#q${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D'].forEach(opt => {
            const label = container.querySelector(`label[for="q${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="radio" id="q${index}-${opt}" name="q${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });
        // ✅ 多选题渲染
        data.filter(q => q['题型'] === '多选题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#multi${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D', 'E', 'F'].forEach(opt => {
            const label = container.querySelector(`label[for="m${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="checkbox" id="m${index}-${opt}" name="multi${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });
        // ✅ 判断题渲染
        data.filter(q => q['题型'] === '判断题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#jq${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
        });
        // ✅ 简答题渲染
        const short = data.find(q => q['题型'] === '简答题');
        const container = document.querySelector("#short1");
        if (short && container) {
          const title = currentLang === 'en' ? short['English Question'] : short['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = title;
        }
      },
      error: function (err) {
        console.error("❌ 题库加载失败：", err);
      }
    });
  });
</script>

    <script>
      let lastActivityTime = Date.now();
  
      // 记录人工操作事件时间
      const recordActivity = () => {
      lastActivityTime = Date.now();
      };
  
      // ✅ 绑定所有人工操作事件（点击、滚动、输入等）
      ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
      document.addEventListener(evt, recordActivity);
      });
  
      // ✅ 每分钟发送一次心跳，仅在最近1分钟内有操作时才发送
      setInterval(() => {
        if (Date.now() - lastActivityTime < 60000) {
          fetch("/heartbeat", {
            method: "POST"
          })
          .then(res => {
            if (res.status === 440) {
              alert("登录已超时，请重新登录！");
              window.location.href = "/login";
            }
          })
          .catch(() => {});
        }
      }, 60000);
  </script>




<!-- ✅ 登录弹窗 -->
<div id="loginOverlay" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-xs shadow-xl">
    <h2 class="text-lg font-bold text-center mb-4">会话已过期，请重新登录</h2>
    <input id="reLoginUser" class="w-full mb-3 px-4 py-2 rounded-md bg-gray-100 dark:bg-gray-700" placeholder="用户名">
    <input id="reLoginPass" type="password" class="w-full mb-3 px-4 py-2 rounded-md bg-gray-100 dark:bg-gray-700" placeholder="密码">
    <button onclick="submitRelogin()" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">重新登录</button>
  </div>
</div>

<!-- 页面末尾 -->
<script>
  function showLoginOverlay() {
    document.getElementById("loginOverlay").classList.remove("hidden");
  }
  
  async function submitRelogin() {
    const username = document.getElementById("reLoginUser").value.trim();
    const password = document.getElementById("reLoginPass").value.trim();
  
    const res = await fetch("/login", {
      method: "POST",
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ username, password })
    });
  
    if (res.redirected) {
      location.reload();  // ✅ 登录成功后刷新页面继续使用
    } else {
      alert("重新登录失败，请检查用户名或密码");
    }
  }

  document.getElementById("reLoginPass").addEventListener("keyup", function (e) {
      if (e.key === "Enter") {
          submitRelogin();
      }
  });
  </script>

  <!-- 关闭登录弹窗 -->
  <script>
      function closeLoginOverlay() {
          document.getElementById("loginOverlay").classList.add("hidden");
      }
  </script>



<!-- ✅ 统一 PapaParse 加载与题目渲染入口 -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  if (typeof currentLang === 'undefined') var currentLang = 'zh';

  document.addEventListener("DOMContentLoaded", function () {
    Papa.parse("/static/csv/SE-F.csv", {
      download: true,
      header: true,
      complete: function (results) {
        const data = results.data;

        // ✅ 单选题渲染
        data.filter(q => q['题型'] === '单选题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#q${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D'].forEach(opt => {
            const label = container.querySelector(`label[for="q${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="radio" id="q${index}-${opt}" name="q${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });

        // ✅ 多选题渲染
        data.filter(q => q['题型'] === '多选题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#multi${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
          ['A', 'B', 'C', 'D', 'E', 'F'].forEach(opt => {
            const label = container.querySelector(`label[for="m${index}-${opt}"]`);
            const text = currentLang === 'en' ? q[opt + '_EN'] : q[opt];
            if (label && text) {
              label.innerHTML = `<input type="checkbox" id="m${index}-${opt}" name="multi${index}" value="${opt}"> ${opt}. ${text}`;
            }
          });
        });

        // ✅ 判断题渲染
        data.filter(q => q['题型'] === '判断题').forEach((q, i) => {
          const index = i + 1;
          const container = document.querySelector(`#jq${index}`);
          if (!container) return;
          const title = currentLang === 'en' ? q['English Question'] : q['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = `${index}. ${title}`;
        });

        // ✅ 简答题渲染
        const short = data.find(q => q['题型'] === '简答题');
        const container = document.querySelector("#short1");
        if (short && container) {
          const title = currentLang === 'en' ? short['English Question'] : short['中文题干'];
          const h3 = container.querySelector("h3");
          if (h3) h3.textContent = title;
        }
      },
      error: function (err) {
        console.error("❌ 题库加载失败：", err);
      }
    });
  });
</script>

<!-- ✅ 加载 CSV 题库并渲染 -->
<script src="/static/common/render.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const courseName = window.location.pathname.split("/").pop().replace(".html", "");
    loadCSVAndInit(courseName); // 自动根据 HTML 文件名加载对应 CSV
  });
</script>

<!-- ✅ 通用模态弹窗模板 -->
<div id="universalModal" class="fixed z-50 inset-0 overflow-y-auto bg-gray-800 bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white dark:bg-gray-900 p-6 rounded-lg shadow-lg w-full max-w-md text-center">
    <h2 id="modalTitle" class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">提示标题</h2>
    <p id="modalMessage" class="text-gray-700 dark:text-gray-300 mb-6">提示内容文本，可根据实际内容动态设置</p>

    <!-- 可选输入框（例如动态口令） -->
    <input
      id="modalInput"
      class="bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded p-2 w-full mb-4 hidden"
      type="text"
      placeholder="请输入内容"
    />

    <div class="flex justify-end gap-4">
      <button id="modalConfirmBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
        确定
      </button>
      <button onclick="closeUniversalModal()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">
        取消
      </button>
    </div>
  </div>
</div>



<script>
  function positionCountdownBar() {
    const nav = document.getElementById("mainNavbar");
    const bar = document.getElementById("examStatusBar");

    if (nav && bar) {
      const navRect = nav.getBoundingClientRect();
      const scrollY = window.scrollY || window.pageYOffset;

      // 🧠 计算导航栏底部相对整个页面的实际位置
      const navBottom = navRect.bottom + scrollY;

      // ✅ 设置倒计时栏 top = 导航栏底 + 8px 间距
      bar.style.top = `${navBottom + 0}px`;
    }
  }

  // ✅ 页面加载完成后定位一次
  window.addEventListener("DOMContentLoaded", positionCountdownBar);
  // ✅ 浏览器尺寸变化时重新定位
  window.addEventListener("resize", positionCountdownBar);
</script>

</div>


<script>
  // ✅ 判断是否为本地开发环境
  const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";
  
  // ✅ 非本地环境则启用调试防护
  if (!isLocalhost) {
    // 禁用右键菜单
    document.addEventListener('contextmenu', event => event.preventDefault());
  
    // 禁用 F12、Ctrl+Shift+I / J / C、Ctrl+U 等组合键
    document.addEventListener('keydown', event => {
      if (
        event.key === 'F12' ||
        (event.ctrlKey && event.shiftKey && ['I', 'J', 'C'].includes(event.key.toUpperCase())) ||
        (event.ctrlKey && event.key.toUpperCase() === 'U')
      ) {
        event.preventDefault();
      }
    });
  }
  </script>

  <div id="loadingMessageBar" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white text-sm font-medium px-4 py-2 rounded shadow-md z-50">
    测试题加载中，请稍候...
  </div>

  <script>
    // ✅ 强制初始化为 Light 模式，忽略 localStorage 和系统设置
    window.addEventListener('DOMContentLoaded', () => {
      const html = document.documentElement;
      const themeToggle = document.getElementById('themeToggle');
  
      // ✅ 强制设置为 Light 模式
      html.classList.remove('dark');
      localStorage.setItem('theme', 'light');
      console.log('[Init] 强制设定为 Light 模式');
  
      // ✅ 切换按钮逻辑仍然保留
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          html.classList.toggle('dark');
          const newTheme = html.classList.contains('dark') ? 'dark' : 'light';
          localStorage.setItem('theme', newTheme);
          console.log(`[Click] 主题切换为 ${newTheme}`);
        });
      }
    });
  </script>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const fromCourse = sessionStorage.getItem("entryFromCourse");

    // ✅ 如果是首次进入答题页（从课程页点进来）
    if (!fromCourse) {
      console.log("✅ 首次进入答题页，清除旧答题记录");
      sessionStorage.removeItem("collectedAnswers");
      sessionStorage.setItem("entryFromCourse", "1");
    } else {
      console.log("↩️ 从完成页返回，不清除答题记录");
    }
  });
</script>


<!-- ✅ Martin </body>页面最尾部 -->

<!-- ✅ 心跳机制（每分钟向服务器发送请求） -->
<script>
  setInterval(() => {
        if (Date.now() - lastActivityTime < 60000) {
          fetch("/heartbeat", {
            method: "POST"
          })
          .then(res => {
            if (res.status === 440) {
              alert("登录已超时，请重新登录！");
              window.location.href = "/login";
            }
          })
          .catch(() => {});
        }
      }, 60000); // 60 * 1000 = 1分钟
</script>

<!-- ✅ 自动退出机制（用户无操作1小时自动退出） -->
<script>
  let inactivityTimer;

  function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
      alert("由于您已长时间未操作，系统已自动退出。");
      window.location.href = "/logout"; // 或执行 logout 函数
    }, 60 * 60 * 1000); // 1 小时 =  60 * 60 * 1000
  }

  ['click', 'mousemove', 'keypress', 'scroll'].forEach(evt =>
    document.addEventListener(evt, resetInactivityTimer)
  );

  resetInactivityTimer(); // 初始化
</script>
  
</body>
</html>
